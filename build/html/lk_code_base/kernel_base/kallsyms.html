<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>linux 内核符号:kallsyms + 导出符号 &mdash; Rachel&#39;s E-book 1.0 documentation</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Rachel's E-book
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../os_base/index.html">linux 操作系统概述</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lk_devel/index.html">linux 内核开发基础</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../x86_kernel_base.html">linux X86内核基础</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lk_code/index.html">linux 内核基础代码分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pm.html">电源管理框架</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cpu.html">cpu管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../driver.html">设备驱动</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ps.html">进程管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mem.html">内存管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fs.html">文件系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sec.html">linux 内核安全</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../yocto_kernel.html">yocto uboot与内核模块、内核开发总结</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../uboot.html">uboot理解</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dot.html">dot画图</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bpf_helper.html">BPF-HELPERS</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Rachel's E-book</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>linux 内核符号:kallsyms + 导出符号</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/lk_code_base/kernel_base/kallsyms.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="linux-kallsyms">
<h1>linux 内核符号:kallsyms + 导出符号<a class="headerlink" href="#linux-kallsyms" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id1">
<h2>内核符号的产生<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Makefile符号产生阶段</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">struct_task –&gt; mm</span><a class="headerlink" href="#id5" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span>      # Final link of vmlinux with optional arch pass after final link
     cmd_link-vmlinux =                                                 \
             $(CONFIG_SHELL) $&lt; &quot;$(LD)&quot; &quot;$(KBUILD_LDFLAGS)&quot; &quot;$(LDFLAGS_vmlinux)&quot;;    \
<span class="hll">             $(if $(ARCH_POSTLINK), $(MAKE) -f $(ARCH_POSTLINK) $@, true)
</span><span class="hll">
</span>     vmlinux: scripts/link-vmlinux.sh autoksyms_recursive $(vmlinux-deps) FORCE
             +$(call if_changed,link-vmlinux)
</pre></div>
</td></tr></table></div>
</div>
<ul class="simple">
<li><p>script/link-vmlinux.sh:内核符号产生过程：</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">struct_task –&gt; mm</span><a class="headerlink" href="#id6" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134</pre></div></td><td class="code"><div class="highlight"><pre><span></span>     # Link of vmlinux
     # ${1} - output file
     # ${2}, ${3}, ... - optional extra .o files
<span class="hll">     vmlinux_link()
</span><span class="hll">     {
</span>             local lds=&quot;${objtree}/${KBUILD_LDS}&quot;
             local output=${1}
             local objects
             local strip_debug

             info LD ${output}

             # skip output file argument
             shift

             # The kallsyms linking does not need debug symbols included.
             if [ &quot;$output&quot; != &quot;${output#.tmp_vmlinux.kallsyms}&quot; ] ; then
                     strip_debug=-Wl,--strip-debug
             fi

             if [ &quot;${SRCARCH}&quot; != &quot;um&quot; ]; then
                     objects=&quot;--whole-archive                        \
                             ${KBUILD_VMLINUX_OBJS}                  \
                             --no-whole-archive                      \
                             --start-group                           \
                             ${KBUILD_VMLINUX_LIBS}                  \
                             --end-group                             \
                             ${@}&quot;

                     ${LD} ${KBUILD_LDFLAGS} ${LDFLAGS_vmlinux}      \
                             ${strip_debug#-Wl,}                     \
                             -o ${output}                            \
                             -T ${lds} ${objects}
             else
                     objects=&quot;-Wl,--whole-archive                    \
                             ${KBUILD_VMLINUX_OBJS}                  \
                             -Wl,--no-whole-archive                  \
                             -Wl,--start-group                       \
                             ${KBUILD_VMLINUX_LIBS}                  \
                             -Wl,--end-group                         \
                             ${@}&quot;

                     ${CC} ${CFLAGS_vmlinux}                         \
                             ${strip_debug}                          \
                             -o ${output}                            \
                             -Wl,-T,${lds}                           \
                             ${objects}                              \
                             -lutil -lrt -lpthread
                     rm -f linux
             fi
     }

     # Create ${2} .S file with all symbols from the ${1} object file
     kallsyms()
     {
             local kallsymopt;

             if [ -n &quot;${CONFIG_KALLSYMS_ALL}&quot; ]; then
                     kallsymopt=&quot;${kallsymopt} --all-symbols&quot;
             fi

             if [ -n &quot;${CONFIG_KALLSYMS_ABSOLUTE_PERCPU}&quot; ]; then
                     kallsymopt=&quot;${kallsymopt} --absolute-percpu&quot;
             fi

             if [ -n &quot;${CONFIG_KALLSYMS_BASE_RELATIVE}&quot; ]; then
                     kallsymopt=&quot;${kallsymopt} --base-relative&quot;
             fi

             info KSYMS ${2}
             ${NM} -n ${1} | scripts/kallsyms ${kallsymopt} &gt; ${2}
     }

     # Perform one step in kallsyms generation, including temporary linking of
     # vmlinux.
     kallsyms_step()
     {
             kallsymso_prev=${kallsymso} #第一步时为&quot;&quot;
             kallsyms_vmlinux=.tmp_vmlinux.kallsyms${1} #.tmp_vmlinux.kallsyms1 .tmp_vmlinux.kallsyms2
             kallsymso=${kallsyms_vmlinux}.o     #.tmp_vmlinux.kallsyms1.o .tmp_vmlinux.kallsyms2.o
             kallsyms_S=${kallsyms_vmlinux}.S    #.tmp_vmlinux.kallsyms1.S .tmp_vmlinux.kallsyms2.S

             vmlinux_link ${kallsyms_vmlinux} &quot;${kallsymso_prev}&quot; ${btf_vmlinux_bin_o} #生成kallsyms_vmlinux
             kallsyms ${kallsyms_vmlinux} ${kallsyms_S} #产生汇编文件

             info AS ${kallsyms_S}
             ${CC} ${NOSTDINC_FLAGS} ${LINUXINCLUDE} ${KBUILD_CPPFLAGS} \
                   ${KBUILD_AFLAGS} ${KBUILD_AFLAGS_KERNEL} \
                   -c -o ${kallsymso} ${kallsyms_S} #生成的符号文件编译成kallsymso文件
     }



     kallsymso=&quot;&quot;
     kallsymso_prev=&quot;&quot;
     kallsyms_vmlinux=&quot;&quot;
     if [ -n &quot;${CONFIG_KALLSYMS}&quot; ]; then

             # kallsyms support
     # Generate section listing all symbols and add it into vmlinux:产生一个section
     # It&#39;s a three step process:
     # 1)  Link .tmp_vmlinux1 so it has all symbols and sections,
     #     but __kallsyms is empty.
     #     Running kallsyms on that gives us .tmp_kallsyms1.o with
     #     the right size
     # 2)  Link .tmp_vmlinux2 so it now has a __kallsyms section of
     #     the right size, but due to the added section, some
     #     addresses have shifted.
     #     From here, we generate a correct .tmp_kallsyms2.o
     # 3)  That link may have expanded the kernel image enough that
     #     more linker branch stubs / trampolines had to be added, which
     #     introduces new names, which further expands kallsyms. Do another
     #     pass if that is the case. In theory it&#39;s possible this results
     #     in even more stubs, but unlikely.
     #     KALLSYMS_EXTRA_PASS=1 may also used to debug or work around
     #     other bugs.
     # 4)  The correct ${kallsymso} is linked into the final vmlinux.
     #
     # a)  Verify that the System.map from vmlinux matches the map from
     #     ${kallsymso}.

             kallsyms_step 1
             kallsyms_step 2        #将符号结构也要产生符号？

             # step 3
             size1=$(${CONFIG_SHELL} &quot;${srctree}/scripts/file-size.sh&quot; ${kallsymso_prev})
             size2=$(${CONFIG_SHELL} &quot;${srctree}/scripts/file-size.sh&quot; ${kallsymso})

             if [ $size1 -ne $size2 ] || [ -n &quot;${KALLSYMS_EXTRA_PASS}&quot; ]; then
                     kallsyms_step 3   #这是产生三次吗？
             fi
     fi

     vmlinux_link vmlinux &quot;${kallsymso}&quot; ${btf_vmlinux_bin_o}  #到这儿产生真正的vmlinux
</pre></div>
</td></tr></table></div>
</div>
<ul class="simple">
<li><p>核心程序：scripts/kallsyms.c</p></li>
</ul>
</div>
<div class="section" id="id2">
<h2>以上是内核符号的产生过程，下面我们看内核模块中内核符号的产生：<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<div class="section" id="demo-k-m1-ko">
<h3>demo:k_m1.ko<a class="headerlink" href="#demo-k-m1-ko" title="Permalink to this headline">¶</a></h3>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">struct_task –&gt; mm</span><a class="headerlink" href="#id7" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#Makefile</span>
     <span class="n">obj</span><span class="o">-</span><span class="nl">m</span> <span class="p">:</span><span class="o">=</span> <span class="n">k_m1</span><span class="p">.</span><span class="n">o</span>
             <span class="nl">KDIR</span><span class="p">:</span><span class="o">=/</span><span class="n">lib</span><span class="o">/</span><span class="n">modules</span><span class="o">/</span><span class="n">$</span><span class="p">(</span><span class="n">shell</span> <span class="n">uname</span> <span class="o">-</span><span class="n">r</span><span class="p">)</span><span class="o">/</span><span class="n">build</span>
<span class="hll">             <span class="nl">PWD</span><span class="p">:</span><span class="o">=</span><span class="n">$</span><span class="p">(</span><span class="n">shell</span> <span class="n">pwd</span><span class="p">)</span>
</span><span class="hll">     <span class="k">default</span><span class="o">:</span>
</span>             <span class="n">$</span><span class="p">(</span><span class="n">MAKE</span><span class="p">)</span> <span class="o">-</span><span class="n">C</span> <span class="n">$</span><span class="p">(</span><span class="n">KDIR</span><span class="p">)</span> <span class="n">M</span><span class="o">=</span><span class="n">$</span><span class="p">(</span><span class="n">PWD</span><span class="p">)</span> <span class="n">modules</span>
     <span class="nl">clean</span><span class="p">:</span>
             <span class="n">$</span><span class="p">(</span><span class="n">RM</span><span class="p">)</span> <span class="o">*</span><span class="p">.</span><span class="n">mod</span><span class="p">.</span><span class="n">c</span> <span class="o">*</span><span class="p">.</span><span class="n">o</span> <span class="o">*</span><span class="p">.</span><span class="n">ko</span> <span class="o">*</span><span class="p">.</span><span class="n">cmd</span> <span class="o">*</span><span class="p">.</span><span class="n">symvers</span> <span class="o">*</span><span class="p">.</span><span class="n">order</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="k-m1-c">
<h3>k_m1.c<a class="headerlink" href="#k-m1-c" title="Permalink to this headline">¶</a></h3>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">struct_task –&gt; mm</span><a class="headerlink" href="#id8" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64</pre></div></td><td class="code"><div class="highlight"><pre><span></span>     <span class="cp">#include</span> <span class="cpf">&lt;linux/kernel.h&gt;</span><span class="cp"></span>
     <span class="cp">#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="cp"></span>
     <span class="cp">#include</span> <span class="cpf">&lt;linux/kprobes.h&gt;</span><span class="cp"></span>
<span class="hll">     <span class="cp">#include</span> <span class="cpf">&lt;linux/sched.h&gt;</span><span class="cp"></span>
</span><span class="hll">     <span class="cp">#define MAX_SYMBOL_LEN  64</span>
</span>     <span class="cp">#define exe_buf         &quot;ch_rootkit&quot;</span>
     <span class="k">static</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">TASK_COMM_LEN</span><span class="p">];</span>
     <span class="k">static</span> <span class="kt">char</span> <span class="n">symbol</span><span class="p">[</span><span class="n">MAX_SYMBOL_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;start_thread&quot;</span><span class="p">;</span>
     <span class="n">module_param_string</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">symbol</span><span class="p">),</span> <span class="mo">0644</span><span class="p">);</span>

     <span class="cm">/* For each probe you need to allocate a kprobe structure */</span>
     <span class="k">static</span> <span class="k">struct</span> <span class="nc">kprobe</span> <span class="n">kp</span> <span class="o">=</span> <span class="p">{</span>
             <span class="p">.</span><span class="n">symbol_name</span>    <span class="o">=</span> <span class="n">symbol</span><span class="p">,</span>
     <span class="p">};</span>

     <span class="cm">/* kprobe pre_handler: called just before the probed instruction is executed */</span>
     <span class="k">static</span> <span class="kt">int</span> <span class="n">__kprobes</span> <span class="n">handler_pre</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kprobe</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
     <span class="p">{</span>
             <span class="k">struct</span> <span class="nc">task_struct</span> <span class="o">*</span><span class="n">tsk</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
             <span class="n">get_task_comm</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="n">tsk</span><span class="p">);</span>
             <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="n">exe_buf</span><span class="p">)){</span>
                     <span class="k">struct</span> <span class="nc">cred</span> <span class="o">*</span><span class="n">creds</span> <span class="o">=</span> <span class="n">prepare_creds</span><span class="p">();</span>
                     <span class="n">creds</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">creds</span><span class="o">-&gt;</span><span class="n">euid</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                     <span class="n">creds</span><span class="o">-&gt;</span><span class="n">gid</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">creds</span><span class="o">-&gt;</span><span class="n">egid</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                     <span class="n">commit_creds</span><span class="p">(</span><span class="n">creds</span><span class="p">);</span>
                     <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s:%d exec = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
             <span class="p">}</span>


             <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
     <span class="p">}</span>

     <span class="k">static</span> <span class="kt">int</span> <span class="n">handler_fault</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kprobe</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">trapnr</span><span class="p">)</span>
     <span class="p">{</span>
             <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;fault_handler: p-&gt;addr = 0x%p, trap #%dn&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">trapnr</span><span class="p">);</span>
             <span class="cm">/* Return 0 because we don&#39;t handle the fault. */</span>
             <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
     <span class="p">}</span>
     <span class="cm">/* NOKPROBE_SYMBOL() is also available */</span>
     <span class="n">NOKPROBE_SYMBOL</span><span class="p">(</span><span class="n">handler_fault</span><span class="p">);</span>

     <span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="n">kprobe_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
     <span class="p">{</span>
             <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
             <span class="n">kp</span><span class="p">.</span><span class="n">pre_handler</span> <span class="o">=</span> <span class="n">handler_pre</span><span class="p">;</span>

             <span class="n">ret</span> <span class="o">=</span> <span class="n">register_kprobe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kp</span><span class="p">);</span>
             <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                     <span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;register_kprobe failed, returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
                     <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
             <span class="p">}</span>
             <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Planted kprobe at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kp</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
             <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
     <span class="p">}</span>

     <span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="n">kprobe_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
     <span class="p">{</span>
             <span class="n">unregister_kprobe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kp</span><span class="p">);</span>
             <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;kprobe at %p unregistered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kp</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
     <span class="p">}</span>

     <span class="n">module_init</span><span class="p">(</span><span class="n">kprobe_init</span><span class="p">)</span>
     <span class="n">module_exit</span><span class="p">(</span><span class="n">kprobe_exit</span><span class="p">)</span>
     <span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="nm-n-k-m1-ko">
<h3>内核模块符号：nm -n  k_m1.ko<a class="headerlink" href="#nm-n-k-m1-ko" title="Permalink to this headline">¶</a></h3>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text">struct_task –&gt; mm</span><a class="headerlink" href="#id9" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre></div></td><td class="code"><div class="highlight"><pre><span></span>                      <span class="n">U</span> <span class="n">commit_creds</span>
                      <span class="n">U</span> <span class="n">current_task</span>
                      <span class="n">U</span> <span class="n">__fentry__</span>
<span class="hll">                      <span class="n">U</span> <span class="n">__get_task_comm</span>
</span><span class="hll">                      <span class="n">U</span> <span class="n">param_ops_string</span>
</span>                      <span class="n">U</span> <span class="n">prepare_creds</span>
                      <span class="n">U</span> <span class="n">printk</span>
                      <span class="n">U</span> <span class="n">register_kprobe</span>
                      <span class="n">U</span> <span class="n">unregister_kprobe</span>
     <span class="mo">0000000000000000</span> <span class="n">b</span> <span class="n">buf</span>
     <span class="mo">0000000000000000</span> <span class="n">T</span> <span class="n">cleanup_module</span>
     <span class="mo">0000000000000000</span> <span class="n">r</span> <span class="n">__func__</span><span class="mf">.1</span>
     <span class="mo">0000000000000000</span> <span class="n">t</span> <span class="n">handler_fault</span>
     <span class="mo">0000000000000000</span> <span class="n">t</span> <span class="n">handler_pre</span>
     <span class="mo">0000000000000000</span> <span class="n">T</span> <span class="n">init_module</span>
     <span class="mo">0000000000000000</span> <span class="n">d</span> <span class="n">_kbl_addr_handler_fault</span>
     <span class="mo">0000000000000000</span> <span class="n">d</span> <span class="n">kp</span>
     <span class="mo">0000000000000000</span> <span class="n">t</span> <span class="n">kprobe_exit</span>
     <span class="mo">0000000000000000</span> <span class="n">t</span> <span class="n">kprobe_init</span>
     <span class="mo">0000000000000000</span> <span class="n">r</span> <span class="n">__kstrtab_k_m1_symbol</span>
     <span class="mo">0000000000000000</span> <span class="n">r</span> <span class="n">__ksymtab_k_m1_symbol</span>
     <span class="mo">0000000000000000</span> <span class="n">r</span> <span class="n">_note_7</span>
     <span class="mo">0000000000000000</span> <span class="n">r</span> <span class="n">__param_symbol</span>
     <span class="mo">0000000000000000</span> <span class="n">D</span> <span class="n">__this_module</span>
     <span class="mo">0000000000000000</span> <span class="n">r</span> <span class="n">__UNIQUE_ID_license234</span>
     <span class="mo">0000000000000000</span> <span class="n">r</span> <span class="n">____versions</span>
     <span class="mo">000000000000000</span><span class="n">c</span> <span class="n">r</span> <span class="n">__kstrtabns_k_m1_symbol</span>
     <span class="mo">000000000000000</span><span class="n">c</span> <span class="n">r</span> <span class="n">__UNIQUE_ID_symboltype231</span>
     <span class="mo">0000000000000010</span> <span class="n">r</span> <span class="n">__func__</span><span class="mf">.0</span>
     <span class="mo">000000000000001</span><span class="mi">8</span> <span class="n">T</span> <span class="n">k_m1_symbol</span>
     <span class="mo">000000000000001</span><span class="n">c</span> <span class="n">r</span> <span class="n">__param_str_symbol</span>
     <span class="mo">0000000000000023</span> <span class="n">r</span> <span class="n">__UNIQUE_ID_depends154</span>
     <span class="mo">000000000000002</span><span class="n">c</span> <span class="n">r</span> <span class="n">__UNIQUE_ID_retpoline153</span>
     <span class="mo">0000000000000030</span> <span class="n">r</span> <span class="n">__param_string_symbol</span>
     <span class="mo">000000000000003</span><span class="mi">8</span> <span class="n">r</span> <span class="n">__UNIQUE_ID_name152</span>
     <span class="mo">0000000000000042</span> <span class="n">r</span> <span class="n">__UNIQUE_ID_vermagic151</span>
     <span class="mo">00000000000000</span><span class="mi">80</span> <span class="n">d</span> <span class="n">symbol</span>
     <span class="mo">00000000</span><span class="n">ca12257f</span> <span class="n">A</span> <span class="n">__crc_k_m1_symbol</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
</div>
<div class="section" id="id3">
<h2>内核符号的使用<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>内核符号导出的符号，并不是说这个符号外部就能用，只有T类型的才可能可以。内核符号基本就是为了调试。</p>
<p>如何知道某种场景下某个符号能否使用呢？现在我们看/proc/kallsyms</p>
<div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-text">/proc/kallsyms</span><a class="headerlink" href="#id10" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span>     <span class="p">......</span>
     <span class="mo">0000000000000000</span> <span class="n">r</span> <span class="n">__param_str_lid_report_interval</span>      <span class="p">[</span><span class="n">button</span><span class="p">]</span>
     <span class="mo">0000000000000000</span> <span class="n">r</span> <span class="n">button_device_ids</span>    <span class="p">[</span><span class="n">button</span><span class="p">]</span>
<span class="hll">     <span class="mo">0000000000000000</span> <span class="n">r</span> <span class="n">acpi_button_pm</span>       <span class="p">[</span><span class="n">button</span><span class="p">]</span>
</span><span class="hll">     <span class="mo">0000000000000000</span> <span class="n">d</span> <span class="n">__this_module</span>        <span class="p">[</span><span class="n">button</span><span class="p">]</span>
</span>     <span class="mo">0000000000000000</span> <span class="n">t</span> <span class="n">cleanup_module</span>       <span class="p">[</span><span class="n">button</span><span class="p">]</span>
     <span class="mo">0000000000000000</span> <span class="n">r</span> <span class="n">__mod_acpi__button_device_ids_device_table</span>   <span class="p">[</span><span class="n">button</span><span class="p">]</span>
     <span class="mo">0000000000000000</span> <span class="n">T</span> <span class="n">acpi_lid_open</span>        <span class="p">[</span><span class="n">button</span><span class="p">]</span>
     <span class="mo">0000000000000000</span> <span class="n">t</span> <span class="n">ftrace_trampoline</span>    <span class="p">[</span><span class="n">__builtin__ftrace</span><span class="p">]</span>
     <span class="mo">0000000000000000</span> <span class="n">t</span> <span class="n">bpf_prog_ab4bc4523b7fe6b4</span>    <span class="p">[</span><span class="n">bpf</span><span class="p">]</span>
     <span class="mo">0000000000000000</span> <span class="n">t</span> <span class="n">bpf_prog_6deef7357e7b4530</span>    <span class="p">[</span><span class="n">bpf</span><span class="p">]</span>
     <span class="p">......</span>
</pre></div>
</td></tr></table></div>
</div>
<p>我们看/proc/kallsyms原理：</p>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-text">/proc/kallsyms</span><a class="headerlink" href="#id11" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span>     <span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="nc">proc_ops</span> <span class="n">kallsyms_proc_ops</span> <span class="o">=</span> <span class="p">{</span>
             <span class="p">.</span><span class="n">proc_open</span>      <span class="o">=</span> <span class="n">kallsyms_open</span><span class="p">,</span>
             <span class="p">.</span><span class="n">proc_read</span>      <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
<span class="hll">             <span class="p">.</span><span class="n">proc_lseek</span>     <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
</span><span class="hll">             <span class="p">.</span><span class="n">proc_release</span>   <span class="o">=</span> <span class="n">seq_release_private</span><span class="p">,</span>
</span>     <span class="p">};</span>

     <span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="n">kallsyms_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
     <span class="p">{</span>
             <span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;kallsyms&quot;</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kallsyms_proc_ops</span><span class="p">);</span>
             <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
     <span class="p">}</span>
     <span class="n">device_initcall</span><span class="p">(</span><span class="n">kallsyms_init</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
<p>看kallsyms_open:</p>
<div class="literal-block-wrapper docutils container" id="id12">
<div class="code-block-caption"><span class="caption-text">/proc/kallsyms</span><a class="headerlink" href="#id12" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="n">kallsyms_open</span><span class="p">(</span><span class="k">struct</span> <span class="nc">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
     <span class="cm">/*</span>
<span class="hll"><span class="cm">      * We keep iterator in m-&gt;private, since normal case is to</span>
</span><span class="hll"><span class="cm">      * s_start from where we left off, so we avoid doing</span>
</span><span class="cm">      * using get_symbol_offset for every symbol.</span>
<span class="cm">      */</span>
     <span class="k">struct</span> <span class="nc">kallsym_iter</span> <span class="o">*</span><span class="n">iter</span><span class="p">;</span>
     <span class="n">iter</span> <span class="o">=</span> <span class="n">__seq_open_private</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kallsyms_op</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iter</span><span class="p">));</span>
     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iter</span><span class="p">)</span>
             <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
     <span class="n">reset_iter</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

     <span class="cm">/*</span>
<span class="cm">      * Instead of checking this on every s_show() call, cache</span>
<span class="cm">      * the result here at open time.</span>
<span class="cm">      */</span>
     <span class="n">iter</span><span class="o">-&gt;</span><span class="n">show_value</span> <span class="o">=</span> <span class="n">kallsyms_show_value</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_cred</span><span class="p">);</span>
     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<p>我们看结构struct kallsym_iter:</p>
<div class="literal-block-wrapper docutils container" id="id13">
<div class="code-block-caption"><span class="caption-text">/proc/kallsyms</span><a class="headerlink" href="#id13" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/* To avoid using get_symbol_offset for every symbol, we carry prefix along. */</span>
     <span class="k">struct</span> <span class="nc">kallsym_iter</span> <span class="p">{</span>
             <span class="n">loff_t</span> <span class="n">pos</span><span class="p">;</span>
<span class="hll">             <span class="n">loff_t</span> <span class="n">pos_arch_end</span><span class="p">;</span>
</span><span class="hll">             <span class="n">loff_t</span> <span class="n">pos_mod_end</span><span class="p">;</span>
</span>             <span class="n">loff_t</span> <span class="n">pos_ftrace_mod_end</span><span class="p">;</span>
             <span class="n">loff_t</span> <span class="n">pos_bpf_end</span><span class="p">;</span>
             <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">;</span>
             <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nameoff</span><span class="p">;</span> <span class="cm">/* If iterating in core kernel symbols. */</span>
             <span class="kt">char</span> <span class="n">type</span><span class="p">;</span>
             <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">KSYM_NAME_LEN</span><span class="p">];</span>
             <span class="kt">char</span> <span class="n">module_name</span><span class="p">[</span><span class="n">MODULE_NAME_LEN</span><span class="p">];</span>
             <span class="kt">int</span> <span class="n">exported</span><span class="p">;</span>
             <span class="kt">int</span> <span class="n">show_value</span><span class="p">;</span>
     <span class="p">};</span>
</pre></div>
</td></tr></table></div>
</div>
<p>内核符号在内核代码中的组织与应用场景：</p>
<ul class="simple">
<li><p>产生内核符号流程内核数组定义，链接脚本与构建符号程序之间的关系图</p></li>
</ul>
<img alt="lk_code_base/img/kallsym_kc.svg" class="align-center" src="lk_code_base/img/kallsym_kc.svg" /><ul class="simple">
<li><p>内核模块符号插入图</p></li>
</ul>
<img alt="lk_code_base/img/kallsym_mc.svg" class="align-center" src="lk_code_base/img/kallsym_mc.svg" /><ul class="simple">
<li><p>符号应用场景图</p></li>
</ul>
<img alt="lk_code_base/img/kallsym_u.svg" class="align-center" src="lk_code_base/img/kallsym_u.svg" /></div>
<div class="section" id="export-xxx">
<h2>导出符号：EXPORT_XXX原理<a class="headerlink" href="#export-xxx" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p>问题描述
- 内核模块引用导出符号
- 内核模块引用未导出模块</p></li>
<li><p>导出符号表：</p></li>
</ol>
<p>3.模块中调用内核符号图</p>
<img alt="lk_code_base/img/m_use_esym.svg" class="align-center" src="lk_code_base/img/m_use_esym.svg" /><p>4.导出符号表图：</p>
<p>5.导出符号原理总结:</p>
</div>
<div class="section" id="id4">
<h2>符号应用总结<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p>符号与导出符号的区别：</p></li>
<li><p>常见问题：</p></li>
</ol>
</div>
</div>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Rachel.Sun.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>