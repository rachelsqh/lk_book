<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>用户空间探针（uprobes) &mdash; Rachel&#39;s E-book 1.0 documentation</title><link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> Rachel's E-book
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../os_base/index.html">linux 操作系统概述</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../lk_devel/index.html">linux 内核开发基础</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../x86_kernel_base.html">linux X86内核基础</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../lk_code/index.html">linux 内核基础代码分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pm.html">电源管理框架</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cpu.html">cpu管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../driver.html">设备驱动</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ps.html">进程管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mem.html">内存管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fs.html">文件系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sec.html">linux 内核安全</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../yocto_kernel.html">yocto uboot与内核模块、内核开发总结</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../uboot.html">uboot理解</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dot.html">dot画图</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Rachel's E-book</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>用户空间探针（uprobes)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/lk_code_base/kernel_base/trace/uprobe.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="uprobes">
<h1>用户空间探针（uprobes)<a class="headerlink" href="#uprobes" title="Permalink to this headline">¶</a></h1>
<p>更多的是在应用部分（程序部分）</p>
<p>必然针对一个应用进程。</p>
<p>uprobe_register() –&gt; __uprobe_register –&gt;</p>
<div class="literal-block-wrapper docutils container" id="id21">
<div class="code-block-caption"><span class="caption-text">struct kset_uevent_ops</span><a class="headerlink" href="#id21" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
</pre></div>
</td></tr></table></div>
</div>
<dl>
<dt>/*</dt><dd><ul class="simple">
<li><p>__uprobe_register - register a probe</p></li>
<li><p>&#64;inode: the file in which the probe has to be placed.</p></li>
<li><p>&#64;offset: offset from the start of the file.</p></li>
<li><p>&#64;uc: information on howto handle the probe..</p></li>
<li></li>
<li><p>Apart from the access refcount, __uprobe_register() takes a creation</p></li>
<li><p>refcount (thro alloc_uprobe) if and only if this &#64;uprobe is getting</p></li>
<li><p>inserted into the rbtree (i.e first consumer for a &#64;inode:&#64;offset</p></li>
<li><p>tuple).  Creation refcount stops uprobe_unregister from freeing the</p></li>
<li><p>&#64;uprobe even before the register operation is complete. Creation</p></li>
<li><p>refcount is released when the last &#64;uc for the &#64;uprobe</p></li>
<li><p>unregisters. Caller of __uprobe_register() is required to keep &#64;inode</p></li>
<li><p>(and the containing mount) referenced.</p></li>
<li></li>
<li><p>Return errno if it cannot successully install probes</p></li>
<li><p>else return 0 (success)</p></li>
</ul>
<p><a href="#id1"><span class="problematic" id="id2">*</span></a>/</p>
</dd>
<dt>static int __uprobe_register(struct inode <a href="#id3"><span class="problematic" id="id4">*</span></a>inode, loff_t offset,</dt><dd><p>loff_t ref_ctr_offset, struct uprobe_consumer <a href="#id5"><span class="problematic" id="id6">*</span></a>uc)</p>
</dd>
</dl>
<dl>
<dt>{</dt><dd><blockquote>
<div><p>struct uprobe <a href="#id7"><span class="problematic" id="id8">*</span></a>uprobe;
int ret;</p>
<p>/* Uprobe must have at least one set consumer <a href="#id9"><span class="problematic" id="id10">*</span></a>/
if (!uc-&gt;handler &amp;&amp; !uc-&gt;ret_handler)</p>
<blockquote>
<div><p>return -EINVAL;</p>
</div></blockquote>
<p>/* copy_insn() uses read_mapping_page() or shmem_read_mapping_page() <a href="#id11"><span class="problematic" id="id12">*</span></a>/
if (!inode-&gt;i_mapping-&gt;a_ops-&gt;readpage &amp;&amp; !shmem_mapping(inode-&gt;i_mapping))</p>
<blockquote>
<div><p>return -EIO;</p>
</div></blockquote>
<p>/* Racy, just to catch the obvious mistakes <a href="#id13"><span class="problematic" id="id14">*</span></a>/
if (offset &gt; i_size_read(inode))</p>
<blockquote>
<div><p>return -EINVAL;</p>
</div></blockquote>
<dl>
<dt>/*</dt><dd><ul class="simple">
<li><p>This ensures that copy_from_page(), copy_to_page() and</p></li>
<li><p>__update_ref_ctr() can’t cross page boundary.</p></li>
</ul>
<p><a href="#id15"><span class="problematic" id="id16">*</span></a>/</p>
</dd>
<dt>if (!IS_ALIGNED(offset, UPROBE_SWBP_INSN_SIZE))</dt><dd><p>return -EINVAL;</p>
</dd>
<dt>if (!IS_ALIGNED(ref_ctr_offset, sizeof(short)))</dt><dd><p>return -EINVAL;</p>
</dd>
</dl>
</div></blockquote>
<dl>
<dt>retry:</dt><dd><p>uprobe = alloc_uprobe(inode, offset, ref_ctr_offset);
if (!uprobe)</p>
<blockquote>
<div><p>return -ENOMEM;</p>
</div></blockquote>
<dl>
<dt>if (IS_ERR(uprobe))</dt><dd><p>return PTR_ERR(uprobe);</p>
</dd>
<dt>/*</dt><dd><ul class="simple">
<li><p>We can race with uprobe_unregister()-&gt;delete_uprobe().</p></li>
<li><p>Check uprobe_is_active() and retry if it is false.</p></li>
</ul>
<p><a href="#id17"><span class="problematic" id="id18">*</span></a>/</p>
</dd>
</dl>
<p>down_write(&amp;uprobe-&gt;register_rwsem);
ret = -EAGAIN;
if (likely(uprobe_is_active(uprobe))) {</p>
<blockquote>
<div><p>consumer_add(uprobe, uc);
ret = register_for_each_vma(uprobe, uc);
if (ret)</p>
<blockquote>
<div><p>__uprobe_unregister(uprobe, uc);</p>
</div></blockquote>
</div></blockquote>
<p>}
up_write(&amp;uprobe-&gt;register_rwsem);
put_uprobe(uprobe);</p>
<dl class="simple">
<dt>if (unlikely(ret == -EAGAIN))</dt><dd><p>goto retry;</p>
</dd>
</dl>
<p>return ret;</p>
</dd>
</dl>
</dd>
</dl>
<p>}</p>
<div class="section" id="trace-uprobe">
<h2>trace uprobe使用场景<a class="headerlink" href="#trace-uprobe" title="Permalink to this headline">¶</a></h2>
<p>kernel/trace/trace_uprobe.c</p>
<p>debugfs:</p>
<ul class="simple">
<li><p>/sys/kernel/debug/tracing/uprobe_events</p></li>
<li><p>/sys/kernel/debug/tracing/uprobe_profile：配置文件：</p></li>
</ul>
<p>要启用此功能，请使用 CONFIG_UPROBE_EVENTS=y 构建内核。通过 /sys/kernel/debug/tracing/uprobe_events 添加探测点，uprobe 事件接口希望用户计算对象中探测点的偏移量。可以使用 /sys/kernel/debug/tracing/dynamic_events 代替 uprobe_events。该接口也将提供对其他动态事件的统一访问。</p>
<div class="section" id="uprobe-tracer">
<h3>uprobe_tracer<a class="headerlink" href="#uprobe-tracer" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://www.kernel.org/doc/html/latest/trace/uprobetracer.html">https://www.kernel.org/doc/html/latest/trace/uprobetracer.html</a></p>
<div class="literal-block-wrapper docutils container" id="id22">
<div class="code-block-caption"><span class="caption-text">struct kset_uevent_ops</span><a class="headerlink" href="#id22" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
</pre></div>
</td></tr></table></div>
</div>
<p>p[:[GRP/]EVENT] PATH:OFFSET [FETCHARGS] : Set a uprobe
r[:[GRP/]EVENT] PATH:OFFSET [FETCHARGS] : Set a return uprobe (uretprobe)
p[:[GRP/]EVENT] PATH:OFFSET%return [FETCHARGS] : Set a return uprobe (uretprobe)
-:[GRP/]EVENT                           : Clear uprobe or uretprobe event</p>
<p>GRP           : Group name. If omitted, “uprobes” is the default value.
EVENT         : Event name. If omitted, the event name is generated based</p>
<blockquote>
<div><p>on PATH+OFFSET.</p>
</div></blockquote>
<p>PATH          : Path to an executable or a library.
OFFSET        : Offset where the probe is inserted.
OFFSET%return : Offset where the return probe is inserted.</p>
<dl>
<dt>FETCHARGS<span class="classifier">Arguments. Each probe can have up to 128 args.</span></dt><dd><p>%REG         : Fetch register REG
&#64;ADDR        : Fetch memory at ADDR (ADDR should be in userspace)
&#64;+OFFSET     : Fetch memory at OFFSET (OFFSET from same file as PATH)
$stackN      : Fetch Nth entry of stack (N &gt;= 0)
$stack       : Fetch stack address.
$retval      : Fetch return value.(*1)
$comm        : Fetch current task comm.
+|-[u]OFFS(FETCHARG) : Fetch memory at FETCHARG +|- OFFS address.(*2)(*3)
IMM         : Store an immediate value to the argument.
NAME=FETCHARG     : Set NAME as the argument name of FETCHARG.
FETCHARG:TYPE     : Set TYPE as the type of FETCHARG. Currently, basic types</p>
<blockquote>
<div><p>(u8/u16/u32/u64/s8/s16/s32/s64), hexadecimal types
(x8/x16/x32/x64), “string” and bitfield are supported.</p>
</div></blockquote>
</dd>
</dl>
<p>(*1) only for return probe.
(*2) this is useful for fetching a field of data structures.
(*3) Unlike kprobe event, “u” prefix will just be ignored, becuse uprobe</p>
<blockquote>
<div><p>events can access only user-space memory.</p>
</div></blockquote>
</div>
<div class="section" id="id19">
<h3>事件分析<a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h3>
<p>您可以通过 /sys/kernel/debug/tracing/uprobe_profile 检查每个事件的探测命中总数。第一列是文件名，第二列是事件名称，第三列是探测命中数。</p>
</div>
<div class="section" id="id20">
<h3>使用示例<a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>添加一个探针作为新的 uprobe 事件，将新定义写入 uprobe_events，如下所示（在可执行文件 /bin/bash 中的偏移量 0x4245c0 处设置一个 uprobe）：</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id23">
<div class="code-block-caption"><span class="caption-text">struct kset_uevent_ops</span><a class="headerlink" href="#id23" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>echo &#39;p /bin/bash:0x4245c0&#39; &gt; /sys/kernel/debug/tracing/uprobe_events
</pre></div>
</td></tr></table></div>
</div>
<ul class="simple">
<li><p>添加一个探针作为新的 uretprobe 事件：</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id24">
<div class="code-block-caption"><span class="caption-text">struct kset_uevent_ops</span><a class="headerlink" href="#id24" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>echo &#39;r /bin/bash:0x4245c0&#39; &gt; /sys/kernel/debug/tracing/uprobe_events
</pre></div>
</td></tr></table></div>
</div>
<ul class="simple">
<li><p>取消注册事件：</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id25">
<div class="code-block-caption"><span class="caption-text">struct kset_uevent_ops</span><a class="headerlink" href="#id25" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>echo &#39;-:p_bash_0x4245c0&#39; &gt;&gt; /sys/kernel/debug/tracing/uprobe_events
</pre></div>
</td></tr></table></div>
</div>
<ul class="simple">
<li><p>打印出注册的事件：</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id26">
<div class="code-block-caption"><span class="caption-text">struct kset_uevent_ops</span><a class="headerlink" href="#id26" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">tracing</span><span class="o">/</span><span class="n">uprobe_events</span>
</pre></div>
</td></tr></table></div>
</div>
<ul class="simple">
<li><p>清除所有事件：</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id27">
<div class="code-block-caption"><span class="caption-text">struct kset_uevent_ops</span><a class="headerlink" href="#id27" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">tracing</span><span class="o">/</span><span class="n">uprobe_events</span>
</pre></div>
</td></tr></table></div>
</div>
<p>以下示例显示了如何将指令指针和 %ax 寄存器转储到探测的文本地址。探测 /bin/zsh 中的 zfree 函数：</p>
<div class="literal-block-wrapper docutils container" id="id28">
<div class="code-block-caption"><span class="caption-text">struct kset_uevent_ops</span><a class="headerlink" href="#id28" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp"># cd /sys/kernel/debug/tracing/</span>
<span class="cp"># cat /proc/`pgrep zsh`/maps | grep /bin/zsh | grep r-xp</span>
<span class="mo">00400000-004</span><span class="mi">8</span><span class="n">a000</span> <span class="n">r</span><span class="o">-</span><span class="n">xp</span> <span class="mo">00000000</span> <span class="mi">08</span><span class="o">:</span><span class="mo">03</span> <span class="mi">130904</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">zsh</span>
<span class="hll"><span class="cp"># objdump -T /bin/zsh | grep -w zfree</span>
</span><span class="hll"><span class="mo">0000000000446420</span> <span class="n">g</span>    <span class="n">DF</span> <span class="p">.</span><span class="n">text</span>  <span class="mo">0000000000000012</span>  <span class="n">Base</span>        <span class="n">zfree</span>
</span></pre></div>
</td></tr></table></div>
</div>
<p>0x46420 是在 0x00400000 加载的对象 /bin/zsh 中 zfree 的偏移量。因此，uprobe 的命令是：</p>
<div class="literal-block-wrapper docutils container" id="id29">
<div class="code-block-caption"><span class="caption-text">struct kset_uevent_ops</span><a class="headerlink" href="#id29" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp"># echo &#39;p:zfree_entry /bin/zsh:0x46420 %ip %ax&#39; &gt; uprobe_events</span>
</pre></div>
</td></tr></table></div>
</div>
<p>与 uretprobe 相同的是：</p>
<div class="literal-block-wrapper docutils container" id="id30">
<div class="code-block-caption"><span class="caption-text">struct kset_uevent_ops</span><a class="headerlink" href="#id30" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp"># echo &#39;r:zfree_exit /bin/zsh:0x46420 %ip %ax&#39; &gt;&gt; uprobe_events</span>
</pre></div>
</td></tr></table></div>
</div>
<p>用户必须明确计算对象中探测点的偏移量。</p>
<p>我们可以通过查看 uprobe_events 文件来查看注册的事件。</p>
<div class="literal-block-wrapper docutils container" id="id31">
<div class="code-block-caption"><span class="caption-text">struct kset_uevent_ops</span><a class="headerlink" href="#id31" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp"># cat uprobe_events</span>
<span class="nl">p</span><span class="p">:</span><span class="n">uprobes</span><span class="o">/</span><span class="n">zfree_entry</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="nl">zsh</span><span class="p">:</span><span class="mh">0x00046420</span> <span class="n">arg1</span><span class="o">=%</span><span class="n">ip</span> <span class="n">arg2</span><span class="o">=%</span><span class="n">ax</span>
<span class="nl">r</span><span class="p">:</span><span class="n">uprobes</span><span class="o">/</span><span class="n">zfree_exit</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="nl">zsh</span><span class="p">:</span><span class="mh">0x00046420</span> <span class="n">arg1</span><span class="o">=%</span><span class="n">ip</span> <span class="n">arg2</span><span class="o">=%</span><span class="n">ax</span>
</pre></div>
</td></tr></table></div>
</div>
<p>通过查看文件 events/uprobes/zfree_entry/format 可以看到事件的格式。</p>
<hr class="docutils" />
<p>初步总结，这些总归还是在于在某个对应的进程应用地址空间加入跳转指令，hook代码则在内核代码中实现：应该是int3处理程序中完成。（待确定）。</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Rachel.Sun.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>