<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>linux 内核模块原理分析 &mdash; Rachel&#39;s E-book 1.0 documentation</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="linux 内核通知/通信机制" href="notifier.html" />
    <link rel="prev" title="linux 内核代码目录结构" href="base_arch.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Rachel's E-book
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../os_base/index.html">linux 操作系统概述</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lk_devel/index.html">linux 内核开发基础</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">linux 内核基础代码分析</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="base_arch.html">linux 内核代码目录结构</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">linux 内核模块原理分析</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">linux 内核模块编程基础</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">内核编译及调试参考：</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">内核模块编译流程原理分析</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id4">构建过程分析</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">总结</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id10">内核导出符号</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id11">模块中引用外部函数</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id12">内核模块编译过程中符号的处理</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id13">内核模块加载过程分析</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id14">重点函数分析</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#rmmod">rmmod 卸载过程分析</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id31">总结</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="notifier.html">linux 内核通知/通信机制</a></li>
<li class="toctree-l2"><a class="reference internal" href="lock.html">linux 内核竞争处理</a></li>
<li class="toctree-l2"><a class="reference internal" href="hook.html">linux 内核hook</a></li>
<li class="toctree-l2"><a class="reference internal" href="kexec.html">linux 加载ELF 内核文件：kexec</a></li>
<li class="toctree-l2"><a class="reference internal" href="struct.html">linux 内核基础算法</a></li>
<li class="toctree-l2"><a class="reference internal" href="umh.html">第一个应用进程及umh</a></li>
<li class="toctree-l2"><a class="reference internal" href="extable.html">异常表:extable</a></li>
<li class="toctree-l2"><a class="reference internal" href="jump_label.html">jump_label</a></li>
<li class="toctree-l2"><a class="reference internal" href="x86.html">x86架构部分</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../yocto_kernel.html">yocto uboot与内核模块、内核开发总结</a></li>
<li class="toctree-l1"><a class="reference internal" href="../uboot.html">uboot理解</a></li>
<li class="toctree-l1"><a class="reference internal" href="../driver.html">设备驱动(待修正）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gitlab.html">基于gitlab的项目管理(待修正)</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Rachel's E-book</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">linux 内核基础代码分析</a> &raquo;</li>
      <li>linux 内核模块原理分析</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/lk_code/module.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="linux">
<h1>linux 内核模块原理分析<a class="headerlink" href="#linux" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id1">
<h2>linux 内核模块编程基础<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>每个模块由一个struct module表示</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id32">
<div class="code-block-caption"><span class="caption-text">struct module</span><a class="headerlink" href="#id32" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nc">module</span> <span class="p">{</span>
        <span class="k">enum</span> <span class="n">module_state</span> <span class="n">state</span><span class="p">;</span><span class="c1">//记录模块状态，如正常，加载，卸载等：    MODULE_STATE_LIVE/MODULE_STATE_COMING/MODULE_STATE_GOING/MODULE_STATE_UNFORMED</span>

<span class="hll">        <span class="cm">/* Member of list of modules */</span>
</span><span class="hll">        <span class="k">struct</span> <span class="nc">list_head</span> <span class="n">list</span><span class="p">;</span> <span class="cm">/* 系统中的模块通过这个成员组织成一个双向链表 */</span>
</span>
        <span class="cm">/* Unique handle for this module */</span>
        <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">MODULE_NAME_LEN</span><span class="p">];</span><span class="cm">/* 模块名,系统中模块名标注模块的唯一性 */</span>

<span class="cp">#ifdef CONFIG_STACKTRACE_BUILD_ID</span>
        <span class="cm">/* Module build ID */</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">build_id</span><span class="p">[</span><span class="n">BUILD_ID_SIZE_MAX</span><span class="p">];</span><span class="cm">/* build id:场景描述： */</span>
<span class="cp">#endif</span>

        <span class="cm">/* Sysfs stuff. */</span>
        <span class="k">struct</span> <span class="nc">module_kobject</span> <span class="n">mkobj</span><span class="p">;</span><span class="cm">/* 代表模块的kobject 结构*/</span>
        <span class="k">struct</span> <span class="nc">module_attribute</span> <span class="o">*</span><span class="n">modinfo_attrs</span><span class="p">;</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">version</span><span class="p">;</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">srcversion</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">kobject</span> <span class="o">*</span><span class="n">holders_dir</span><span class="p">;</span>

        <span class="cm">/* Exported symbols */</span>
        <span class="k">const</span> <span class="k">struct</span> <span class="nc">kernel_symbol</span> <span class="o">*</span><span class="n">syms</span><span class="p">;</span><span class="cm">/* 导出符号表:对应节 __ksymtab */</span>
        <span class="k">const</span> <span class="n">s32</span> <span class="o">*</span><span class="n">crcs</span><span class="p">;</span> <span class="cm">/* 符号地址表:对应节 __kcrctab */</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_syms</span><span class="p">;</span><span class="cm">/* 导出符号个数  */</span>

<span class="cp">#ifdef CONFIG_CFI_CLANG</span>
        <span class="n">cfi_check_fn</span> <span class="n">cfi_check</span><span class="p">;</span>
<span class="cp">#endif</span>

        <span class="cm">/* Kernel parameters. */</span>
<span class="cp">#ifdef CONFIG_SYSFS</span>
        <span class="k">struct</span> <span class="nc">mutex</span> <span class="n">param_lock</span><span class="p">;</span>
<span class="cp">#endif</span>
        <span class="k">struct</span> <span class="nc">kernel_param</span> <span class="o">*</span><span class="n">kp</span><span class="p">;</span><span class="cm">/* 内核模块参数表:对应节 __param */</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_kp</span><span class="p">;</span>  <span class="cm">/* 内核模块参数个数 */</span>

        <span class="cm">/* GPL-only exported symbols. */</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_gpl_syms</span><span class="p">;</span> <span class="cm">/* 导出遵循GPL许可的符号个数 */</span>
        <span class="k">const</span> <span class="k">struct</span> <span class="nc">kernel_symbol</span> <span class="o">*</span><span class="n">gpl_syms</span><span class="p">;</span> <span class="cm">/* 遵循GPL许可的导出符号表:对应节 __ksymtab_gpl */</span>
        <span class="k">const</span> <span class="n">s32</span> <span class="o">*</span><span class="n">gpl_crcs</span><span class="p">;</span> <span class="cm">/* 符号地址:对应节 __kcrctab_gpl */</span>
        <span class="kt">bool</span> <span class="n">using_gplonly_symbols</span><span class="p">;</span><span class="cm">/* 引用了GPL许可的符号 */</span>

<span class="cp">#ifdef CONFIG_MODULE_SIG</span>
        <span class="cm">/* Signature was verified. */</span>
        <span class="kt">bool</span> <span class="n">sig_ok</span><span class="p">;</span>
<span class="cp">#endif</span>

        <span class="kt">bool</span> <span class="n">async_probe_requested</span><span class="p">;</span>

        <span class="cm">/* Exception table */</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_exentries</span><span class="p">;</span> <span class="cm">/* 异常表数目 */</span>
        <span class="k">struct</span> <span class="nc">exception_table_entry</span> <span class="o">*</span><span class="n">extable</span><span class="p">;</span><span class="cm">/* 异常表 */</span>

        <span class="cm">/* Startup function. */</span>
        <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">init</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span><span class="c1">//初始化句柄</span>

        <span class="cm">/* Core layout: rbtree is accessed frequently, so keep together. */</span>
        <span class="k">struct</span> <span class="nc">module_layout</span> <span class="n">core_layout</span> <span class="n">__module_layout_align</span><span class="p">;</span> <span class="cm">/* 常驻内存的内存布局 */</span>
        <span class="k">struct</span> <span class="nc">module_layout</span> <span class="n">init_layout</span><span class="p">;</span> <span class="cm">/* 初始化函数执行完后，需要释放  */</span>

        <span class="cm">/* Arch-specific module values */</span>
        <span class="k">struct</span> <span class="nc">mod_arch_specific</span> <span class="n">arch</span><span class="p">;</span>

        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">taints</span><span class="p">;</span>   <span class="cm">/* same bits as kernel:taint_flags */</span>

<span class="cp">#ifdef CONFIG_GENERIC_BUG</span>
        <span class="cm">/* Support for BUG */</span>
        <span class="kt">unsigned</span> <span class="n">num_bugs</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">list_head</span> <span class="n">bug_list</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">bug_entry</span> <span class="o">*</span><span class="n">bug_table</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_KALLSYMS</span>
        <span class="cm">/* Protected by RCU and/or module_mutex: use rcu_dereference() */</span>
        <span class="k">struct</span> <span class="nc">mod_kallsyms</span> <span class="n">__rcu</span> <span class="o">*</span><span class="n">kallsyms</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">mod_kallsyms</span> <span class="n">core_kallsyms</span><span class="p">;</span>

        <span class="cm">/* Section attributes */</span>
        <span class="k">struct</span> <span class="nc">module_sect_attrs</span> <span class="o">*</span><span class="n">sect_attrs</span><span class="p">;</span>

        <span class="cm">/* Notes attributes */</span>
        <span class="k">struct</span> <span class="nc">module_notes_attrs</span> <span class="o">*</span><span class="n">notes_attrs</span><span class="p">;</span>
<span class="cp">#endif</span>

        <span class="cm">/* The command line arguments (may be mangled).  People like</span>
<span class="cm">           keeping pointers to this stuff */</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">args</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SMP</span>
        <span class="cm">/* Per-cpu data. */</span>
        <span class="kt">void</span> <span class="n">__percpu</span> <span class="o">*</span><span class="n">percpu</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">percpu_size</span><span class="p">;</span>
<span class="cp">#endif</span>
        <span class="kt">void</span> <span class="o">*</span><span class="n">noinstr_text_start</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">noinstr_text_size</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_TRACEPOINTS</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_tracepoints</span><span class="p">;</span>
        <span class="n">tracepoint_ptr_t</span> <span class="o">*</span><span class="n">tracepoints_ptrs</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_TREE_SRCU</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_srcu_structs</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">srcu_struct</span> <span class="o">**</span><span class="n">srcu_struct_ptrs</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BPF_EVENTS</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_bpf_raw_events</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">bpf_raw_event_map</span> <span class="o">*</span><span class="n">bpf_raw_events</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_DEBUG_INFO_BTF_MODULES</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">btf_data_size</span><span class="p">;</span>
        <span class="kt">void</span> <span class="o">*</span><span class="n">btf_data</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_JUMP_LABEL</span>
        <span class="k">struct</span> <span class="nc">jump_entry</span> <span class="o">*</span><span class="n">jump_entries</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_jump_entries</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_TRACING</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_trace_bprintk_fmt</span><span class="p">;</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">trace_bprintk_fmt_start</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_EVENT_TRACING</span>
        <span class="k">struct</span> <span class="nc">trace_event_call</span> <span class="o">**</span><span class="n">trace_events</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_trace_events</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">trace_eval_map</span> <span class="o">**</span><span class="n">trace_evals</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_trace_evals</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_FTRACE_MCOUNT_RECORD</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_ftrace_callsites</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">ftrace_callsites</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_KPROBES</span>
        <span class="kt">void</span> <span class="o">*</span><span class="n">kprobes_text_start</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">kprobes_text_size</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">kprobe_blacklist</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_kprobe_blacklist</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_HAVE_STATIC_CALL_INLINE</span>
        <span class="kt">int</span> <span class="n">num_static_call_sites</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">static_call_site</span> <span class="o">*</span><span class="n">static_call_sites</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_LIVEPATCH</span>
        <span class="kt">bool</span> <span class="n">klp</span><span class="p">;</span> <span class="cm">/* Is this a livepatch module? */</span>
        <span class="kt">bool</span> <span class="n">klp_alive</span><span class="p">;</span>

        <span class="cm">/* Elf information */</span>
        <span class="k">struct</span> <span class="nc">klp_modinfo</span> <span class="o">*</span><span class="n">klp_info</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_MODULE_UNLOAD</span>
        <span class="cm">/* What modules depend on me? */</span>
        <span class="k">struct</span> <span class="nc">list_head</span> <span class="n">source_list</span><span class="p">;</span><span class="cm">/* 依赖的模块列表 */</span>
        <span class="cm">/* What modules do I depend on? */</span>
        <span class="k">struct</span> <span class="nc">list_head</span> <span class="n">target_list</span><span class="p">;</span> <span class="cm">/* 依赖我的内核模块列表 */</span>

        <span class="cm">/* Destruction function. */</span>
        <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">exit</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>

        <span class="n">atomic_t</span> <span class="n">refcnt</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_CONSTRUCTORS</span>
        <span class="cm">/* Constructor functions. */</span>
        <span class="n">ctor_fn_t</span> <span class="o">*</span><span class="n">ctors</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_ctors</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_FUNCTION_ERROR_INJECTION</span>
        <span class="k">struct</span> <span class="nc">error_injection_entry</span> <span class="o">*</span><span class="n">ei_funcs</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_ei_funcs</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span> <span class="n">____cacheline_aligned</span> <span class="n">__randomize_layout</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
</div>
<ul class="simple">
<li><p>demo.c:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id33">
<div class="code-block-caption"><span class="caption-text">内核模块demo.c</span><a class="headerlink" href="#id33" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;linux/kernel.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="n">k_mod_sample_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="hll"><span class="p">{</span>
</span><span class="hll">        <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">);</span>
</span>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="n">k_mod_sample_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">k_mod_sample_init</span><span class="p">)</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">k_mod_sample_exit</span><span class="p">)</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
<p>demo.mod.c</p>
<div class="literal-block-wrapper docutils container" id="id34">
<div class="code-block-caption"><span class="caption-text">中间文件demo.mod.c</span><a class="headerlink" href="#id34" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="cp"></span>
<span class="cp">#define INCLUDE_VERMAGIC</span>
<span class="cp">#include</span> <span class="cpf">&lt;linux/build-salt.h&gt;</span><span class="cp"></span>
<span class="hll"><span class="cp">#include</span> <span class="cpf">&lt;linux/elfnote-lto.h&gt;</span><span class="cp"></span>
</span><span class="hll"><span class="cp">#include</span> <span class="cpf">&lt;linux/vermagic.h&gt;</span><span class="cp"></span>
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/compiler.h&gt;</span><span class="cp"></span>

<span class="n">BUILD_SALT</span><span class="p">;</span>
<span class="n">BUILD_LTO_INFO</span><span class="p">;</span>

<span class="n">MODULE_INFO</span><span class="p">(</span><span class="n">vermagic</span><span class="p">,</span> <span class="n">VERMAGIC_STRING</span><span class="p">);</span>
<span class="n">MODULE_INFO</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">);</span>

<span class="n">__visible</span> <span class="k">struct</span> <span class="nc">module</span> <span class="n">__this_module</span>
<span class="n">__section</span><span class="p">(</span><span class="s">&quot;.gnu.linkonce.this_module&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
        <span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">init_module</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_MODULE_UNLOAD</span>
        <span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">cleanup_module</span><span class="p">,</span>
<span class="cp">#endif</span>
        <span class="p">.</span><span class="n">arch</span> <span class="o">=</span> <span class="n">MODULE_ARCH_INIT</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_RETPOLINE</span>
<span class="n">MODULE_INFO</span><span class="p">(</span><span class="n">retpoline</span><span class="p">,</span> <span class="s">&quot;Y&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="nc">modversion_info</span> <span class="n">____versions</span><span class="p">[]</span>
<span class="n">__used</span> <span class="n">__section</span><span class="p">(</span><span class="s">&quot;__versions&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{</span> <span class="mh">0x9736759a</span><span class="p">,</span> <span class="s">&quot;module_layout&quot;</span> <span class="p">},</span>
        <span class="p">{</span> <span class="mh">0xc5850110</span><span class="p">,</span> <span class="s">&quot;printk&quot;</span> <span class="p">},</span>
        <span class="p">{</span> <span class="mh">0xbdfb6dbb</span><span class="p">,</span> <span class="s">&quot;__fentry__&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="n">MODULE_INFO</span><span class="p">(</span><span class="n">depends</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
<ul class="simple">
<li><p>模块组织：</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id35">
<div class="code-block-caption"><span class="caption-text">注册到系统中的模块索引</span><a class="headerlink" href="#id35" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * Mutex protects:</span>
<span class="cm"> * 1) List of modules (also safely readable with preempt_disable),</span>
<span class="hll"><span class="cm"> * 2) module_use links,</span>
</span><span class="hll"><span class="cm"> * 3) module_addr_min/module_addr_max.</span>
</span><span class="cm"> * (delete and add uses RCU list operations).</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="nf">DEFINE_MUTEX</span><span class="p">(</span><span class="n">module_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="nf">LIST_HEAD</span><span class="p">(</span><span class="n">modules</span><span class="p">);</span><span class="c1">//注册到系统中所有的模块列表</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="id2">
<h2>内核编译及调试参考：<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<iframe src="../lk_devel/lk_build/m_build.html" height="345px" width="100%"></iframe></div>
<div class="section" id="id3">
<h2>内核模块编译流程原理分析<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>对模块的编译过程进行分析，总结。</p>
<div class="section" id="id4">
<h3>构建过程分析<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>make流程分析</p></li>
</ul>
<p>A.make:$(MAKE) -C $(KDIR) M=$(PWD) modules</p>
<div class="literal-block-wrapper docutils container" id="id36">
<div class="code-block-caption"><span class="caption-text">make命令解析</span><a class="headerlink" href="#id36" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span>   <span class="mf">1.</span> <span class="n">cd</span> <span class="n">$</span><span class="p">(</span><span class="n">KDIR</span><span class="p">)</span>
   <span class="mf">2.</span> <span class="n">$M</span> <span class="o">=</span> <span class="n">$</span><span class="p">(</span><span class="n">PWD</span><span class="p">)</span>
   <span class="mf">3.</span> <span class="n">make</span> <span class="n">modules</span>
</pre></div>
</td></tr></table></div>
</div>
<ol class="upperalpha" start="2">
<li><p>kernel/Makefile 内核模块编译说明。</p>
<ol class="arabic">
<li><p>KBUILD_EXTMOD := $(M) : make M=dir (外部模块目录)</p></li>
<li><p>KBUILD_MODULES := 1</p></li>
<li><p>build-dirs := $(KBUILD_EXTMOD)</p></li>
<li><p>Makefile: modules:$(MODORDER) 等价于: modules: /root/for_work/rootkit/demo1/k_mod</p>
<div class="literal-block-wrapper docutils container" id="id37">
<div class="code-block-caption"><span class="caption-text">代码片段</span><a class="headerlink" href="#id37" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="highlight"><pre><span></span>        # External module support.
        # When building external modules the kernel used as basis is considered
        # read-only, and no consistency checks are made and the make
<span class="hll">        # system is not used on the basis kernel. If updates are required
</span><span class="hll">        # in the basis kernel ordinary make commands (without M=...) must
</span>        # be used.
        #
        # The following are the only valid targets when building external
        # modules.
        # make M=dir clean     Delete all automatically generated files
        # make M=dir modules   Make all modules in specified dir
        # make M=dir           Same as &#39;make M=dir modules&#39;
        # make M=dir modules_install
        #                      Install the modules built in the module directory
        #                      Assumes install directory is already created

        # We are always building only modules.
        KBUILD_BUILTIN :=
        KBUILD_MODULES := 1

        build-dirs := $(KBUILD_EXTMOD)
        PHONY += modules
        modules: $(MODORDER)
                $(Q)$(MAKE) -f $(srctree)/scripts/Makefile.modpost

        $(MODORDER): descend
                @:

        descend: $(build-dirs)
        $(build-dirs): prepare      #此处prepare为空
                $(Q)$(MAKE) $(build)=$@ \
                single-build=$(if $(filter-out $@/, $(filter $@/%, $(KBUILD_SINGLE_TARGETS))),1) \
                need-builtin=1 need-modorder=1
</pre></div>
</td></tr></table></div>
</div>
<p>Makefile中modules的前提条件:$(MODORDER)，以上指令等价于：</p>
<div class="literal-block-wrapper docutils container" id="id38">
<div class="code-block-caption"><span class="caption-text">代码片段</span><a class="headerlink" href="#id38" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">:</span><span class="nl">linenos</span><span class="p">:</span>

 <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">for_work</span><span class="o">/</span><span class="n">rootkit</span><span class="o">/</span><span class="n">demo1</span><span class="o">/</span><span class="nl">k_mod</span><span class="p">:</span> <span class="n">make</span> <span class="o">-</span><span class="n">f</span> <span class="p">.</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">Makefile</span><span class="p">.</span><span class="n">build</span> <span class="n">obj</span><span class="o">=/</span><span class="n">root</span><span class="o">/</span><span class="n">for_work</span><span class="o">/</span><span class="n">rootkit</span><span class="o">/</span><span class="n">demo1</span><span class="o">/</span><span class="n">k_mod</span>  <span class="n">single</span><span class="o">-</span><span class="n">build</span><span class="o">=</span>  <span class="n">need</span><span class="o">-</span><span class="n">builtin</span><span class="o">=</span><span class="mi">1</span> <span class="n">need</span><span class="o">-</span><span class="n">modorder</span><span class="o">=</span><span class="mi">1</span>
</pre></div>
</div>
</div>
</li>
<li><p>Makefile.build相关片段:</p>
<div class="literal-block-wrapper docutils container" id="id39">
<div class="code-block-caption"><span class="caption-text">代码片段</span><a class="headerlink" href="#id39" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span>        __build: $(if $(KBUILD_BUILTIN), $(targets-for-builtin)) \
                 $(if $(KBUILD_MODULES), $(targets-for-modules)) \
                 $(subdir-ym) $(always-y)
<span class="hll">                @echo &quot;target:&quot; $(if $(KBUILD_BUILTIN), $(targets-for-builtin)) \  #(额外添加)
</span><span class="hll">                $(if $(KBUILD_MODULES), $(targets-for-modules)) \
</span>                 $(subdir-ym) $(always-y)
                @:
</pre></div>
</td></tr></table></div>
</div>
<p>结果:#make</p>
<p>等价于:</p>
<div class="literal-block-wrapper docutils container" id="id40">
<div class="code-block-caption"><span class="caption-text">代码片段</span><a class="headerlink" href="#id40" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>        <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">k_mod</span><span class="o">/</span><span class="n">k_m</span><span class="p">.</span><span class="nl">mod</span><span class="p">:</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">k_mod</span><span class="o">/</span><span class="n">k_m</span><span class="p">.</span><span class="n">o</span> <span class="n">FORCE</span>
</pre></div>
</td></tr></table></div>
</div>
<p>通过/path/k_mod/Makefile我们知道k_m.o依赖:</p>
<div class="literal-block-wrapper docutils container" id="id41">
<div class="code-block-caption"><span class="caption-text">代码片段</span><a class="headerlink" href="#id41" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">obj</span><span class="o">-</span><span class="nl">m</span> <span class="p">:</span><span class="o">=</span> <span class="n">k_m</span><span class="p">.</span><span class="n">o</span>
<span class="n">k_m</span><span class="o">-</span><span class="nl">m</span> <span class="p">:</span><span class="o">=</span> <span class="n">k_m1</span><span class="p">.</span><span class="n">o</span> <span class="n">k_m2</span><span class="p">.</span><span class="n">o</span>
</pre></div>
</td></tr></table></div>
</div>
<p>而Makefile.build中对*.o定义为:编译目标文件:<a href="#id5"><span class="problematic" id="id6">*</span></a>.c –&gt; <a href="#id7"><span class="problematic" id="id8">*</span></a>.o：</p>
<div class="literal-block-wrapper docutils container" id="id42">
<div class="code-block-caption"><span class="caption-text">代码片段</span><a class="headerlink" href="#id42" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span># Built-in and composite module parts
$(obj)/%.o: $(src)/%.c $(recordmcount_source) $(objtool_dep) FORCE
        $(call if_changed_rule,cc_o_c)
<span class="hll">        @echo $(rule_cc_o_c)    #额外添加,具体信息在下一条说明
</span><span class="hll">        $(call cmd,force_checksrc)
</span></pre></div>
</td></tr></table></div>
</div>
<p>其规则展开为:</p>
<div class="literal-block-wrapper docutils container" id="id43">
<div class="code-block-caption"><span class="caption-text">代码片段</span><a class="headerlink" href="#id43" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span>echo    @set -e;  echo &#39;  CC [M]  /root/for_work/rootkit/demo1/k_mod/k_m1.o&#39;; gcc -Wp,-MMD,/root/for_work/rootkit/demo1/k_mod/.k_m1.o.d -nostdinc -isystem /usr/lib/gcc/x86_64-linux-gnu/10/include -I./arch/x86/include -I./arch/x86/include/generated  -I./include -I./arch/x86/include/uapi -I./arch/x86/include/generated/uapi -I./include/uapi -I./include/generated/uapi -include ./include/linux/kconfig.h -include ./include/linux/compiler_types.h -D__KERNEL__ -fmacro-prefix-map=./= -Wall -Wundef -Werror=strict-prototypes -Wno-trigraphs -fno-strict-aliasing -fno-common -fshort-wchar -fno-PIE -Werror=implicit-function-declaration -Werror=implicit-int -Werror=return-type -Wno-format-security -std=gnu89 -mno-sse -mno-mmx -mno-sse2 -mno-3dnow -mno-avx -m64 -falign-jumps=1 -falign-loops=1 -mno-80387 -mno-fp-ret-in-387 -mpreferred-stack-boundary=3 -mskip-rax-setup -mtune=generic -mno-red-zone -mcmodel=kernel -DCONFIG_X86_X32_ABI -Wno-sign-compare -fno-asynchronous-unwind-tables -mindirect-branch=thunk-extern -mindirect-branch-register -fno-jump-tables -fno-delete-null-pointer-checks -Wno-frame-address -Wno-format-truncation -Wno-format-overflow -Wno-address-of-packed-member -O2 -fno-allow-store-data-races -Wframe-larger-than=2048 -fstack-protector-strong -Wno-unused-but-set-variable -Wimplicit-fallthrough -Wno-unused-const-variable -g -pg -mrecord-mcount -mfentry -DCC_USING_FENTRY -Wdeclaration-after-statement -Wvla -Wno-pointer-sign -Wno-stringop-truncation -Wno-zero-length-bounds -Wno-array-bounds -Wno-stringop-overflow -Wno-restrict -Wno-maybe-uninitialized -fno-strict-overflow -fno-stack-check -fconserve-stack -Werror=date-time -Werror=incompatible-pointer-types -Werror=designated-init -fcf-protection=none -Wno-packed-not-aligned  -DMODULE  -DKBUILD_BASENAME=&#39;&quot;k_m1&quot;&#39; -DKBUILD_MODNAME=&#39;&quot;k_m&quot;&#39; -c -o /root/for_work/rootkit/demo1/k_mod/k_m1.o /root/for_work/rootkit/demo1/k_mod/k_m1.c; scripts/basic/fixdep /root/for_work/rootkit/demo1/k_mod/.k_m1.o.d /root/for_work/rootkit/demo1/k_mod/k_m1.o &#39;gcc -Wp,-MMD,/root/for_work/rootkit/demo1/k_mod/.k_m1.o.d -nostdinc -isystem /usr/lib/gcc/x86_64-linux-gnu/10/include -I./arch/x86/include -I./arch/x86/include/generated  -I./include -I./arch/x86/include/uapi -I./arch/x86/include/generated/uapi -I./include/uapi -I./include/generated/uapi -include ./include/linux/kconfig.h -include ./include/linux/compiler_types.h -D__KERNEL__ -fmacro-prefix-map=./= -Wall -Wundef -Werror=strict-prototypes -Wno-trigraphs -fno-strict-aliasing -fno-common -fshort-wchar -fno-PIE -Werror=implicit-function-declaration -Werror=implicit-int -Werror=return-type -Wno-format-security -std=gnu89 -mno-sse -mno-mmx -mno-sse2 -mno-3dnow -mno-avx -m64 -falign-jumps=1 -falign-loops=1 -mno-80387 -mno-fp-ret-in-387 -mpreferred-stack-boundary=3 -mskip-rax-setup -mtune=generic -mno-red-zone -mcmodel=kernel -DCONFIG_X86_X32_ABI -Wno-sign-compare -fno-asynchronous-unwind-tables -mindirect-branch=thunk-extern -mindirect-branch-register -fno-jump-tables -fno-delete-null-pointer-checks -Wno-frame-address -Wno-format-truncation -Wno-format-overflow -Wno-address-of-packed-member -O2 -fno-allow-store-data-races -Wframe-larger-than=2048 -fstack-protector-strong -Wno-unused-but-set-variable -Wimplicit-fallthrough -Wno-unused-const-variable -g -pg -mrecord-mcount -mfentry -DCC_USING_FENTRY -Wdeclaration-after-statement -Wvla -Wno-pointer-sign -Wno-stringop-truncation -Wno-zero-length-bounds -Wno-array-bounds -Wno-stringop-overflow -Wno-restrict -Wno-maybe-uninitialized -fno-strict-overflow -fno-stack-check -fconserve-stack -Werror=date-time -Werror=incompatible-pointer-types -Werror=designated-init -fcf-protection=none -Wno-packed-not-aligned  -DMODULE  -DKBUILD_BASENAME=&#39;\&#39;&#39;&quot;k_m1&quot;&#39;\&#39;&#39; -DKBUILD_MODNAME=&#39;\&#39;&#39;&quot;k_m&quot;&#39;\&#39;&#39; -c -o /root/for_work/rootkit/demo1/k_mod/k_m1.o /root/for_work/rootkit/demo1/k_mod/k_m1.c&#39; &gt; /root/for_work/rootkit/demo1/k_mod/.k_m1.o.cmd; rm -f /root/for_work/rootkit/demo1/k_mod/.k_m1.o.d
            @set -e
  CC [M]  /root/for_work/rootkit/demo1/k_mod/k_m1.o
</pre></div>
</td></tr></table></div>
</div>
<p>注意其中的中间文件:.k_m1.o.d  .k_m1.o.cmd k_m1.o,其force_checksrc展开为(此处没有使能):</p>
<div class="literal-block-wrapper docutils container" id="id44">
<div class="code-block-caption"><span class="caption-text">代码片段</span><a class="headerlink" href="#id44" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>        <span class="n">sparse</span> <span class="o">-</span><span class="n">D__linux__</span> <span class="o">-</span><span class="n">Dlinux</span> <span class="o">-</span><span class="n">D__STDC__</span> <span class="o">-</span><span class="n">Dunix</span> <span class="o">-</span><span class="n">D__unix__</span> <span class="o">-</span><span class="n">Wbitwise</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="k">return</span><span class="o">-</span><span class="kt">void</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">attribute</span> <span class="o">-</span><span class="n">D__x86_64__</span> <span class="o">--</span><span class="n">arch</span><span class="o">=</span><span class="n">x86</span> <span class="o">-</span><span class="n">mlittle</span><span class="o">-</span><span class="n">endian</span> <span class="o">-</span><span class="n">m64</span> <span class="o">-</span><span class="n">Wp</span><span class="p">,</span><span class="o">-</span><span class="n">MMD</span><span class="p">,</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">for_work</span><span class="o">/</span><span class="n">rootkit</span><span class="o">/</span><span class="n">demo1</span><span class="o">/</span><span class="n">k_mod</span><span class="o">/</span><span class="p">.</span><span class="n">k_m2</span><span class="p">.</span><span class="n">o</span><span class="p">.</span><span class="n">d</span> <span class="o">-</span><span class="n">nostdinc</span> <span class="o">-</span><span class="n">isystem</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span><span class="n">include</span> <span class="o">-</span><span class="n">I</span><span class="p">.</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">include</span> <span class="o">-</span><span class="n">I</span><span class="p">.</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">generated</span> <span class="o">-</span><span class="n">I</span><span class="p">.</span><span class="o">/</span><span class="n">include</span> <span class="o">-</span><span class="n">I</span><span class="p">.</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">uapi</span> <span class="o">-</span><span class="n">I</span><span class="p">.</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">generated</span><span class="o">/</span><span class="n">uapi</span> <span class="o">-</span><span class="n">I</span><span class="p">.</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">uapi</span> <span class="o">-</span><span class="n">I</span><span class="p">.</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">generated</span><span class="o">/</span><span class="n">uapi</span> <span class="o">-</span><span class="n">include</span> <span class="p">.</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">kconfig</span><span class="p">.</span><span class="n">h</span> <span class="o">-</span><span class="n">include</span> <span class="p">.</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">compiler_types</span><span class="p">.</span><span class="n">h</span> <span class="o">-</span><span class="n">D__KERNEL__</span> <span class="o">-</span><span class="n">fmacro</span><span class="o">-</span><span class="n">prefix</span><span class="o">-</span><span class="n">map</span><span class="o">=</span><span class="p">.</span><span class="o">/=</span> <span class="o">-</span><span class="n">Wall</span> <span class="o">-</span><span class="n">Wundef</span> <span class="o">-</span><span class="n">Werror</span><span class="o">=</span><span class="n">strict</span><span class="o">-</span><span class="n">prototypes</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">trigraphs</span> <span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">strict</span><span class="o">-</span><span class="n">aliasing</span> <span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">common</span> <span class="o">-</span><span class="n">fshort</span><span class="o">-</span><span class="n">wchar</span> <span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">PIE</span> <span class="o">-</span><span class="n">Werror</span><span class="o">=</span><span class="n">implicit</span><span class="o">-</span><span class="n">function</span><span class="o">-</span><span class="n">declaration</span> <span class="o">-</span><span class="n">Werror</span><span class="o">=</span><span class="n">implicit</span><span class="o">-</span><span class="kt">int</span> <span class="o">-</span><span class="n">Werror</span><span class="o">=</span><span class="k">return</span><span class="o">-</span><span class="n">type</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">format</span><span class="o">-</span><span class="n">security</span> <span class="o">-</span><span class="n">std</span><span class="o">=</span><span class="n">gnu89</span> <span class="o">-</span><span class="n">mno</span><span class="o">-</span><span class="n">sse</span> <span class="o">-</span><span class="n">mno</span><span class="o">-</span><span class="n">mmx</span> <span class="o">-</span><span class="n">mno</span><span class="o">-</span><span class="n">sse2</span> <span class="o">-</span><span class="n">mno</span><span class="mi">-3</span><span class="n">dnow</span> <span class="o">-</span><span class="n">mno</span><span class="o">-</span><span class="n">avx</span> <span class="o">-</span><span class="n">m64</span> <span class="o">-</span><span class="n">falign</span><span class="o">-</span><span class="n">jumps</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span><span class="n">falign</span><span class="o">-</span><span class="n">loops</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span><span class="n">mno</span><span class="mi">-80387</span> <span class="o">-</span><span class="n">mno</span><span class="o">-</span><span class="n">fp</span><span class="o">-</span><span class="n">ret</span><span class="o">-</span><span class="n">in</span><span class="mi">-387</span> <span class="o">-</span><span class="n">mpreferred</span><span class="o">-</span><span class="n">stack</span><span class="o">-</span><span class="n">boundary</span><span class="o">=</span><span class="mi">3</span> <span class="o">-</span><span class="n">mskip</span><span class="o">-</span><span class="n">rax</span><span class="o">-</span><span class="n">setup</span> <span class="o">-</span><span class="n">mtune</span><span class="o">=</span><span class="n">generic</span> <span class="o">-</span><span class="n">mno</span><span class="o">-</span><span class="n">red</span><span class="o">-</span><span class="n">zone</span> <span class="o">-</span><span class="n">mcmodel</span><span class="o">=</span><span class="n">kernel</span> <span class="o">-</span><span class="n">DCONFIG_X86_X32_ABI</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">sign</span><span class="o">-</span><span class="n">compare</span> <span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">asynchronous</span><span class="o">-</span><span class="n">unwind</span><span class="o">-</span><span class="n">tables</span> <span class="o">-</span><span class="n">mindirect</span><span class="o">-</span><span class="n">branch</span><span class="o">=</span><span class="n">thunk</span><span class="o">-</span><span class="k">extern</span> <span class="o">-</span><span class="n">mindirect</span><span class="o">-</span><span class="n">branch</span><span class="o">-</span><span class="k">register</span> <span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">jump</span><span class="o">-</span><span class="n">tables</span> <span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">delete</span><span class="o">-</span><span class="n">null</span><span class="o">-</span><span class="n">pointer</span><span class="o">-</span><span class="n">checks</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">frame</span><span class="o">-</span><span class="n">address</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">format</span><span class="o">-</span><span class="n">truncation</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">format</span><span class="o">-</span><span class="n">overflow</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">address</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">packed</span><span class="o">-</span><span class="n">member</span> <span class="o">-</span><span class="n">O2</span> <span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">allow</span><span class="o">-</span><span class="n">store</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="n">races</span> <span class="o">-</span><span class="n">Wframe</span><span class="o">-</span><span class="n">larger</span><span class="o">-</span><span class="n">than</span><span class="o">=</span><span class="mi">2048</span> <span class="o">-</span><span class="n">fstack</span><span class="o">-</span><span class="n">protector</span><span class="o">-</span><span class="n">strong</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">unused</span><span class="o">-</span><span class="n">but</span><span class="o">-</span><span class="n">set</span><span class="o">-</span><span class="n">variable</span> <span class="o">-</span><span class="n">Wimplicit</span><span class="o">-</span><span class="n">fallthrough</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">unused</span><span class="o">-</span><span class="k">const</span><span class="o">-</span><span class="n">variable</span> <span class="o">-</span><span class="n">g</span> <span class="o">-</span><span class="n">pg</span> <span class="o">-</span><span class="n">mrecord</span><span class="o">-</span><span class="n">mcount</span> <span class="o">-</span><span class="n">mfentry</span> <span class="o">-</span><span class="n">DCC_USING_FENTRY</span> <span class="o">-</span><span class="n">Wdeclaration</span><span class="o">-</span><span class="n">after</span><span class="o">-</span><span class="n">statement</span> <span class="o">-</span><span class="n">Wvla</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">pointer</span><span class="o">-</span><span class="n">sign</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">stringop</span><span class="o">-</span><span class="n">truncation</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">zero</span><span class="o">-</span><span class="n">length</span><span class="o">-</span><span class="n">bounds</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">array</span><span class="o">-</span><span class="n">bounds</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">stringop</span><span class="o">-</span><span class="n">overflow</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="kr">restrict</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">maybe</span><span class="o">-</span><span class="n">uninitialized</span> <span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">strict</span><span class="o">-</span><span class="n">overflow</span> <span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">stack</span><span class="o">-</span><span class="n">check</span> <span class="o">-</span><span class="n">fconserve</span><span class="o">-</span><span class="n">stack</span> <span class="o">-</span><span class="n">Werror</span><span class="o">=</span><span class="n">date</span><span class="o">-</span><span class="n">time</span> <span class="o">-</span><span class="n">Werror</span><span class="o">=</span><span class="n">incompatible</span><span class="o">-</span><span class="n">pointer</span><span class="o">-</span><span class="n">types</span> <span class="o">-</span><span class="n">Werror</span><span class="o">=</span><span class="n">designated</span><span class="o">-</span><span class="n">init</span> <span class="o">-</span><span class="n">fcf</span><span class="o">-</span><span class="n">protection</span><span class="o">=</span><span class="n">none</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">packed</span><span class="o">-</span><span class="n">not</span><span class="o">-</span><span class="n">aligned</span> <span class="o">-</span><span class="n">DMODULE</span> <span class="o">-</span><span class="n">DKBUILD_BASENAME</span><span class="o">=</span><span class="s">&quot;k_m2&quot;</span> <span class="o">-</span><span class="n">DKBUILD_MODNAME</span><span class="o">=</span><span class="s">&quot;k_m&quot;</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">for_work</span><span class="o">/</span><span class="n">rootkit</span><span class="o">/</span><span class="n">demo1</span><span class="o">/</span><span class="n">k_mod</span><span class="o">/</span><span class="n">k_m2</span><span class="p">.</span><span class="n">c</span> <span class="n">force</span>
</pre></div>
</td></tr></table></div>
</div>
<p>k_m1.o k_m2.o链接为k_m.o,根据k_m.o 产生k_m.mod  modules.order:依赖 k_m.o</p>
<div class="literal-block-wrapper docutils container" id="id45">
<div class="code-block-caption"><span class="caption-text">代码片段</span><a class="headerlink" href="#id45" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span># Rule to create modules.order file
#
# Create commands to either record .ko file or cat modules.order from
<span class="hll"># a subdirectory
</span><span class="hll"># Add $(obj-m) as the prerequisite to avoid updating the timestamp of
</span># modules.order unless contained modules are updated.
cmd_modules_order = { $(foreach m, $(real-prereqs), \
        $(if $(filter %/modules.order, $m), cat $m, echo $(patsubst %.o,%.ko,$m));) :; } \
             | $(AWK) &#39;!x[$$0]++&#39; - &gt; $@
        $(obj)/modules.order: $(obj-m) FORCE
                $(call if_changed,modules_order)
</pre></div>
</td></tr></table></div>
</div>
<p>产生modules.order,至此完成Makefile中modules前提条件$(MODORDER) 的处理.
Makefile modules 菜单指令:</p>
<div class="literal-block-wrapper docutils container" id="id46">
<div class="code-block-caption"><span class="caption-text">代码片段</span><a class="headerlink" href="#id46" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nl">modules</span><span class="p">:</span> <span class="n">$</span><span class="p">(</span><span class="n">MODORDER</span><span class="p">)</span>
        <span class="n">$</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span><span class="n">$</span><span class="p">(</span><span class="n">MAKE</span><span class="p">)</span> <span class="o">-</span><span class="n">f</span> <span class="n">$</span><span class="p">(</span><span class="n">srctree</span><span class="p">)</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">Makefile</span><span class="p">.</span><span class="n">modpost</span>
</pre></div>
</td></tr></table></div>
</div>
</li>
<li><p>即接下来看指令 make -f Makefile.modpost
Makefile.modpost编译外部模块内容</p>
<div class="literal-block-wrapper docutils container" id="id47">
<div class="code-block-caption"><span class="caption-text">代码片段</span><a class="headerlink" href="#id47" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53</pre></div></td><td class="code"><div class="highlight"><pre><span></span>__modpost:
include include/config/auto.conf
include scripts/Kbuild.include
<span class="hll">
</span><span class="hll">MODPOST = scripts/mod/modpost                                                           \
</span>        $(if $(CONFIG_MODVERSIONS),-m)                                                  \
        $(if $(CONFIG_MODULE_SRCVERSION_ALL),-a)                                        \
        $(if $(CONFIG_SECTION_MISMATCH_WARN_ONLY),,-E)                                  \
        $(if $(KBUILD_MODPOST_WARN),-w) \
        -o $@
# set src + obj - they may be used in the modules&#39;s Makefile
obj := $(KBUILD_EXTMOD)
src := $(obj)

# Include the module&#39;s Makefile to find KBUILD_EXTRA_SYMBOLS
include $(if $(wildcard $(KBUILD_EXTMOD)/Kbuild), \
             $(KBUILD_EXTMOD)/Kbuild, $(KBUILD_EXTMOD)/Makefile)

# modpost option for external modules
MODPOST += -e

input-symdump := Module.symvers $(KBUILD_EXTRA_SYMBOLS)
output-symdump := $(KBUILD_EXTMOD)/Module.symvers
# modpost options for modules (both in-kernel and external)
MODPOST += \
        $(addprefix -i ,$(wildcard $(input-symdump))) \
        $(if $(KBUILD_NSDEPS),-d $(MODULES_NSDEPS)) \
        $(if $(CONFIG_MODULE_ALLOW_MISSING_NAMESPACE_IMPORTS)$(KBUILD_NSDEPS),-N)
# &#39;make -i -k&#39; ignores compile errors, and builds as many modules as possible.
ifneq ($(findstring i,$(filter-out --%,$(MAKEFLAGS))),)
MODPOST += -n
endif

# Clear VPATH to not search for *.symvers in $(srctree). Check only $(objtree).
VPATH :=
$(input-symdump):
        @echo &gt;&amp;2 &#39;WARNING: Symbol version dump &quot;$@&quot; is missing.&#39;
        @echo &gt;&amp;2 &#39;         Modules may not have dependencies or modversions.&#39;

# Read out modules.order to pass in modpost.
# Otherwise, allmodconfig would fail with &quot;Argument list too long&quot;.
quiet_cmd_modpost = MODPOST $@
         cmd_modpost = sed &#39;s/ko$$/o/&#39; $&lt; | $(MODPOST) -T -

 $(output-symdump): $(MODORDER) $(input-symdump) FORCE
        $(call if_changed,modpost)

targets += $(output-symdump)

__modpost: $(output-symdump)
ifneq ($(KBUILD_MODPOST_NOFINAL),1)
        $(Q)$(MAKE) -f $(srctree)/scripts/Makefile.modfinal :这一步通常情况下是要执行的
endif
</pre></div>
</td></tr></table></div>
</div>
<ol class="arabic">
<li><p>第一步
1. 创建单独的.o文件(如生成k_m1.o k_m2.o)
2. 链接需要的.o 文件为&lt;module&gt;.o 文件(k_m1.o k_m2.o 链接为k_m.o)
3. 生成&lt;module&gt;.mod文件,列出了初步的.o文件,(如k_m1.o k_m2.o)
4. modules.order:列出所有的模块(k_m.ko)</p></li>
<li><p>第二步
1. 查找所有在modules.order中列出的模块</p></li>
<li><p>第三步:修改模块ELF节中的信息,包含以下几个方面:与.mod.c相关
1. Version magic(include/linux/vermagic.h来获取细节)</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Kernel release</p></li>
<li><p>SMP is CONFIG_SMP</p></li>
<li><p>PREEMPT is CONFIG_PREEMPT[_RT]</p></li>
<li><p>GCC Version</p></li>
</ol>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>Module info
1. Module version(MODULE_VERSION)
2. Module alias’es(MODULE_ALIAS)
3. Module license(MODULE_LICENSE)
4. 参考include/linux/module.h来获取更多哦细节</p></li>
</ol>
</li>
<li><p>第四步:仅用于允许外部模块中的模块版本控制，其中每个模块的 CRC 从 Module.symvers 文件中检索</p></li>
<li><p>Makefile.modpost参数设置:
KBUILD_MODPOST_WARN:可以设置以避免在最终模块链接阶段出现未定义符号时出错.
KBUILD_MODPOST_NOFINAL:可以设置用于忽略最后的模块链接.</p></li>
</ol>
<p>目前为止,我们完成了第一步,已经产生文件:k_m1.o k_m2.o k_m.o k_m.mod modules.order 现在进入第二步.
Makefile.modpost关键信息:</p>
<div class="literal-block-wrapper docutils container" id="id48">
<div class="code-block-caption"><span class="caption-text">代码片段</span><a class="headerlink" href="#id48" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span>$(output-symdump): $(MODORDER) $(input-symdump) FORCE
        $(call if_changed,modpost)

<span class="hll">targets += $(output-symdump)
</span><span class="hll">
</span>__modpost: $(output-symdump)
ifneq ($(KBUILD_MODPOST_NOFINAL),1)
        $(Q)$(MAKE) -f $(srctree)/scripts/Makefile.modfinal :这一步通常情况下是要执行的
endif
</pre></div>
</td></tr></table></div>
</div>
<p>$(output-symdump)定义:</p>
<div class="literal-block-wrapper docutils container" id="id49">
<div class="code-block-caption"><span class="caption-text">代码片段</span><a class="headerlink" href="#id49" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">$</span><span class="p">(</span><span class="n">output</span><span class="o">-</span><span class="n">symdump</span><span class="p">)</span><span class="o">:</span> <span class="n">$</span><span class="p">(</span><span class="n">MODORDER</span><span class="p">)</span> <span class="n">$</span><span class="p">(</span><span class="n">input</span><span class="o">-</span><span class="n">symdump</span><span class="p">)</span> <span class="n">FORCE</span>
        <span class="n">$</span><span class="p">(</span><span class="n">call</span> <span class="n">if_changed</span><span class="p">,</span><span class="n">modpost</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<p>等价于:</p>
<div class="literal-block-wrapper docutils container" id="id50">
<div class="code-block-caption"><span class="caption-text">代码片段</span><a class="headerlink" href="#id50" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">k_mod</span><span class="o">/</span><span class="n">Module</span><span class="p">.</span><span class="nl">symvers</span><span class="p">:</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">kmod</span><span class="o">/</span><span class="n">modules</span><span class="p">.</span><span class="n">order</span> <span class="n">Module</span><span class="p">.</span><span class="n">symvers</span>
        <span class="n">scripts</span><span class="o">/</span><span class="n">mod</span><span class="o">/</span><span class="n">modpost</span> <span class="o">-</span><span class="n">m</span> <span class="o">-</span><span class="n">o</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">k_mod</span><span class="o">/</span><span class="n">Module</span><span class="p">.</span><span class="n">symvers</span> <span class="o">-</span><span class="n">e</span> <span class="o">-</span><span class="n">i</span> <span class="n">Module</span><span class="p">.</span><span class="n">symvers</span> <span class="o">-</span><span class="n">T</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">k_mod</span><span class="o">/</span><span class="n">k_m</span><span class="p">.</span><span class="n">o</span>
</pre></div>
</td></tr></table></div>
</div>
<ol class="arabic simple">
<li><p>Module.symvers:内核代码树文件,已经有了</p></li>
<li><p>/path/kmod/modules.order:第一步中已经产生</p></li>
<li><p>/path/k_mod/k_m.o: 第一步已经产生</p></li>
<li><p>Module.symvers由指令 scripts/mod/modpost -m -o /path/k_mod/Module.symvers -e -i Module.symvers -T /path/k_mod/k_m.o产生.执行过程中产生文件 k_m.mod.c (scripts/mod/modpost.c代码段如下:),并产生 /path/k_mod/Module.symvers文件.</p></li>
</ol>
<div class="literal-block-wrapper docutils container" id="id51">
<div class="code-block-caption"><span class="caption-text">scripts/mod/modpost.c中相关代码片段</span><a class="headerlink" href="#id51" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span>                <span class="n">err</span> <span class="o">|=</span> <span class="n">check_modname_len</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span>
                <span class="n">err</span> <span class="o">|=</span> <span class="n">check_exports</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span>

<span class="hll">                <span class="n">add_header</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="n">mod</span><span class="p">);</span>
</span><span class="hll">                <span class="n">add_intree_flag</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="o">!</span><span class="n">external_module</span><span class="p">);</span>
</span>                <span class="n">add_retpoline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
                <span class="n">add_staging_flag</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
                <span class="n">err</span> <span class="o">|=</span> <span class="n">add_versions</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="n">mod</span><span class="p">);</span>
                <span class="n">add_depends</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="n">mod</span><span class="p">);</span>
                <span class="n">add_moddevtable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="n">mod</span><span class="p">);</span>
                <span class="n">add_srcversion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="n">mod</span><span class="p">);</span>

                <span class="n">sprintf</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s">&quot;%s.mod.c&quot;</span><span class="p">,</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
                <span class="n">write_if_changed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="n">fname</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
</li>
<li><p>最后一步产生最终的内核模块文件:make -f Makefile.modfinal</p></li>
</ol>
<blockquote>
<div><p>$(MAKE) -f $(srctree)/scripts/Makefile.modfinal,目前已经产生的文件有:k_m1.o k_m2.o k_m.o k_m.mod modules.order   Module.symvers  k_m.mod.c</p>
<div class="literal-block-wrapper docutils container" id="id52">
<div class="code-block-caption"><span class="caption-text">代码片段</span><a class="headerlink" href="#id52" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span>__modfinal: $(modules)
        @:
</pre></div>
</td></tr></table></div>
</div>
<p>等价于</p>
<div class="literal-block-wrapper docutils container" id="id53">
<div class="code-block-caption"><span class="caption-text">代码片段</span><a class="headerlink" href="#id53" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span>__modfinal:/path/k_mod/k_m.ko
        @:
</pre></div>
</td></tr></table></div>
</div>
<p>进一步依赖</p>
<div class="literal-block-wrapper docutils container" id="id54">
<div class="code-block-caption"><span class="caption-text">代码片段</span><a class="headerlink" href="#id54" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">$</span><span class="p">(</span><span class="n">modules</span><span class="p">)</span><span class="o">:</span> <span class="o">%</span><span class="p">.</span><span class="nl">ko</span><span class="p">:</span> <span class="o">%</span><span class="p">.</span><span class="n">o</span> <span class="o">%</span><span class="p">.</span><span class="n">mod</span><span class="p">.</span><span class="n">o</span> <span class="n">$</span><span class="p">(</span><span class="n">ARCH_MODULE_LDS</span><span class="p">)</span> <span class="n">FORCE</span>
        <span class="o">+</span><span class="n">$</span><span class="p">(</span><span class="n">call</span> <span class="n">if_changed</span><span class="p">,</span><span class="n">ld_ko_o</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<p>等价于</p>
<div class="literal-block-wrapper docutils container" id="id55">
<div class="code-block-caption"><span class="caption-text">代码片段</span><a class="headerlink" href="#id55" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">k_m</span><span class="p">.</span><span class="nl">ko</span><span class="p">:</span> <span class="n">k_m</span><span class="p">.</span><span class="nl">ko</span><span class="p">:</span> <span class="n">k_m</span><span class="p">.</span><span class="n">o</span> <span class="n">k_m</span><span class="p">.</span><span class="n">mod</span><span class="p">.</span><span class="n">o</span> <span class="n">scripts</span><span class="o">/</span><span class="n">module</span><span class="p">.</span><span class="n">lds</span> <span class="n">FORCE</span>
        <span class="n">ld</span> <span class="o">-</span><span class="n">r</span> <span class="o">-</span><span class="n">m</span> <span class="n">elf_x86_64</span> <span class="o">--</span><span class="n">build</span><span class="o">-</span><span class="n">id</span><span class="o">=</span><span class="n">sha1</span> <span class="o">-</span><span class="n">T</span> <span class="n">scripts</span><span class="o">/</span><span class="n">module</span><span class="p">.</span><span class="n">lds</span> <span class="o">-</span><span class="n">o</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">for_work</span><span class="o">/</span><span class="n">rootkit</span><span class="o">/</span><span class="n">demo1</span><span class="o">/</span><span class="n">k_mod</span><span class="o">/</span><span class="n">k_m</span><span class="p">.</span><span class="n">ko</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">for_work</span><span class="o">/</span><span class="n">rootkit</span><span class="o">/</span><span class="n">demo1</span><span class="o">/</span><span class="n">k_mod</span><span class="o">/</span><span class="n">k_m</span><span class="p">.</span><span class="n">o</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">for_work</span><span class="o">/</span><span class="n">rootkit</span><span class="o">/</span><span class="n">demo1</span><span class="o">/</span><span class="n">k_mod</span><span class="o">/</span><span class="n">k_m</span><span class="p">.</span><span class="n">mod</span><span class="p">.</span><span class="n">o</span>
</pre></div>
</td></tr></table></div>
</div>
<p>其中k_m.o scripts/module.lds都已经存在,只需要关注k_m.mo.o</p>
<div class="literal-block-wrapper docutils container" id="id56">
<div class="code-block-caption"><span class="caption-text">代码片段</span><a class="headerlink" href="#id56" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span>quiet_cmd_cc_o_c = CC [M]  $@
    cmd_cc_o_c = $(CC) $(c_flags) -c -o $@ $&lt;
</pre></div>
</td></tr></table></div>
</div>
<dl class="simple">
<dt>%.mod.o: %.mod.c FORCE</dt><dd><p>$(call if_changed_dep,cc_o_c)</p>
</dd>
</dl>
<p>等价于</p>
<div class="literal-block-wrapper docutils container" id="id57">
<div class="code-block-caption"><span class="caption-text">代码片段</span><a class="headerlink" href="#id57" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">k_m</span><span class="p">.</span><span class="n">mod</span><span class="p">.</span><span class="nl">o</span><span class="p">:</span> <span class="n">k_m</span><span class="p">.</span><span class="n">mod</span><span class="p">.</span><span class="n">c</span> <span class="n">FORCE</span>
        <span class="n">gcc</span> <span class="o">-</span><span class="n">Wp</span><span class="p">,</span><span class="o">-</span><span class="n">MMD</span><span class="p">,</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">for_work</span><span class="o">/</span><span class="n">rootkit</span><span class="o">/</span><span class="n">demo1</span><span class="o">/</span><span class="n">k_mod</span><span class="o">/</span><span class="p">.</span><span class="n">k_m</span><span class="p">.</span><span class="n">mod</span><span class="p">.</span><span class="n">o</span><span class="p">.</span><span class="n">d</span> <span class="o">-</span><span class="n">nostdinc</span> <span class="o">-</span><span class="n">isystem</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span><span class="n">include</span> <span class="o">-</span><span class="n">I</span><span class="p">.</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">include</span> <span class="o">-</span><span class="n">I</span><span class="p">.</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">generated</span> <span class="o">-</span><span class="n">I</span><span class="p">.</span><span class="o">/</span><span class="n">include</span> <span class="o">-</span><span class="n">I</span><span class="p">.</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">uapi</span> <span class="o">-</span><span class="n">I</span><span class="p">.</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">generated</span><span class="o">/</span><span class="n">uapi</span> <span class="o">-</span><span class="n">I</span><span class="p">.</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">uapi</span> <span class="o">-</span><span class="n">I</span><span class="p">.</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">generated</span><span class="o">/</span><span class="n">uapi</span> <span class="o">-</span><span class="n">include</span> <span class="p">.</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">kconfig</span><span class="p">.</span><span class="n">h</span> <span class="o">-</span><span class="n">include</span> <span class="p">.</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">compiler_types</span><span class="p">.</span><span class="n">h</span> <span class="o">-</span><span class="n">D__KERNEL__</span> <span class="o">-</span><span class="n">fmacro</span><span class="o">-</span><span class="n">prefix</span><span class="o">-</span><span class="n">map</span><span class="o">=</span><span class="p">.</span><span class="o">/=</span> <span class="o">-</span><span class="n">Wall</span> <span class="o">-</span><span class="n">Wundef</span> <span class="o">-</span><span class="n">Werror</span><span class="o">=</span><span class="n">strict</span><span class="o">-</span><span class="n">prototypes</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">trigraphs</span> <span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">strict</span><span class="o">-</span><span class="n">aliasing</span> <span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">common</span> <span class="o">-</span><span class="n">fshort</span><span class="o">-</span><span class="n">wchar</span> <span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">PIE</span> <span class="o">-</span><span class="n">Werror</span><span class="o">=</span><span class="n">implicit</span><span class="o">-</span><span class="n">function</span><span class="o">-</span><span class="n">declaration</span> <span class="o">-</span><span class="n">Werror</span><span class="o">=</span><span class="n">implicit</span><span class="o">-</span><span class="kt">int</span> <span class="o">-</span><span class="n">Werror</span><span class="o">=</span><span class="k">return</span><span class="o">-</span><span class="n">type</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">format</span><span class="o">-</span><span class="n">security</span> <span class="o">-</span><span class="n">std</span><span class="o">=</span><span class="n">gnu89</span> <span class="o">-</span><span class="n">mno</span><span class="o">-</span><span class="n">sse</span> <span class="o">-</span><span class="n">mno</span><span class="o">-</span><span class="n">mmx</span> <span class="o">-</span><span class="n">mno</span><span class="o">-</span><span class="n">sse2</span> <span class="o">-</span><span class="n">mno</span><span class="mi">-3</span><span class="n">dnow</span> <span class="o">-</span><span class="n">mno</span><span class="o">-</span><span class="n">avx</span> <span class="o">-</span><span class="n">m64</span> <span class="o">-</span><span class="n">falign</span><span class="o">-</span><span class="n">jumps</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span><span class="n">falign</span><span class="o">-</span><span class="n">loops</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span><span class="n">mno</span><span class="mi">-80387</span> <span class="o">-</span><span class="n">mno</span><span class="o">-</span><span class="n">fp</span><span class="o">-</span><span class="n">ret</span><span class="o">-</span><span class="n">in</span><span class="mi">-387</span> <span class="o">-</span><span class="n">mpreferred</span><span class="o">-</span><span class="n">stack</span><span class="o">-</span><span class="n">boundary</span><span class="o">=</span><span class="mi">3</span> <span class="o">-</span><span class="n">mskip</span><span class="o">-</span><span class="n">rax</span><span class="o">-</span><span class="n">setup</span> <span class="o">-</span><span class="n">mtune</span><span class="o">=</span><span class="n">generic</span> <span class="o">-</span><span class="n">mno</span><span class="o">-</span><span class="n">red</span><span class="o">-</span><span class="n">zone</span> <span class="o">-</span><span class="n">mcmodel</span><span class="o">=</span><span class="n">kernel</span> <span class="o">-</span><span class="n">DCONFIG_X86_X32_ABI</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">sign</span><span class="o">-</span><span class="n">compare</span> <span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">asynchronous</span><span class="o">-</span><span class="n">unwind</span><span class="o">-</span><span class="n">tables</span> <span class="o">-</span><span class="n">mindirect</span><span class="o">-</span><span class="n">branch</span><span class="o">=</span><span class="n">thunk</span><span class="o">-</span><span class="k">extern</span> <span class="o">-</span><span class="n">mindirect</span><span class="o">-</span><span class="n">branch</span><span class="o">-</span><span class="k">register</span> <span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">jump</span><span class="o">-</span><span class="n">tables</span> <span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">delete</span><span class="o">-</span><span class="n">null</span><span class="o">-</span><span class="n">pointer</span><span class="o">-</span><span class="n">checks</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">frame</span><span class="o">-</span><span class="n">address</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">format</span><span class="o">-</span><span class="n">truncation</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">format</span><span class="o">-</span><span class="n">overflow</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">address</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">packed</span><span class="o">-</span><span class="n">member</span> <span class="o">-</span><span class="n">O2</span> <span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">allow</span><span class="o">-</span><span class="n">store</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="n">races</span> <span class="o">-</span><span class="n">Wframe</span><span class="o">-</span><span class="n">larger</span><span class="o">-</span><span class="n">than</span><span class="o">=</span><span class="mi">2048</span> <span class="o">-</span><span class="n">fstack</span><span class="o">-</span><span class="n">protector</span><span class="o">-</span><span class="n">strong</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">unused</span><span class="o">-</span><span class="n">but</span><span class="o">-</span><span class="n">set</span><span class="o">-</span><span class="n">variable</span> <span class="o">-</span><span class="n">Wimplicit</span><span class="o">-</span><span class="n">fallthrough</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">unused</span><span class="o">-</span><span class="k">const</span><span class="o">-</span><span class="n">variable</span> <span class="o">-</span><span class="n">g</span> <span class="o">-</span><span class="n">pg</span> <span class="o">-</span><span class="n">mrecord</span><span class="o">-</span><span class="n">mcount</span> <span class="o">-</span><span class="n">mfentry</span> <span class="o">-</span><span class="n">DCC_USING_FENTRY</span> <span class="o">-</span><span class="n">Wdeclaration</span><span class="o">-</span><span class="n">after</span><span class="o">-</span><span class="n">statement</span> <span class="o">-</span><span class="n">Wvla</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">pointer</span><span class="o">-</span><span class="n">sign</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">stringop</span><span class="o">-</span><span class="n">truncation</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">zero</span><span class="o">-</span><span class="n">length</span><span class="o">-</span><span class="n">bounds</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">array</span><span class="o">-</span><span class="n">bounds</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">stringop</span><span class="o">-</span><span class="n">overflow</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="kr">restrict</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">maybe</span><span class="o">-</span><span class="n">uninitialized</span> <span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">strict</span><span class="o">-</span><span class="n">overflow</span> <span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">stack</span><span class="o">-</span><span class="n">check</span> <span class="o">-</span><span class="n">fconserve</span><span class="o">-</span><span class="n">stack</span> <span class="o">-</span><span class="n">Werror</span><span class="o">=</span><span class="n">date</span><span class="o">-</span><span class="n">time</span> <span class="o">-</span><span class="n">Werror</span><span class="o">=</span><span class="n">incompatible</span><span class="o">-</span><span class="n">pointer</span><span class="o">-</span><span class="n">types</span> <span class="o">-</span><span class="n">Werror</span><span class="o">=</span><span class="n">designated</span><span class="o">-</span><span class="n">init</span> <span class="o">-</span><span class="n">fcf</span><span class="o">-</span><span class="n">protection</span><span class="o">=</span><span class="n">none</span> <span class="o">-</span><span class="n">Wno</span><span class="o">-</span><span class="n">packed</span><span class="o">-</span><span class="n">not</span><span class="o">-</span><span class="n">aligned</span> <span class="o">-</span><span class="n">DMODULE</span> <span class="o">-</span><span class="n">DKBUILD_BASENAME</span><span class="o">=</span><span class="s">&quot;k_m.mod&quot;</span> <span class="o">-</span><span class="n">DKBUILD_MODNAME</span><span class="o">=</span><span class="s">&quot;k_m&quot;</span> <span class="o">-</span><span class="n">c</span> <span class="o">-</span><span class="n">o</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">for_work</span><span class="o">/</span><span class="n">rootkit</span><span class="o">/</span><span class="n">demo1</span><span class="o">/</span><span class="n">k_mod</span><span class="o">/</span><span class="n">k_m</span><span class="p">.</span><span class="n">mod</span><span class="p">.</span><span class="n">o</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">for_work</span><span class="o">/</span><span class="n">rootkit</span><span class="o">/</span><span class="n">demo1</span><span class="o">/</span><span class="n">k_mod</span><span class="o">/</span><span class="n">k_m</span><span class="p">.</span><span class="n">mod</span><span class="p">.</span><span class="n">c</span>
</pre></div>
</td></tr></table></div>
</div>
<p>至此,内核模块编译完成,有效文件包括:k_m1.o k_m2.o k_m.o k_m.mod modules.order   Module.symvers  k_m.mod.c k_m.mod.o k_m.ko</p>
</div></blockquote>
</li>
<li><p>编译流程图</p></li>
</ol>
<img alt="../_images/module_make.svg" class="align-center" src="../_images/module_make.svg" /></div>
<div class="section" id="id9">
<h3>总结<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>对内核模块的编译过程进行流程性说明，下一章针对符号、认证、调试等信息的处理细节进行描述，会对内核模块的二进制格式进行更深入分析。</p>
</div>
</div>
<div class="section" id="id10">
<h2>内核导出符号<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id11">
<h3>模块中引用外部函数<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<p>模块中对外部符号的引用分两种：
1.内核中的导出符号：</p>
<blockquote>
<div><blockquote>
<div><div class="literal-block-wrapper docutils container" id="id58">
<div class="code-block-caption"><span class="caption-text">内核模块可引用内核到处符号</span><a class="headerlink" href="#id58" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="n">__start___ksymtab</span><span class="p">,</span> <span class="n">__stop___ksymtab</span><span class="p">,</span> <span class="n">__start___kcrctab</span><span class="p">,</span>
 <span class="n">__start___ksymtab_gpl</span><span class="p">,</span> <span class="n">__stop___ksymtab_gpl</span><span class="p">,</span><span class="n">__start___kcrctab_gpl</span><span class="p">,</span>

<span class="p">......</span>
 <span class="nl">__ksymtab</span> <span class="p">:</span> <span class="n">AT</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">__ksymtab</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0xffffffff80000000</span><span class="p">)</span> <span class="p">{</span> <span class="n">__start___ksymtab</span> <span class="o">=</span> <span class="p">.;</span> <span class="n">KEEP</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">SORT</span><span class="p">(</span><span class="n">___ksymtab</span><span class="o">+*</span><span class="p">)))</span> <span class="n">__stop___ksymtab</span> <span class="o">=</span> <span class="p">.;</span> <span class="p">}</span> <span class="nl">__ksymtab_gpl</span> <span class="p">:</span> <span class="n">AT</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">__ksymtab_gpl</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0xffffffff80000000</span><span class="p">)</span> <span class="p">{</span> <span class="n">__start___ksymtab_gpl</span> <span class="o">=</span> <span class="p">.;</span> <span class="n">KEEP</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">SORT</span><span class="p">(</span><span class="n">___ksymtab_gpl</span><span class="o">+*</span><span class="p">)))</span> <span class="n">__stop___ksymtab_gpl</span> <span class="o">=</span> <span class="p">.;</span> <span class="p">}</span> <span class="nl">__kcrctab</span> <span class="p">:</span> <span class="n">AT</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">__kcrctab</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0xffffffff80000000</span><span class="p">)</span> <span class="p">{</span> <span class="n">__start___kcrctab</span> <span class="o">=</span> <span class="p">.;</span> <span class="n">KEEP</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">SORT</span><span class="p">(</span><span class="n">___kcrctab</span><span class="o">+*</span><span class="p">)))</span> <span class="n">__stop___kcrctab</span> <span class="o">=</span> <span class="p">.;</span> <span class="p">}</span> <span class="nl">__kcrctab_gpl</span> <span class="p">:</span> <span class="n">AT</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">__kcrctab_gpl</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0xffffffff80000000</span><span class="p">)</span> <span class="p">{</span> <span class="n">__start___kcrctab_gpl</span> <span class="o">=</span> <span class="p">.;</span> <span class="n">KEEP</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">SORT</span><span class="p">(</span><span class="n">___kcrctab_gpl</span><span class="o">+*</span><span class="p">)))</span> <span class="n">__stop___kcrctab_gpl</span> <span class="o">=</span> <span class="p">.;</span> <span class="p">}</span>
<span class="p">......</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
<p>这两个节中的符号通过EXPORT_SYMBOL()和EXPORT_SYMBOL_GPL()实现。</p>
<dl>
<dt>其组织单元为：</dt><dd><div class="literal-block-wrapper docutils container" id="id59">
<div class="code-block-caption"><span class="caption-text">导出符号存储格式</span><a class="headerlink" href="#id59" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">kernel_symbol</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">value_offset</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">name_offset</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">namespace_offset</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</td></tr></table></div>
</div>
</dd>
</dl>
<p>内核链接文件为：</p>
</div></blockquote>
<dl>
<dt>2.加载进内核的其他模块中导出的符号。</dt><dd><div class="literal-block-wrapper docutils container" id="id60">
<div class="code-block-caption"><span class="caption-text">内核模块中的导出符号</span><a class="headerlink" href="#id60" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span>{ mod-&gt;syms, mod-&gt;syms + mod-&gt;num_syms, mod-&gt;crcs,
  NOT_GPL_ONLY },
{ mod-&gt;gpl_syms, mod-&gt;gpl_syms + mod-&gt;num_gpl_syms,
  mod-&gt;gpl_crcs,

具体参考函数：static int find_module_sections(struct module *mod, struct load_info *info)的解析。

模块布局参考：内核模块链接脚本: scripts/module.lds
</pre></div>
</td></tr></table></div>
</div>
</dd>
</dl>
<ul class="simple">
<li><p>总结：可被外部内核模块调用的内核符号必须是内核或其他模块显式通过EXPORT_SYMBOL_XX 系列宏导出的符号，这与内核的kallsyms符号没有关系。</p></li>
</ul>
</div>
<div class="section" id="id12">
<h3>内核模块编译过程中符号的处理<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p>demo 源文件</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id61">
<div class="code-block-caption"><span class="caption-text">k_m1.c</span><a class="headerlink" href="#id61" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;linux/kernel.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;linux/kprobes.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;linux/sched.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;./k_m.h&quot;</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="n">k_m1_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
        <span class="n">kp</span><span class="p">.</span><span class="n">pre_handler</span> <span class="o">=</span> <span class="n">handler_pre</span><span class="p">;</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">register_kprobe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kp</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;register_k_m1 failed, returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Planted k_m1 at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kp</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="n">k_m1_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">unregister_kprobe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kp</span><span class="p">);</span>
        <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;k_m1 at %p unregistered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kp</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">k_m1_init</span><span class="p">)</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">k_m1_exit</span><span class="p">)</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="literal-block-wrapper docutils container" id="id62">
<div class="code-block-caption"><span class="caption-text">k_m2.c</span><a class="headerlink" href="#id62" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;linux/kernel.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;linux/kprobes.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;linux/sched.h&gt;</span><span class="cp"></span>
<span class="cp">#define MAX_SYMBOL_LEN  64</span>
<span class="cp">#define exe_buf         &quot;ch_rootkit&quot;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">TASK_COMM_LEN</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">symbol</span><span class="p">[</span><span class="n">MAX_SYMBOL_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;start_thread&quot;</span><span class="p">;</span>
<span class="n">module_param_string</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">symbol</span><span class="p">),</span> <span class="mo">0644</span><span class="p">);</span>
<span class="k">struct</span> <span class="nc">kprobe</span> <span class="n">kp</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">symbol_name</span>    <span class="o">=</span> <span class="n">symbol</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* k_m1 pre_handler: called just before the probed instruction is executed */</span>
<span class="kt">int</span> <span class="n">__kprobes</span> <span class="n">handler_pre</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kprobe</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="nc">task_struct</span> <span class="o">*</span><span class="n">tsk</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
        <span class="n">get_task_comm</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="n">tsk</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="n">exe_buf</span><span class="p">)){</span>
                <span class="k">struct</span> <span class="nc">cred</span> <span class="o">*</span><span class="n">creds</span> <span class="o">=</span> <span class="n">prepare_creds</span><span class="p">();</span>
                <span class="n">creds</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">creds</span><span class="o">-&gt;</span><span class="n">euid</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">creds</span><span class="o">-&gt;</span><span class="n">gid</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">creds</span><span class="o">-&gt;</span><span class="n">egid</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">commit_creds</span><span class="p">(</span><span class="n">creds</span><span class="p">);</span>
                <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s:%d exec = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">handler_fault</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kprobe</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">trapnr</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;fault_handler: p-&gt;addr = 0x%p, trap #%dn&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">trapnr</span><span class="p">);</span>
        <span class="cm">/* Return 0 because we don&#39;t handle the fault. */</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* NOKPROBE_SYMBOL() is also available */</span>
<span class="n">NOKPROBE_SYMBOL</span><span class="p">(</span><span class="n">handler_fault</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">k_m1_symbol</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;for test:%s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">k_m1_symbol</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="literal-block-wrapper docutils container" id="id63">
<div class="code-block-caption"><span class="caption-text">Makefile</span><a class="headerlink" href="#id63" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">obj</span><span class="o">-</span><span class="nl">m</span> <span class="p">:</span><span class="o">=</span> <span class="n">k_m</span><span class="p">.</span><span class="n">o</span>
<span class="n">k_m</span><span class="o">-</span><span class="nl">m</span> <span class="p">:</span><span class="o">=</span> <span class="n">k_m1</span><span class="p">.</span><span class="n">o</span> <span class="n">k_m2</span><span class="p">.</span><span class="n">o</span>
        <span class="nl">KDIR</span><span class="p">:</span><span class="o">=/</span><span class="n">lib</span><span class="o">/</span><span class="n">modules</span><span class="o">/</span><span class="n">$</span><span class="p">(</span><span class="n">shell</span> <span class="n">uname</span> <span class="o">-</span><span class="n">r</span><span class="p">)</span><span class="o">/</span><span class="n">build</span>
        <span class="nl">PWD</span><span class="p">:</span><span class="o">=</span><span class="n">$</span><span class="p">(</span><span class="n">shell</span> <span class="n">pwd</span><span class="p">)</span>
<span class="k">default</span><span class="o">:</span>
        <span class="n">$</span><span class="p">(</span><span class="n">MAKE</span><span class="p">)</span> <span class="o">-</span><span class="n">C</span> <span class="n">$</span><span class="p">(</span><span class="n">KDIR</span><span class="p">)</span> <span class="n">M</span><span class="o">=</span><span class="n">$</span><span class="p">(</span><span class="n">PWD</span><span class="p">)</span> <span class="n">modules</span>
<span class="nl">clean</span><span class="p">:</span>
        <span class="n">$</span><span class="p">(</span><span class="n">MAKE</span><span class="p">)</span> <span class="o">-</span><span class="n">C</span> <span class="n">$</span><span class="p">(</span><span class="n">KDIR</span><span class="p">)</span> <span class="n">M</span><span class="o">=</span><span class="n">$</span><span class="p">(</span><span class="n">PWD</span><span class="p">)</span> <span class="n">clean</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
</li>
<li><p>重点步骤</p>
<blockquote>
<div><ul>
<li><p>k_m1.c/k_m2.c –&gt; k_m1.o/k_m2.o:</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id64">
<div class="code-block-caption"><span class="caption-text">k_m2.c</span><a class="headerlink" href="#id64" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>gcc -Wp,-MMD,/root/for_work/rootkit/demo1/k_mod/.k_m1.o.d -nostdinc -isystem /usr/lib/gcc/x86_64-linux-gnu/10/include -I./arch/x86/include -I./arch/x86/include/generated  -I./include -I./arch/x86/include/uapi -I./arch/x86/include/generated/uapi -I./include/uapi -I./include/generated/uapi -include ./include/linux/kconfig.h -include ./include/linux/compiler_types.h -D__KERNEL__ -fmacro-prefix-map=./= -Wall -Wundef -Werror=strict-prototypes -Wno-trigraphs -fno-strict-aliasing -fno-common -fshort-wchar -fno-PIE -Werror=implicit-function-declaration -Werror=implicit-int -Werror=return-type -Wno-format-security -std=gnu89 -mno-sse -mno-mmx -mno-sse2 -mno-3dnow -mno-avx -m64 -falign-jumps=1 -falign-loops=1 -mno-80387 -mno-fp-ret-in-387 -mpreferred-stack-boundary=3 -mskip-rax-setup -mtune=generic -mno-red-zone -mcmodel=kernel -DCONFIG_X86_X32_ABI -Wno-sign-compare -fno-asynchronous-unwind-tables -mindirect-branch=thunk-extern -mindirect-branch-register -fno-jump-tables -fno-delete-null-pointer-checks -Wno-frame-address -Wno-format-truncation -Wno-format-overflow -Wno-address-of-packed-member -O2 -fno-allow-store-data-races -Wframe-larger-than=2048 -fstack-protector-strong -Wno-unused-but-set-variable -Wimplicit-fallthrough -Wno-unused-const-variable -g -pg -mrecord-mcount -mfentry -DCC_USING_FENTRY -Wdeclaration-after-statement -Wvla -Wno-pointer-sign -Wno-stringop-truncation -Wno-zero-length-bounds -Wno-array-bounds -Wno-stringop-overflow -Wno-restrict -Wno-maybe-uninitialized -fno-strict-overflow -fno-stack-check -fconserve-stack -Werror=date-time -Werror=incompatible-pointer-types -Werror=designated-init -fcf-protection=none -Wno-packed-not-aligned  -DMODULE  -DKBUILD_BASENAME=&#39;&quot;k_m1&quot;&#39; -DKBUILD_MODNAME=&#39;&quot;k_m&quot;&#39; -c -o /root/for_work/rootkit/demo1/k_mod/k_m1.o /root/for_work/rootkit/demo1/k_mod/k_m1.c
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
</li>
</ul>
<blockquote>
<div><ul class="simple">
<li><p>k_m1.o + k_m2.o –&gt; k_m.o: ld -m elf_x86_64   -r -o k_m.o k_m1.o k_m2.o，其默认链接脚本(与应用软件一致,可通过ld -ve进行查看)</p></li>
</ul>
<blockquote>
<div><dl class="simple">
<dt>参数:</dt><dd><ul class="simple">
<li><p>-m elf_x86_64：</p></li>
<li><p>-r：Generate relocatable output</p></li>
<li><p>-o：</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
</div></blockquote>
<ul>
<li><p>k_m.o –&gt; Module.symvers + k_m.mod.c:输入文件:k_m.o,Module.symvers;输出文件:/path/k_mod/Module.symvers, k_m.mod.c</p>
<p>modpost.c 代码分析(根据指令:scripts/mod/modpost -m -o /path/k_mod/Module.symvers -e -i Module.symvers -T  -)进行</p>
</li>
</ul>
<div class="literal-block-wrapper docutils container" id="id65">
<div class="code-block-caption"><span class="caption-text">等价指令</span><a class="headerlink" href="#id65" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#sed &#39;s/ko$/o/&#39; modules.order | scripts/mod/modpost -m    -o /root/for_work/rootkit/demo1/k_mod/Module.symvers -e -i Module.symvers   -T -</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="literal-block-wrapper docutils container" id="id66">
<div class="code-block-caption"><span class="caption-text">modules.order</span><a class="headerlink" href="#id66" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#cat modules.order</span>
        <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">for_work</span><span class="o">/</span><span class="n">rootkit</span><span class="o">/</span><span class="n">demo1</span><span class="o">/</span><span class="n">k_mod</span><span class="o">/</span><span class="n">k_m</span><span class="p">.</span><span class="n">ko</span>
<span class="cp">#sed &#39;s/ko$/o/&#39; modules.order</span>
        <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">for_work</span><span class="o">/</span><span class="n">rootkit</span><span class="o">/</span><span class="n">demo1</span><span class="o">/</span><span class="n">k_mod</span><span class="o">/</span><span class="n">k_m</span><span class="p">.</span><span class="n">o</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
</li>
<li><p>代码分析(modpost.c):</p>
<blockquote>
<div><ul class="simple">
<li><p>重要数据结构分析:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id67">
<div class="code-block-caption"><span class="caption-text">符号结构</span><a class="headerlink" href="#id67" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nc">buffer</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
<span class="hll">        <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
</span><span class="hll"><span class="p">};</span>
</span><span class="k">struct</span> <span class="nc">symbol</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="nc">symbol</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">module</span> <span class="o">*</span><span class="n">module</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">crc</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">crc_valid</span><span class="p">;</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">namespace</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">weak</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">is_static</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>  <span class="cm">/* 1 if symbol is not global */</span>
        <span class="k">enum</span> <span class="n">export</span>  <span class="n">export</span><span class="p">;</span>       <span class="cm">/* Type of export */</span>
        <span class="kt">char</span> <span class="n">name</span><span class="p">[];</span>
<span class="p">};</span>
<span class="k">enum</span> <span class="n">export</span> <span class="p">{</span>
        <span class="n">export_plain</span><span class="p">,</span>      <span class="n">export_unused</span><span class="p">,</span>     <span class="n">export_gpl</span><span class="p">,</span>
        <span class="n">export_unused_gpl</span><span class="p">,</span> <span class="n">export_gpl_future</span><span class="p">,</span> <span class="n">export_unknown</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="nc">module</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="nc">module</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">gpl_compatible</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">symbol</span> <span class="o">*</span><span class="n">unres</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">from_dump</span><span class="p">;</span>  <span class="cm">/* 1 if module was loaded from *.symvers */</span>
        <span class="kt">int</span> <span class="n">is_vmlinux</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">seen</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">has_init</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">has_cleanup</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">buffer</span> <span class="n">dev_table_buf</span><span class="p">;</span>
        <span class="kt">char</span>         <span class="n">srcversion</span><span class="p">[</span><span class="mi">25</span><span class="p">];</span>
        <span class="c1">// Missing namespace dependencies</span>
        <span class="k">struct</span> <span class="nc">namespace_list</span> <span class="o">*</span><span class="n">missing_namespaces</span><span class="p">;</span>
        <span class="c1">// Actual imported namespaces</span>
        <span class="k">struct</span> <span class="nc">namespace_list</span> <span class="o">*</span><span class="n">imported_namespaces</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">name</span><span class="p">[];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="nc">elf_info</span> <span class="p">{</span>
        <span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
        <span class="n">Elf_Ehdr</span>     <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
        <span class="n">Elf_Shdr</span>     <span class="o">*</span><span class="n">sechdrs</span><span class="p">;</span>
        <span class="n">Elf_Sym</span>      <span class="o">*</span><span class="n">symtab_start</span><span class="p">;</span>
        <span class="n">Elf_Sym</span>      <span class="o">*</span><span class="n">symtab_stop</span><span class="p">;</span>
        <span class="n">Elf_Section</span>  <span class="n">export_sec</span><span class="p">;</span>
        <span class="n">Elf_Section</span>  <span class="n">export_unused_sec</span><span class="p">;</span>
        <span class="n">Elf_Section</span>  <span class="n">export_gpl_sec</span><span class="p">;</span>
        <span class="n">Elf_Section</span>  <span class="n">export_unused_gpl_sec</span><span class="p">;</span>
        <span class="n">Elf_Section</span>  <span class="n">export_gpl_future_sec</span><span class="p">;</span>
        <span class="kt">char</span>         <span class="o">*</span><span class="n">strtab</span><span class="p">;</span>
        <span class="kt">char</span>         <span class="o">*</span><span class="n">modinfo</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">modinfo_len</span><span class="p">;</span>

        <span class="cm">/* support for 32bit section numbers */</span>

        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_sections</span><span class="p">;</span> <span class="cm">/* max_secindex + 1 */</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">secindex_strings</span><span class="p">;</span>
        <span class="cm">/* if Nth symbol table entry has .st_shndx = SHN_XINDEX,</span>
<span class="cm">        * take shndx from symtab_shndx_start[N] instead */</span>
        <span class="n">Elf32_Word</span>   <span class="o">*</span><span class="n">symtab_shndx_start</span><span class="p">;</span>
        <span class="n">Elf32_Word</span>   <span class="o">*</span><span class="n">symtab_shndx_stop</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</td></tr></table></div>
</div>
<ul class="simple">
<li><p>流程图:</p></li>
</ul>
<img alt="../_images/modpost.svg" class="align-center" src="../_images/modpost.svg" /><ul class="simple">
<li><p>重要过程描述:</p>
<ul>
<li><p>过程分析：</p>
<ol class="arabic simple">
<li><p>读取kernelsrc/Module.symvers;</p></li>
<li><p>读取并path/k_mod/k_m.o，并对其文件中的节进行解析存储;</p></li>
<li><p>根据第2步对符号进行校验（调用符号是否可用，借助第1步读取到的信息）；</p></li>
<li><p>根据1,2两步生成的关于外部符号信息生成/path/k_mod/Module.symvers文件：</p></li>
<li><p>如果有其他内核模块编译需要用到当前模块导出的符号，则需要第4步生成的文件。</p></li>
</ol>
</li>
<li><p>k_m.mod.c：这个文件的生成是有固定的格式的，具体参考modpost.c文件。</p></li>
</ul>
</li>
</ul>
<div class="literal-block-wrapper docutils container" id="id68">
<div class="code-block-caption"><span class="caption-text">k_m.mod.c</span><a class="headerlink" href="#id68" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="cp"></span>
<span class="cp">#define INCLUDE_VERMAGIC</span>
<span class="cp">#include</span> <span class="cpf">&lt;linux/build-salt.h&gt;</span><span class="cp"></span>
<span class="hll"><span class="cp">#include</span> <span class="cpf">&lt;linux/vermagic.h&gt;</span><span class="cp"></span>
</span><span class="hll"><span class="cp">#include</span> <span class="cpf">&lt;linux/compiler.h&gt;</span><span class="cp"></span>
</span>
<span class="n">BUILD_SALT</span><span class="p">;</span>

<span class="n">MODULE_INFO</span><span class="p">(</span><span class="n">vermagic</span><span class="p">,</span> <span class="n">VERMAGIC_STRING</span><span class="p">);</span>
<span class="n">MODULE_INFO</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">);</span>

<span class="n">__visible</span> <span class="k">struct</span> <span class="nc">module</span> <span class="n">__this_module</span>
<span class="n">__section</span><span class="p">(</span><span class="s">&quot;.gnu.linkonce.this_module&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
        <span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">init_module</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_MODULE_UNLOAD</span>
        <span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">cleanup_module</span><span class="p">,</span>
<span class="cp">#endif</span>
        <span class="p">.</span><span class="n">arch</span> <span class="o">=</span> <span class="n">MODULE_ARCH_INIT</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_RETPOLINE</span>
<span class="n">MODULE_INFO</span><span class="p">(</span><span class="n">retpoline</span><span class="p">,</span> <span class="s">&quot;Y&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="nc">modversion_info</span> <span class="n">____versions</span><span class="p">[]</span>
<span class="n">__used</span> <span class="n">__section</span><span class="p">(</span><span class="s">&quot;__versions&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="c1">//解析调用的内核函数，借助导出的符号进行解析</span>
        <span class="p">{</span> <span class="mh">0x9463ffe0</span><span class="p">,</span> <span class="s">&quot;module_layout&quot;</span> <span class="p">},</span>
        <span class="p">{</span> <span class="mh">0x7f7b1cfd</span><span class="p">,</span> <span class="s">&quot;unregister_kprobe&quot;</span> <span class="p">},</span>
        <span class="p">{</span> <span class="mh">0x8c7cb666</span><span class="p">,</span> <span class="s">&quot;commit_creds&quot;</span> <span class="p">},</span>
        <span class="p">{</span> <span class="mh">0x9d447e54</span><span class="p">,</span> <span class="s">&quot;register_kprobe&quot;</span> <span class="p">},</span>
        <span class="p">{</span> <span class="mh">0xb2e20e99</span><span class="p">,</span> <span class="s">&quot;param_ops_string&quot;</span> <span class="p">},</span>
        <span class="p">{</span> <span class="mh">0x2b9c46f8</span><span class="p">,</span> <span class="s">&quot;__get_task_comm&quot;</span> <span class="p">},</span>
        <span class="p">{</span> <span class="mh">0xb44b338d</span><span class="p">,</span> <span class="s">&quot;current_task&quot;</span> <span class="p">},</span>
        <span class="p">{</span> <span class="mh">0xc5850110</span><span class="p">,</span> <span class="s">&quot;printk&quot;</span> <span class="p">},</span>
        <span class="p">{</span> <span class="mh">0x2b372d93</span><span class="p">,</span> <span class="s">&quot;prepare_creds&quot;</span> <span class="p">},</span>
        <span class="p">{</span> <span class="mh">0xbdfb6dbb</span><span class="p">,</span> <span class="s">&quot;__fentry__&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="n">MODULE_INFO</span><span class="p">(</span><span class="n">depends</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="literal-block-wrapper docutils container" id="id69">
<div class="code-block-caption"><span class="caption-text">struct modversion_info结构</span><a class="headerlink" href="#id69" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nc">modversion_info</span> <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">crc</span><span class="p">;</span><span class="cm">/* 对应地址 */</span>
        <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">MODULE_NAME_LEN</span><span class="p">];</span>
<span class="p">};</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
</li>
<li><p>k_m.mod.c到 k_m.mod.o的编译指令。</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id70">
<div class="code-block-caption"><span class="caption-text">gcc 编译指令</span><a class="headerlink" href="#id70" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span>gcc -Wp,-MMD,/root/for_work/rootkit/demo1/k_mod/.k_m.mod.o.d -nostdinc -isystem /usr/lib/gcc/x86_64-linux-gnu/10/include -I./arch/x86/include -I./arch/x86/include/generated
-I./include -I./arch/x86/include/uapi -I./arch/x86/include/generated/uapi -I./include/uapi -I./include/generated/uapi -include ./include/linux/kconfig.h -include ./include/linux/
compiler_types.h -D__KERNEL__ -fmacro-prefix-map=./= -Wall -Wundef -Werror=strict-prototypes -Wno-trigraphs -fno-strict-aliasing -fno-common -fshort-wchar -fno-PIE
-Werror=implicit-function-declaration -Werror=implicit-int -Werror=return-type -Wno-format-security -std=gnu89 -mno-sse -mno-mmx -mno-sse2 -mno-3dnow -mno-avx -m64
-falign-jumps=1 -falign-loops=1 -mno-80387 -mno-fp-ret-in-387 -mpreferred-stack-boundary=3 -mskip-rax-setup -mtune=generic -mno-red-zone -mcmodel=kernel -DCONFIG_X86_X32_ABI
-Wno-sign-compare -fno-asynchronous-unwind-tables -mindirect-branch=thunk-extern -mindirect-branch-register -fno-jump-tables -fno-delete-null-pointer-checks -Wno-frame-address
-Wno-format-truncation -Wno-format-overflow -Wno-address-of-packed-member -O2 -fno-allow-store-data-races -Wframe-larger-than=2048 -fstack-protector-strong
-Wno-unused-but-set-variable -Wimplicit-fallthrough -Wno-unused-const-variable -g -pg -mrecord-mcount -mfentry -DCC_USING_FENTRY -Wdeclaration-after-statement -Wvla
-Wno-pointer-sign -Wno-stringop-truncation -Wno-zero-length-bounds -Wno-array-bounds -Wno-stringop-overflow -Wno-restrict -Wno-maybe-uninitialized -fno-strict-overflow
-fno-stack-check -fconserve-stack -Werror=date-time -Werror=incompatible-pointer-types -Werror=designated-init -fcf-protection=none -Wno-packed-not-aligned  -DMODULE
-DKBUILD_BASENAME=&#39;&quot;k_m.mod&quot;&#39; -DKBUILD_MODNAME=&#39;&quot;k_m&quot;&#39; -c -o /root/for_work/rootkit/demo1/k_mod/k_m.mod.o /root/for_work/rootkit/demo1/k_mod/k_m.mod.c
</pre></div>
</td></tr></table></div>
</div>
<p>参数描述可参考”gcc 手册”。</p>
</div></blockquote>
</li>
<li><p>k_m.o + k_m.mod.o –&gt; k_m.ko</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id71">
<div class="code-block-caption"><span class="caption-text">k_m.mod.c</span><a class="headerlink" href="#id71" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">ld</span> <span class="o">-</span><span class="n">r</span> <span class="o">-</span><span class="n">m</span> <span class="n">elf_x86_64</span> <span class="o">--</span><span class="n">build</span><span class="o">-</span><span class="n">id</span><span class="o">=</span><span class="n">sha1</span>  <span class="o">-</span><span class="n">T</span> <span class="n">scripts</span><span class="o">/</span><span class="n">module</span><span class="p">.</span><span class="n">lds</span> <span class="o">-</span><span class="n">o</span> <span class="n">k_m</span><span class="p">.</span><span class="n">ko</span> <span class="n">k_m</span><span class="p">.</span><span class="n">o</span> <span class="n">k_m</span><span class="p">.</span><span class="n">mod</span><span class="p">.</span><span class="n">o</span>
</pre></div>
</td></tr></table></div>
</div>
<p>参数描述:</p>
<ul class="simple">
<li><p>-r</p></li>
<li><p>-m elf_x86_64</p></li>
<li><p>–build-id=sha1</p></li>
<li><p>-T</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id72">
<div class="code-block-caption"><span class="caption-text">内核模块链接脚本: scripts/module.lds</span><a class="headerlink" href="#id72" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">SECTIONS</span> <span class="p">{</span>
<span class="o">/</span><span class="n">DISCARD</span><span class="o">/</span> <span class="o">:</span> <span class="p">{</span>
<span class="o">*</span><span class="p">(.</span><span class="n">discard</span><span class="p">)</span>
<span class="o">*</span><span class="p">(.</span><span class="n">discard</span><span class="p">.</span><span class="o">*</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">__ksymtab</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="n">SORT</span><span class="p">(</span><span class="n">___ksymtab</span><span class="o">+*</span><span class="p">))</span> <span class="p">}</span>
<span class="n">__ksymtab_gpl</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="n">SORT</span><span class="p">(</span><span class="n">___ksymtab_gpl</span><span class="o">+*</span><span class="p">))</span> <span class="p">}</span>
<span class="n">__ksymtab_unused</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="n">SORT</span><span class="p">(</span><span class="n">___ksymtab_unused</span><span class="o">+*</span><span class="p">))</span> <span class="p">}</span>
<span class="n">__ksymtab_unused_gpl</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="n">SORT</span><span class="p">(</span><span class="n">___ksymtab_unused_gpl</span><span class="o">+*</span><span class="p">))</span> <span class="p">}</span>
<span class="n">__ksymtab_gpl_future</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="n">SORT</span><span class="p">(</span><span class="n">___ksymtab_gpl_future</span><span class="o">+*</span><span class="p">))</span> <span class="p">}</span>
<span class="n">__kcrctab</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="n">SORT</span><span class="p">(</span><span class="n">___kcrctab</span><span class="o">+*</span><span class="p">))</span> <span class="p">}</span>
<span class="n">__kcrctab_gpl</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="n">SORT</span><span class="p">(</span><span class="n">___kcrctab_gpl</span><span class="o">+*</span><span class="p">))</span> <span class="p">}</span>
<span class="n">__kcrctab_unused</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="n">SORT</span><span class="p">(</span><span class="n">___kcrctab_unused</span><span class="o">+*</span><span class="p">))</span> <span class="p">}</span>
<span class="n">__kcrctab_unused_gpl</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="n">SORT</span><span class="p">(</span><span class="n">___kcrctab_unused_gpl</span><span class="o">+*</span><span class="p">))</span> <span class="p">}</span>
<span class="n">__kcrctab_gpl_future</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="n">SORT</span><span class="p">(</span><span class="n">___kcrctab_gpl_future</span><span class="o">+*</span><span class="p">))</span> <span class="p">}</span>
<span class="p">.</span><span class="n">init_array</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="n">SORT</span><span class="p">(.</span><span class="n">init_array</span><span class="p">.</span><span class="o">*</span><span class="p">))</span> <span class="o">*</span><span class="p">(.</span><span class="n">init_array</span><span class="p">)</span> <span class="p">}</span>
<span class="n">__jump_table</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="p">{</span> <span class="n">KEEP</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__jump_table</span><span class="p">))</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<p>注意：这主要针对导出符号（eg:EXPORT_SYMBOL),init_array(),__jump_table_节</p>
</div></blockquote>
</li>
<li><p>k_m.ko二进制格式分析</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id73">
<div class="code-block-caption"><span class="caption-text">k_m.mod.c</span><a class="headerlink" href="#id73" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span></span>ELF 头：
        Magic：  7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00
        类别:                              ELF64
        数据:                              2 补码，小端序 (little endian)
        Version:                           1 (current)
        OS/ABI:                            UNIX - System V
        ABI 版本:                          0
        类型:                              REL (可重定位文件)
        系统架构:                          Advanced Micro Devices X86-64
        版本:                              0x1
        入口点地址：              0x0
        程序头起点：              0 (bytes into file)
        Start of section headers:          256352 (bytes into file)
        标志：             0x0
        Size of this header:               64 (bytes)
        Size of program headers:           0 (bytes)
        Number of program headers:         0
        Size of section headers:           64 (bytes)
        Number of section headers:         56
        Section header string table index: 55
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
</li>
<li><p>总结:
- 当内核模块中引用内核导出函数时需要内核头文件夹或本地文件夹中存在内核编译后生成的Module.symvers文件;
- 如果引用了其他模块中导出的符号，则内核头文件夹中的Module.symvers中需要包含依赖模块产生的Module.symvers文件内容，或将产生的文件放入本地文件夹;
- 如果有导出符号，会导出相应的符号文件以供其他内核模块引用本模块导出符号时使用。</p></li>
</ul>
</div>
</div>
<div class="section" id="id13">
<h2>内核模块加载过程分析<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>insmod跟踪信息</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id74">
<div class="code-block-caption"><span class="caption-text">insmod跟踪信息</span><a class="headerlink" href="#id74" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#strace -o ./test insmod k_m.ko</span>
<span class="cp">#cat test</span>

<span class="n">execve</span><span class="p">(</span><span class="s">&quot;/usr/sbin/insmod&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;insmod&quot;</span><span class="p">,</span> <span class="s">&quot;k_m.ko&quot;</span><span class="p">],</span> <span class="mh">0x7ffd94cc3738</span> <span class="cm">/* 23 vars */</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">openat</span><span class="p">(</span><span class="n">AT_FDCWD</span><span class="p">,</span> <span class="s">&quot;/lib/modules/5.10.13/modules.softdep&quot;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="o">|</span><span class="n">O_CLOEXEC</span><span class="p">)</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">fcntl</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">F_GETFL</span><span class="p">)</span>                       <span class="o">=</span> <span class="mh">0x8000</span> <span class="p">(</span><span class="n">flags</span> <span class="n">O_RDONLY</span><span class="o">|</span><span class="n">O_LARGEFILE</span><span class="p">)</span>
<span class="n">fstat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">{</span><span class="n">st_mode</span><span class="o">=</span><span class="n">S_IFREG</span><span class="o">|</span><span class="mo">0644</span><span class="p">,</span> <span class="n">st_size</span><span class="o">=</span><span class="mi">1039</span><span class="p">,</span> <span class="p">...})</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">read</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;# Soft dependencies extracted fr&quot;</span><span class="p">...,</span> <span class="mi">4096</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1039</span>
<span class="n">read</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>                       <span class="o">=</span> <span class="mi">0</span>
<span class="n">close</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>                                <span class="o">=</span> <span class="mi">0</span>
<span class="n">openat</span><span class="p">(</span><span class="n">AT_FDCWD</span><span class="p">,</span> <span class="s">&quot;/proc/cmdline&quot;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="o">|</span><span class="n">O_CLOEXEC</span><span class="p">)</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">read</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;BOOT_IMAGE=/boot/vmlinuz-5.10.13&quot;</span><span class="p">...,</span> <span class="mi">4095</span><span class="p">)</span> <span class="o">=</span> <span class="mi">102</span>
<span class="n">read</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">3993</span><span class="p">)</span>                       <span class="o">=</span> <span class="mi">0</span>
<span class="n">close</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>                                <span class="o">=</span> <span class="mi">0</span>
<span class="n">stat</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">st_mode</span><span class="o">=</span><span class="n">S_IFDIR</span><span class="o">|</span><span class="mo">0777</span><span class="p">,</span> <span class="n">st_size</span><span class="o">=</span><span class="mi">4096</span><span class="p">,</span> <span class="p">...})</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">stat</span><span class="p">(</span><span class="s">&quot;/root/for_work/rootkit/demo1/k_mod&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">st_mode</span><span class="o">=</span><span class="n">S_IFDIR</span><span class="o">|</span><span class="mo">0777</span><span class="p">,</span> <span class="n">st_size</span><span class="o">=</span><span class="mi">4096</span><span class="p">,</span> <span class="p">...})</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">stat</span><span class="p">(</span><span class="s">&quot;/root/for_work/rootkit/demo1/k_mod/k_m.ko&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">st_mode</span><span class="o">=</span><span class="n">S_IFREG</span><span class="o">|</span><span class="mo">0644</span><span class="p">,</span> <span class="n">st_size</span><span class="o">=</span><span class="mi">259936</span><span class="p">,</span> <span class="p">...})</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">openat</span><span class="p">(</span><span class="n">AT_FDCWD</span><span class="p">,</span> <span class="s">&quot;/root/for_work/rootkit/demo1/k_mod/k_m.ko&quot;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="o">|</span><span class="n">O_CLOEXEC</span><span class="p">)</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1">//打开k_m.ko，返回文件描述符</span>
<span class="n">read</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\177</span><span class="s">ELF</span><span class="se">\2\1</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>               <span class="o">=</span> <span class="mi">6</span>
<span class="n">lseek</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">)</span>                   <span class="o">=</span> <span class="mi">0</span>
<span class="n">fstat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">{</span><span class="n">st_mode</span><span class="o">=</span><span class="n">S_IFREG</span><span class="o">|</span><span class="mo">0644</span><span class="p">,</span> <span class="n">st_size</span><span class="o">=</span><span class="mi">259936</span><span class="p">,</span> <span class="p">...})</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">259936</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x7f5659dfd000</span><span class="c1">//mmap系统调用，返回内核模块加载入内存的首地址。</span>
<span class="n">finit_module</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>                  <span class="o">=</span> <span class="mi">0</span> <span class="c1">//模块加载</span>
<span class="n">munmap</span><span class="p">(</span><span class="mh">0x7f5659dfd000</span><span class="p">,</span> <span class="mi">259936</span><span class="p">)</span>          <span class="o">=</span> <span class="mi">0</span>
<span class="n">close</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>                                <span class="o">=</span> <span class="mi">0</span>
<span class="n">exit_group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                           <span class="o">=</span> <span class="o">?</span>
<span class="o">+++</span> <span class="n">exited</span> <span class="n">with</span> <span class="mi">0</span> <span class="o">+++</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
</li>
<li><p>finit_module分析</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id75">
<div class="code-block-caption"><span class="caption-text">finit_module系统调用</span><a class="headerlink" href="#id75" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">finit_module</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">uargs</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="nc">load_info</span> <span class="n">info</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
        <span class="kt">void</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">may_init_module</span><span class="p">();</span><span class="c1">//检查当前进程是否有权限,内核是否支持</span>
        <span class="p">......</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">kernel_read_file_from_fd</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">INT_MAX</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
                                       <span class="n">READING_MODULE</span><span class="p">);</span><span class="c1">//读取文件内容，允许文件最大2G：vmalloc(64 bit ～ kmalloc)</span>
        <span class="n">info</span><span class="p">.</span><span class="n">hdr</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">;</span><span class="c1">//初始化文件头</span>
        <span class="n">info</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span><span class="c1">//返回字节数</span>
        <span class="k">return</span> <span class="nf">load_module</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">uargs</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span><span class="c1">//分配和加载module</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
</li>
<li><p>load_module分析</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id76">
<div class="code-block-caption"><span class="caption-text">finit_module系统调用</span><a class="headerlink" href="#id76" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/* Allocate and load the module: note that size of section 0 is always</span>
<span class="cm">   zero, and we rely on this for optional sections. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">load_module</span><span class="p">(</span><span class="k">struct</span> <span class="nc">load_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uargs</span><span class="p">,</span>
                       <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="nc">module</span> <span class="o">*</span><span class="n">mod</span><span class="p">;</span>
        <span class="kt">long</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">after_dashes</span><span class="p">;</span>

        <span class="n">err</span> <span class="o">=</span> <span class="n">elf_header_check</span><span class="p">(</span><span class="n">info</span><span class="p">);</span> <span class="cm">/* ELF文件有效性检查:版本,架构 主要检查文件头：info.hdr */</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">setup_load_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span><span class="cm">/*主要对info结构进行初始化，主要对关键节进行地址初始化*/</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">blacklisted</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* 是否处于黑名单中:module_blacklist*/</span>
                <span class="p">......</span>
                <span class="k">goto</span> <span class="n">free_copy</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">module_sig_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span> <span class="cm">/*根据信息进行认证信息验证,后面有一章详细解析 */</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">rewrite_section_headers</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span> <span class="cm">/* 根据文件头信息及头地址对各个节地址进行设定(sh_addr = info-&gt;hdr + shdr-&gt;sh_offset),这是要连续加载：*/</span>
        <span class="cm">/* Check module struct version now, before we try to use module. */</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_modstruct_version</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">mod</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* 校验版本信息:获取module_layout函数信息：从内核导出符号表中查询 */</span>
                <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOEXEC</span><span class="p">;</span>
                <span class="k">goto</span> <span class="n">free_copy</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/* Figure out module layout, and allocate all the memory.:计算模块布局，并分配所有内存 */</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">layout_and_allocate</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span> <span class="cm">/* 为加载的节分配内存，并将节复制到特定的位置，返回struct module所在节在内存中的基地址 */</span>
        <span class="n">audit_log_kern_module</span><span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span> <span class="cm">/* 审计 hook点 */</span>
        <span class="cm">/* Reserve our place in the list. */</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">add_unformed_module</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span> <span class="cm">/* 查询系统中是否存在同名模块，如果存在且处于活动状态则返回错误*/</span>
        <span class="k">if</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="cm">/*如果已有同名模块存在，则终止加载 */</span>
           <span class="k">goto</span> <span class="n">free_module</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_MODULE_SIG</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">sig_ok</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sig_ok</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">sig_ok</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* 如果没有认证信息，则打印警告 */</span>
                <span class="n">pr_notice_once</span><span class="p">(</span><span class="s">&quot;%s: module verification failed: signature &quot;</span>
                               <span class="s">&quot;and/or required key missing - tainting &quot;</span>
                               <span class="s">&quot;kernel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
                <span class="n">add_taint_module</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">TAINT_UNSIGNED_MODULE</span><span class="p">,</span> <span class="n">LOCKDEP_STILL_OK</span><span class="p">);</span>
        <span class="p">}</span>
<span class="cp">#endif</span>
        <span class="cm">/* To avoid stressing percpu allocator, do this once we&#39;re unique. */</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">percpu_modalloc</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>  <span class="cm">/* 注意:percpu data加载 */</span>

        <span class="cm">/* Now module is in final location, initialize linked lists, etc. */</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">module_unload_init</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span> <span class="cm">/* 初始化模块的卸载节*/</span>
        <span class="n">init_param_lock</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span><span class="cm">/* 初始化参数锁，进程通过系统调用传递进来的内核模块参数 */</span>

        <span class="cm">/* Now we&#39;ve got everything in the final locations, we can find optional sections. */</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">find_module_sections</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span> <span class="cm">/* 具体参考下面列出的函数代码:根据以下节初始化节</span>
<span class="cm">                :__param,__ksymtab,__kcrctab,__ksymtab_gpl,__kcrctab_gpl,__ksymtab_gpl_future,__kcrctab_gpl_future,__ksymtab_unused,</span>
<span class="cm">                __kcrctab_unused,__ksymtab_unused_gpl,__kcrctab_unused_gpl,后续进行详细描述 */</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">check_module_license_and_versions</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span> <span class="cm">/* 版本校验*/</span>
        <span class="cm">/* Set up MODINFO_ATTR fields */</span>
        <span class="n">setup_modinfo</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>  <span class="cm">/* 模块加载属性信息 */</span>

        <span class="cm">/* Fix up syms, so that st_value is a pointer to location. */</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">simplify_symbols</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span> <span class="cm">/* 符号的处理：更改所有符号，以便 st_value 直接对指针进行编码*/</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">apply_relocations</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span> <span class="cm">/* 重定向节*/</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">post_relocation</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span> <span class="cm">/* 重定向后的部分*/</span>
        <span class="n">flush_module_icache</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span> <span class="cm">/* 可用wmb理解 */</span>

        <span class="cm">/* Now copy in args */</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">args</span> <span class="o">=</span> <span class="n">strndup_user</span><span class="p">(</span><span class="n">uargs</span><span class="p">,</span> <span class="o">~</span><span class="mi">0UL</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* 从用户空间复制 */</span>
        <span class="n">dynamic_debug_setup</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">num_debug</span><span class="p">);</span><span class="cm">/* ddebug_table: 调试部分专门描述 */</span>
        <span class="cm">/* Ftrace init must be called in the MODULE_STATE_UNFORMED state */</span>
        <span class="n">ftrace_module_init</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span> <span class="cm">/*ftrace相关，具体参考ftrace部分*/</span>

        <span class="cm">/* Finally it&#39;s fully formed, ready to start executing. */</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">complete_formation</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span> <span class="cm">/* --&gt;MODULE_STATE_COMING：模块状态设置*/</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">prepare_coming_module</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span> <span class="cm">/* 跟踪,若live patch则修改状态,通知所有关心模块加载的部件:MODULE_STATE_COMING/</span>

<span class="cm">        /* Module is ready to execute: parsing args may do that. */</span>
        <span class="n">after_dashes</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">,</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">kp</span><span class="p">,</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_kp</span><span class="p">,</span><span class="cm">/* 内核参数解析 */</span>
                                  <span class="mi">-32768</span><span class="p">,</span> <span class="mi">32767</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span>
                                  <span class="n">unknown_module_param_cb</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">after_dashes</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">after_dashes</span><span class="p">);</span>
                <span class="k">goto</span> <span class="n">coming_cleanup</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">after_dashes</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s: parameters &#39;%s&#39; after `--&#39; ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                       <span class="n">mod</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">after_dashes</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="cm">/* Link in to sysfs. */</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">mod_sysfs_setup</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">kp</span><span class="p">,</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_kp</span><span class="p">);</span> <span class="cm">/* sysfs节点信息导出：包括节信息 */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">is_livepatch_module</span><span class="p">(</span><span class="n">mod</span><span class="p">))</span> <span class="p">{</span><span class="c1">//如果模块代表的是内核补丁</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">copy_module_elf</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span> <span class="cm">/* 填充mod--&gt;klp_info:模块信息,ELF头,节头表,节字符串表,符号节索引等:实时补丁处进行详细说明*/</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="k">goto</span> <span class="n">sysfs_cleanup</span>
        <span class="p">}</span>

        <span class="cm">/* Get rid of temporary copy. */</span>
        <span class="n">free_copy</span><span class="p">(</span><span class="n">info</span><span class="p">);</span><span class="cm">/*info-&gt;hdr已经保存到module结构中,可以释放掉了 */</span>

        <span class="cm">/* Done! trace 跟踪点 hook */</span>
        <span class="n">trace_module_load</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span>
        <span class="k">return</span> <span class="nf">do_init_module</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span><span class="cm">/* 最核心处理部分 */</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
</li>
<li><p>do_init_module:</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id77">
<div class="code-block-caption"><span class="caption-text">do_init_module说明</span><a class="headerlink" href="#id77" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * This is where the real work happens.</span>
<span class="cm"> *</span>
<span class="cm"> * Keep it uninlined to provide a reliable breakpoint target, e.g. for the gdb</span>
<span class="cm"> * helper command &#39;lx-symbols&#39;.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline</span> <span class="kt">int</span> <span class="n">do_init_module</span><span class="p">(</span><span class="k">struct</span> <span class="nc">module</span> <span class="o">*</span><span class="n">mod</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">mod_initfree</span> <span class="o">*</span><span class="n">freeinit</span><span class="p">;</span>

        <span class="n">freeinit</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">freeinit</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">freeinit</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
                <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">freeinit</span><span class="o">-&gt;</span><span class="n">module_init</span> <span class="o">=</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">init_layout</span><span class="p">.</span><span class="n">base</span><span class="p">;</span><span class="cm">/* 这个地址,可以释放的 */</span>

        <span class="cm">/*</span>
<span class="cm">         * We want to find out whether @mod uses async during init.  Clear</span>
<span class="cm">         * PF_USED_ASYNC.  async_schedule*() will set it.</span>
<span class="cm">         */</span>
        <span class="n">current</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PF_USED_ASYNC</span><span class="p">;</span>

        <span class="n">do_mod_ctors</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span><span class="cm">/* 调用模块构造,也可忽略,此处忽略 */</span>
        <span class="cm">/* Start the module */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">init</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">do_one_initcall</span><span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">);</span> <span class="cm">/* 执行初始化函数 */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">goto</span> <span class="n">fail_free_freeinit</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s: &#39;%s&#39;-&gt;init suspiciously returned %d, it should &quot;</span>
                        <span class="s">&quot;follow 0/-E convention</span><span class="se">\n</span><span class="s">&quot;</span>
                        <span class="s">&quot;%s: loading module anyway...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                        <span class="n">__func__</span><span class="p">,</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
                <span class="n">dump_stack</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="cm">/* Now it&#39;s a first class citizen! */</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MODULE_STATE_LIVE</span><span class="p">;</span><span class="c1">//初始化完成</span>
        <span class="n">blocking_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module_notify_list</span><span class="p">,</span><span class="cm">/* 状态变化通知 */</span>
                                     <span class="n">MODULE_STATE_LIVE</span><span class="p">,</span> <span class="n">mod</span><span class="p">);</span>

        <span class="cm">/* Delay uevent until module has finished its init routine */</span>
        <span class="n">kobject_uevent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">mkobj</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="n">KOBJ_ADD</span><span class="p">);</span> <span class="cm">/* 事件通知：KOBJ_ADD，向用户伺服软件发送信息*/</span>

        <span class="cm">/*</span>
<span class="cm">         * We need to finish all async code before the module init sequence</span>
<span class="cm">         * is done.  This has potential to deadlock.  For example, a newly</span>
<span class="cm">         * detected block device can trigger request_module() of the</span>
<span class="cm">         * default iosched from async probing task.  Once userland helper</span>
<span class="cm">         * reaches here, async_synchronize_full() will wait on the async</span>
<span class="cm">         * task waiting on request_module() and deadlock.</span>
<span class="cm">         *</span>
<span class="cm">         * This deadlock is avoided by perfomring async_synchronize_full()</span>
<span class="cm">         * iff module init queued any async jobs.  This is not a full</span>
<span class="cm">         * solution as it will deadlock the same if module loading from</span>
<span class="cm">         * async jobs nests more than once; however, due to the various</span>
<span class="cm">         * constraints, this hack seems to be the best option for now.</span>
<span class="cm">         * Please refer to the following thread for details.</span>
<span class="cm">         *</span>
<span class="cm">         * http://thread.gmane.org/gmane.linux.kernel/1420814</span>
<span class="cm">         */</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">async_probe_requested</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PF_USED_ASYNC</span><span class="p">))</span>
                <span class="n">async_synchronize_full</span><span class="p">();</span><span class="cm">/*同步 */</span>

        <span class="n">ftrace_free_mem</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">init_layout</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">init_layout</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span>
                        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">init_layout</span><span class="p">.</span><span class="n">size</span><span class="p">);</span> <span class="cm">/* */</span>
        <span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module_mutex</span><span class="p">);</span>
        <span class="cm">/* Drop initial reference. */</span>
        <span class="n">module_put</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span><span class="cm">/* 注意：背后的目的是什么？ */</span>
        <span class="n">trim_init_extable</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span> <span class="cm">/* 后续详细描述*/</span>
<span class="cp">#ifdef CONFIG_KALLSYMS</span>
        <span class="cm">/* Switch to core kallsyms now init is done: kallsyms may be walking! */</span>
        <span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">kallsyms</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">core_kallsyms</span><span class="p">);</span><span class="cm">/* 后续详细描述 ？？？*/</span>
<span class="cp">#endif</span>
        <span class="n">module_enable_ro</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span> <span class="cm">/* 设置内存vm的权限,注意,vma也注意下 */</span>
        <span class="n">mod_tree_remove_init</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span> <span class="cm">/*删除初始化部分*/</span>
        <span class="n">module_arch_freeing_init</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">init_layout</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* 删除后对对应参数进行归零 */</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">init_layout</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">init_layout</span><span class="p">.</span><span class="n">ro_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">init_layout</span><span class="p">.</span><span class="n">ro_after_init_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">init_layout</span><span class="p">.</span><span class="n">text_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="cm">/*</span>
<span class="cm">         * We want to free module_init, but be aware that kallsyms may be</span>
<span class="cm">         * walking this with preempt disabled.  In all the failure paths, we</span>
<span class="cm">         * call synchronize_rcu(), but we don&#39;t want to slow down the success</span>
<span class="cm">         * path. module_memfree() cannot be called in an interrupt, so do the</span>
<span class="cm">         * work and call synchronize_rcu() in a work queue.</span>
<span class="cm">         *</span>
<span class="cm">         * Note that module_alloc() on most architectures creates W+X page</span>
<span class="cm">         * mappings which won&#39;t be cleaned up until do_free_init() runs.  Any</span>
<span class="cm">         * code such as mark_rodata_ro() which depends on those mappings to</span>
<span class="cm">         * be cleaned up needs to sync with the queued work - ie</span>
<span class="cm">         * rcu_barrier()</span>
<span class="cm">         */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">llist_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">freeinit</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_free_list</span><span class="p">))</span><span class="cm">/* */</span>
                <span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_free_wq</span><span class="p">);</span>

        <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module_mutex</span><span class="p">);</span>
        <span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module_wq</span><span class="p">);</span> <span class="cm">/*延迟部分*/</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
</li>
<li><p>加载过程分析图：（finit)</p></li>
</ul>
<img alt="../_images/module_finit.svg" class="align-center" src="../_images/module_finit.svg" /><div class="section" id="id14">
<h3>重点函数分析<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p>struct load_info</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id78">
<div class="code-block-caption"><span class="caption-text">struct load_info</span><a class="headerlink" href="#id78" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nc">load_info</span> <span class="p">{</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
        <span class="cm">/* pointer to module in temporary copy, freed at end of load_module() */</span>
        <span class="k">struct</span> <span class="nc">module</span> <span class="o">*</span><span class="n">mod</span><span class="p">;</span>
        <span class="n">Elf_Ehdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span> <span class="cm">/* 文件头 */</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">;</span>
        <span class="n">Elf_Shdr</span> <span class="o">*</span><span class="n">sechdrs</span><span class="p">;</span> <span class="cm">/* 节头表 */</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">secstrings</span><span class="p">,</span> <span class="o">*</span><span class="n">strtab</span><span class="p">;</span><span class="cm">/* */</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">symoffs</span><span class="p">,</span> <span class="n">stroffs</span><span class="p">,</span> <span class="n">init_typeoffs</span><span class="p">,</span> <span class="n">core_typeoffs</span><span class="p">;</span>
        <span class="k">struct</span> <span class="nc">_ddebug</span> <span class="o">*</span><span class="n">debug</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_debug</span><span class="p">;</span>
        <span class="kt">bool</span> <span class="n">sig_ok</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_KALLSYMS</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mod_kallsyms_init_off</span><span class="p">;</span>
<span class="cp">#endif</span>
        <span class="k">struct</span> <span class="p">{</span>
                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sym</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">vers</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">pcpu</span><span class="p">;</span><span class="cm">/* 相关节的索引 */</span>
        <span class="p">}</span> <span class="n">index</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
</li>
<li><p>setup_load_info:关键节信息初始化</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id79">
<div class="code-block-caption"><span class="caption-text">do_init_module说明</span><a class="headerlink" href="#id79" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * Set up our basic convenience variables (pointers to section headers,</span>
<span class="cm"> * search for module section index etc), and do some basic section</span>
<span class="cm"> * verification.</span>
<span class="cm"> *</span>
<span class="cm"> * Set info-&gt;mod to the temporary copy of the module in info-&gt;hdr. The final one</span>
<span class="cm"> * will be allocated in move_module().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">setup_load_info</span><span class="p">(</span><span class="k">struct</span> <span class="nc">load_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span> <span class="cm">/* 根据ELF文件头来初始化一些变量，以hdr基地址做基准进行初始化*/</span>
<span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

        <span class="cm">/* Set up the convenience variables */</span>
        <span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">hdr</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">e_shoff</span><span class="p">;</span> <span class="cm">/* 节头表地址：文件头地址 + 节头表在文件中的偏移 */</span>
        <span class="n">info</span><span class="o">-&gt;</span><span class="n">secstrings</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">hdr</span>
                <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">e_shstrndx</span><span class="p">].</span><span class="n">sh_offset</span><span class="p">;</span> <span class="cm">/*  符号表地址：文件头地址 + 符号表所在节在文件中的偏移 */</span>

        <span class="cm">/* Try to find a name early so we can log errors with a module name */</span>
        <span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">find_sec</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;.modinfo&quot;</span><span class="p">);</span><span class="cm">/* modinfo 节索引（节号） */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">.</span><span class="n">info</span><span class="p">)</span>
                <span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">get_modinfo</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">);</span><span class="cm">/* 从modinfo中获取name标志 */</span>

        <span class="cm">/* Find internal symbols and strings. */</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">e_shnum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* 节遍历 */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_type</span> <span class="o">==</span> <span class="n">SHT_SYMTAB</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* 符号表 */</span>
                        <span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">.</span><span class="n">sym</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="cm">/* 符号表节索引 */</span>
                        <span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">.</span><span class="n">str</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_link</span><span class="p">;</span> <span class="cm">/* 字符串表索引 */</span>
                        <span class="n">info</span><span class="o">-&gt;</span><span class="n">strtab</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">hdr</span>
                                <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">.</span><span class="n">str</span><span class="p">].</span><span class="n">sh_offset</span><span class="p">;</span> <span class="cm">/* 对应的字符串表 */</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">.</span><span class="n">sym</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* 没有符号表   */</span>
                <span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s: module has no symbols (stripped?)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                        <span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">?:</span> <span class="s">&quot;(missing .modinfo section or name field)&quot;</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">ENOEXEC</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">.</span><span class="n">mod</span> <span class="o">=</span> <span class="n">find_sec</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;.gnu.linkonce.this_module&quot;</span><span class="p">);</span><span class="cm">/* 模块节:k_m.mod.c struct module结构:节索引*/</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">.</span><span class="n">mod</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s: No module found in object</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                        <span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">?:</span> <span class="s">&quot;(missing .modinfo section or name field)&quot;</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">ENOEXEC</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="cm">/* This is temporary: point mod into copy of data. */</span>
        <span class="n">info</span><span class="o">-&gt;</span><span class="n">mod</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">hdr</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">.</span><span class="n">mod</span><span class="p">].</span><span class="n">sh_offset</span><span class="p">;</span><span class="cm">/* struct module地址 ：文件头基地址 + 文件中的偏移*/</span>

        <span class="cm">/*</span>
<span class="cm">         * If we didn&#39;t load the .modinfo &#39;name&#39; field earlier, fall back to</span>
<span class="cm">         * on-disk struct mod &#39;name&#39; field.</span>
<span class="cm">         */</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
                <span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span><span class="cm">/* 如果没有手动设定则使用模块文件名称 */</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MODULE_INIT_IGNORE_MODVERSIONS</span><span class="p">)</span>
                <span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">.</span><span class="n">vers</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Pretend no __versions section! */</span>
        <span class="k">else</span>
                <span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">.</span><span class="n">vers</span> <span class="o">=</span> <span class="n">find_sec</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;__versions&quot;</span><span class="p">);</span> <span class="cm">/* __versions节索引  */</span>

        <span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">.</span><span class="n">pcpu</span> <span class="o">=</span> <span class="n">find_pcpusec</span><span class="p">(</span><span class="n">info</span><span class="p">);</span><span class="cm">/* .data..percpu 节索引：单CPU变量索引 */</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<p>这算是一个中间结构加载，为后面的初始化收集信息，加载接受后需要释放。</p>
</div></blockquote>
</li>
<li><dl>
<dt>module_sig_check:认证：static int module_sig_check(struct load_info <a href="#id15"><span class="problematic" id="id16">*</span></a>info, int flags) –&gt; mod_verify_sig(mod, info);</dt><dd><div class="literal-block-wrapper docutils container" id="id80">
<div class="code-block-caption"><span class="caption-text">do_init_module说明</span><a class="headerlink" href="#id80" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * Verify the signature on a module.：详细的认证方式有专门描述</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mod_verify_sig</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">mod</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">load_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="nc">module_signature</span> <span class="n">ms</span><span class="p">;</span>
        <span class="kt">size_t</span> <span class="n">sig_len</span><span class="p">,</span> <span class="n">modlen</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">wholelen</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

        <span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;==&gt;%s(,%zu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">modlen</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">modlen</span> <span class="o">&lt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ms</span><span class="p">))</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>

        <span class="n">wholelen</span> <span class="o">=</span> <span class="n">modlen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MODULE_SIG_STRING</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ms</span><span class="p">,</span> <span class="n">mod</span> <span class="o">+</span> <span class="p">(</span><span class="n">modlen</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ms</span><span class="p">)),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ms</span><span class="p">));</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">mod_check_sig</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ms</span><span class="p">,</span> <span class="n">modlen</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

        <span class="n">sig_len</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ms</span><span class="p">.</span><span class="n">sig_len</span><span class="p">);</span>
        <span class="n">modlen</span> <span class="o">-=</span> <span class="n">sig_len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ms</span><span class="p">);</span>
        <span class="n">info</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">modlen</span><span class="p">;</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">verify_pkcs7_signature</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">modlen</span><span class="p">,</span> <span class="n">mod</span> <span class="o">+</span> <span class="n">modlen</span><span class="p">,</span> <span class="n">sig_len</span><span class="p">,</span>
                                      <span class="n">VERIFY_USE_SECONDARY_KEYRING</span><span class="p">,</span>
                                      <span class="n">VERIFYING_MODULE_SIGNATURE</span><span class="p">,</span>
                                      <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;verify_pkcs7_signature() = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOKEY</span> <span class="o">&amp;&amp;</span> <span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_INTEGRITY_PLATFORM_KEYRING</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">verify_pkcs7_signature</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">modlen</span><span class="p">,</span> <span class="n">mod</span> <span class="o">+</span> <span class="n">modlen</span><span class="p">,</span> <span class="n">sig_len</span><span class="p">,</span>
                                <span class="n">VERIFY_USE_PLATFORM_KEYRING</span><span class="p">,</span>
                                <span class="n">VERIFYING_MODULE_SIGNATURE</span><span class="p">,</span>
                                <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
                <span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;verify_pkcs7_signature() = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="cm">/* checking hash of module is in blacklist */</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">mod_is_hash_blacklisted</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">wholelen</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</dd>
</dl>
</li>
<li><p>rewrite_section_headers: 清除相关节的SHF_ALLOC 标志</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id81">
<div class="code-block-caption"><span class="caption-text">rewrite_section_headers</span><a class="headerlink" href="#id81" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="n">rewrite_section_headers</span><span class="p">(</span><span class="k">struct</span> <span class="nc">load_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

        <span class="cm">/* This should always be true, but let&#39;s be sure. */</span>
        <span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sh_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">e_shnum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">Elf_Shdr</span> <span class="o">*</span><span class="n">shdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">shdr</span><span class="o">-&gt;</span><span class="n">sh_type</span> <span class="o">!=</span> <span class="n">SHT_NOBITS</span>
                    <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">shdr</span><span class="o">-&gt;</span><span class="n">sh_offset</span> <span class="o">+</span> <span class="n">shdr</span><span class="o">-&gt;</span><span class="n">sh_size</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Module len %lu truncated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
                        <span class="k">return</span> <span class="o">-</span><span class="n">ENOEXEC</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="cm">/* Mark all sections sh_addr with their address in the</span>
<span class="cm">                   temporary image. */</span>
                <span class="n">shdr</span><span class="o">-&gt;</span><span class="n">sh_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">hdr</span> <span class="o">+</span> <span class="n">shdr</span><span class="o">-&gt;</span><span class="n">sh_offset</span><span class="p">;</span> <span class="cm">/* 索引为i的节的节头地址 */</span>

<span class="cp">#ifndef CONFIG_MODULE_UNLOAD</span>
                <span class="cm">/* Don&#39;t load .exit sections */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">module_exit_section</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">secstrings</span><span class="o">+</span><span class="n">shdr</span><span class="o">-&gt;</span><span class="n">sh_name</span><span class="p">))</span><span class="cm">/* .exit节 */</span>
                        <span class="n">shdr</span><span class="o">-&gt;</span><span class="n">sh_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">SHF_ALLOC</span><span class="p">;</span> <span class="cm">/* 清除SHF_ALLOC: 影响？ */</span>
<span class="cp">#endif</span>
        <span class="p">}</span>

        <span class="cm">/* Track but don&#39;t keep modinfo and version sections. :清除 SHF_ALLOC标识*/</span>
        <span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">.</span><span class="n">vers</span><span class="p">].</span><span class="n">sh_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">SHF_ALLOC</span><span class="p">;</span><span class="cm">/* 直接解析，不需要分配内存 */</span>
        <span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">.</span><span class="n">info</span><span class="p">].</span><span class="n">sh_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">SHF_ALLOC</span><span class="p">;</span><span class="cm">/* 直接解析，不需要分配内存 */</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
</li>
<li><p>check_modstruct_version:确认函数module_layout的合法性。</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id82">
<div class="code-block-caption"><span class="caption-text">check_modstruct_version</span><a class="headerlink" href="#id82" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">check_modstruct_version</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="nc">load_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
                                          <span class="k">struct</span> <span class="nc">module</span> <span class="o">*</span><span class="n">mod</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">const</span> <span class="n">s32</span> <span class="o">*</span><span class="n">crc</span><span class="p">;</span>

        <span class="cm">/*</span>
<span class="cm">         * Since this should be found in kernel (which can&#39;t be removed), no</span>
<span class="cm">         * locking is necessary -- use preempt_disable() to placate lockdep.</span>
<span class="cm">         */</span>
        <span class="n">preempt_disable</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">find_symbol</span><span class="p">(</span><span class="s">&quot;module_layout&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span><span class="cm">/* module_layout函数 */</span>
                <span class="n">preempt_enable</span><span class="p">();</span>
                <span class="n">BUG</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="n">preempt_enable</span><span class="p">();</span>
        <span class="k">return</span> <span class="nf">check_version</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;module_layout&quot;</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">crc</span><span class="p">);</span><span class="cm">/* 校验module_layout符号 */</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
</li>
<li><p>layout_and_allocate:进一步初始化info结构， 节信息加载,节权限确认：内存布局理解关键:</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id83">
<div class="code-block-caption"><span class="caption-text">layout_and_allocate</span><a class="headerlink" href="#id83" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="k">struct</span> <span class="nc">module</span> <span class="o">*</span><span class="n">layout_and_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="nc">load_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="nc">module</span> <span class="o">*</span><span class="n">mod</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ndx</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

        <span class="n">err</span> <span class="o">=</span> <span class="n">check_modinfo</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mod</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span><span class="cm">/* 确认modinfo节信息有效性 */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>

        <span class="cm">/* Allow arches to frob section contents and sizes.  */</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">module_frob_arch_sections</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">,</span> <span class="cm">/* 空： */</span>
                                        <span class="n">info</span><span class="o">-&gt;</span><span class="n">secstrings</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">mod</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>

        <span class="n">err</span> <span class="o">=</span> <span class="n">module_enforce_rwx_sections</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">,</span>
                                          <span class="n">info</span><span class="o">-&gt;</span><span class="n">secstrings</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">mod</span><span class="p">);</span><span class="cm">/* 不处理出现SHF_WRITE | SHF_EXECINSTR 的节:不允许可写可执行的节*/</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>

        <span class="cm">/* We will do a special allocation for per-cpu sections later. */</span>
        <span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">.</span><span class="n">pcpu</span><span class="p">].</span><span class="n">sh_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">SHF_ALLOC</span><span class="p">;</span><span class="cm">/* 清除 pcpu节的SHF_ALLOC标识:即这个节不进行通常意义的分配*/</span>

        <span class="cm">/*</span>
<span class="cm">         * Mark ro_after_init section with SHF_RO_AFTER_INIT so that</span>
<span class="cm">         * layout_sections() can put it in the right place.</span>
<span class="cm">         * Note: ro_after_init sections also have SHF_{WRITE,ALLOC} set.</span>
<span class="cm">         */</span>
        <span class="n">ndx</span> <span class="o">=</span> <span class="n">find_sec</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;.data..ro_after_init&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ndx</span><span class="p">)</span>
                <span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">[</span><span class="n">ndx</span><span class="p">].</span><span class="n">sh_flags</span> <span class="o">|=</span> <span class="n">SHF_RO_AFTER_INIT</span><span class="p">;</span>
        <span class="cm">/*</span>
<span class="cm">         * Mark the __jump_table section as ro_after_init as well: these data</span>
<span class="cm">         * structures are never modified, with the exception of entries that</span>
<span class="cm">         * refer to code in the __init section, which are annotated as such</span>
<span class="cm">         * at module load time.</span>
<span class="cm">         */</span>
        <span class="n">ndx</span> <span class="o">=</span> <span class="n">find_sec</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;__jump_table&quot;</span><span class="p">);</span><span class="cm">/* __jump_table节 */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ndx</span><span class="p">)</span>
                <span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">[</span><span class="n">ndx</span><span class="p">].</span><span class="n">sh_flags</span> <span class="o">|=</span> <span class="n">SHF_RO_AFTER_INIT</span><span class="p">;</span><span class="cm">/* 设置标识*/</span>

        <span class="cm">/* Determine total sizes, and put offsets in sh_entsize.  For now</span>
<span class="cm">           this is done generically; there doesn&#39;t appear to be any</span>
<span class="cm">           special cases for the architectures. */</span>
        <span class="n">layout_sections</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mod</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span> <span class="cm">/* 为SHF_ALLOC节进行布局：code,只读数据，读写数据，小数据。</span>
<span class="cm">                        总体大小，sh_entsize放置偏移：高位代表在init中。mod-&gt;core_layout初始化：executable;ro:text and ro-data;ro after init;</span>
<span class="cm">                                                                        mod-&gt;init_layout初始化:.init节</span>
<span class="cm">                        1. info-&gt;sechdrs[i].sh_entsize = ~0UL;</span>
<span class="cm">                        2. 计算core_layout;</span>
<span class="cm">                        3. 计算init_layout;</span>
<span class="cm">                        注意：这个计算长度理解上有些问题。</span>






<span class="cm">                                                                        */</span>
        <span class="n">layout_symtab</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mod</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span><span class="cm">/* 继续计算长度*/</span>

        <span class="cm">/* Allocate and move to the final place */</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">move_module</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mod</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span><span class="cm">/* 具体分配：</span>
<span class="cm">                                              1. ptr = module_alloc(mod-&gt;core_layout.size):__vmalloc_node_range()</span>
<span class="cm">                                              2. 检测是否有内存泄漏情况</span>
<span class="cm">                                              3. memset(ptr,0,mod-&gt;core_layout.size)</span>
<span class="cm">                                              4. mod-&gt;core_layout.base = ptr</span>
<span class="cm">                                              5. ptr = module_alloc(mod-&gt;init_layout.size);</span>
<span class="cm">                                              6. kmemleak_ignore(ptr);</span>
<span class="cm">                                              7. memset(ptr,0,mod-&gt;init_layout.size);</span>
<span class="cm">                                              8. mod-&gt;init_layout.base = ptr;</span>
<span class="cm">                                              9. 将节属性为SHF_ALLOC并设置了sh_entsize的节依次放入分配的空间（init_layout或core_layout)</span>
<span class="cm">                                              10. 设置节头地址为：shdr-&gt;sh_addr = (unsigned long)dest;//加载到内存的基地址;</span>
<span class="cm">                                               这是理解的核心所在。地址应该是节内偏移？（注意一下）；</span>
<span class="cm">                                              */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>

        <span class="cm">/* Module has been copied to its final place now: return it. */</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">.</span><span class="n">mod</span><span class="p">].</span><span class="n">sh_addr</span><span class="p">;</span><span class="cm">/* struct module:直接指向存储struct module的节在内存的基地址 */</span>
        <span class="n">kmemleak_load_module</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span><span class="cm">/* 内存泄漏检测*/</span>
        <span class="k">return</span> <span class="n">mod</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<p>这个函数结束后需要加载的信息就应经加载完了。</p>
</div></blockquote>
</li>
<li><p>percpu_modalloc:注意:percpu data加载</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id84">
<div class="code-block-caption"><span class="caption-text">percpu_modalloc</span><a class="headerlink" href="#id84" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="n">percpu_modalloc</span><span class="p">(</span><span class="k">struct</span> <span class="nc">module</span> <span class="o">*</span><span class="n">mod</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">load_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">Elf_Shdr</span> <span class="o">*</span><span class="n">pcpusec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">.</span><span class="n">pcpu</span><span class="p">];</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">align</span> <span class="o">=</span> <span class="n">pcpusec</span><span class="o">-&gt;</span><span class="n">sh_addralign</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcpusec</span><span class="o">-&gt;</span><span class="n">sh_size</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">align</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s: per-cpu alignment %li &gt; %li</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">align</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
                <span class="n">align</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">percpu</span> <span class="o">=</span> <span class="n">__alloc_reserved_percpu</span><span class="p">(</span><span class="n">pcpusec</span><span class="o">-&gt;</span><span class="n">sh_size</span><span class="p">,</span> <span class="n">align</span><span class="p">);</span><span class="cm">/* 分配空间 */</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">percpu</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s: Could not allocate %lu bytes percpu data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pcpusec</span><span class="o">-&gt;</span><span class="n">sh_size</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">percpu_size</span> <span class="o">=</span> <span class="n">pcpusec</span><span class="o">-&gt;</span><span class="n">sh_size</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
</li>
</ul>
<p>/* Now module is in final location, initialize linked lists, etc. <a href="#id17"><span class="problematic" id="id18">*</span></a>/</p>
<ul>
<li><p>module_unload_init:初始化模块的卸载节</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id85">
<div class="code-block-caption"><span class="caption-text">module_unload_init</span><a class="headerlink" href="#id85" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/* Init the unload section of the module. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">module_unload_init</span><span class="p">(</span><span class="k">struct</span> <span class="nc">module</span> <span class="o">*</span><span class="n">mod</span><span class="p">)</span>
<span class="p">{</span>
        <span class="cm">/*</span>
<span class="cm">         * Initialize reference counter to MODULE_REF_BASE.</span>
<span class="cm">         * refcnt == 0 means module is going.</span>
<span class="cm">         */</span>
        <span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">,</span> <span class="n">MODULE_REF_BASE</span><span class="p">);</span>

        <span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">source_list</span><span class="p">);</span><span class="cm">/* */</span>
        <span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">target_list</span><span class="p">);</span><span class="cm">/* */</span>

        <span class="cm">/* Hold reference count during initialization. */</span>
        <span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
</li>
<li><p>find_module_sectionsL在load_initmodule函数中调用，对节地址进行初始化。</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id86">
<div class="code-block-caption"><span class="caption-text">find_module_sections</span><a class="headerlink" href="#id86" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="n">find_module_sections</span><span class="p">(</span><span class="k">struct</span> <span class="nc">module</span> <span class="o">*</span><span class="n">mod</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">load_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">kp</span> <span class="o">=</span> <span class="n">section_objs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;__param&quot;</span><span class="p">,</span>
                               <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">kp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_kp</span><span class="p">);</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">syms</span> <span class="o">=</span> <span class="n">section_objs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;__ksymtab&quot;</span><span class="p">,</span>
                                 <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">syms</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_syms</span><span class="p">);</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">crcs</span> <span class="o">=</span> <span class="n">section_addr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;__kcrctab&quot;</span><span class="p">);</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">gpl_syms</span> <span class="o">=</span> <span class="n">section_objs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;__ksymtab_gpl&quot;</span><span class="p">,</span>
                                     <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">gpl_syms</span><span class="p">),</span><span class="cm">/* 导出符号表 */</span>
                                     <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_gpl_syms</span><span class="p">);</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">gpl_crcs</span> <span class="o">=</span> <span class="n">section_addr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;__kcrctab_gpl&quot;</span><span class="p">);</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">gpl_future_syms</span> <span class="o">=</span> <span class="n">section_objs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span>
                                            <span class="s">&quot;__ksymtab_gpl_future&quot;</span><span class="p">,</span>
                                            <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">gpl_future_syms</span><span class="p">),</span>
                                            <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_gpl_future_syms</span><span class="p">);</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">gpl_future_crcs</span> <span class="o">=</span> <span class="n">section_addr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;__kcrctab_gpl_future&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_UNUSED_SYMBOLS</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">unused_syms</span> <span class="o">=</span> <span class="n">section_objs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;__ksymtab_unused&quot;</span><span class="p">,</span>
                                        <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">unused_syms</span><span class="p">),</span>
                                        <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_unused_syms</span><span class="p">);</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">unused_crcs</span> <span class="o">=</span> <span class="n">section_addr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;__kcrctab_unused&quot;</span><span class="p">);</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">unused_gpl_syms</span> <span class="o">=</span> <span class="n">section_objs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;__ksymtab_unused_gpl&quot;</span><span class="p">,</span>
                                            <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">unused_gpl_syms</span><span class="p">),</span>
                                            <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_unused_gpl_syms</span><span class="p">);</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">unused_gpl_crcs</span> <span class="o">=</span> <span class="n">section_addr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;__kcrctab_unused_gpl&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_CONSTRUCTORS</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">ctors</span> <span class="o">=</span> <span class="n">section_objs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;.ctors&quot;</span><span class="p">,</span>
                                  <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">ctors</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_ctors</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">ctors</span><span class="p">)</span>
                <span class="n">mod</span><span class="o">-&gt;</span><span class="n">ctors</span> <span class="o">=</span> <span class="n">section_objs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;.init_array&quot;</span><span class="p">,</span>
                                <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">ctors</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_ctors</span><span class="p">);</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">find_sec</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;.init_array&quot;</span><span class="p">))</span> <span class="p">{</span>
                <span class="cm">/*</span>
<span class="cm">                 * This shouldn&#39;t happen with same compiler and binutils</span>
<span class="cm">                 * building all parts of the module.</span>
<span class="cm">                 */</span>
                <span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s: has both .ctors and .init_array.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                       <span class="n">mod</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
        <span class="p">}</span>
<span class="cp">#endif</span>

        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">noinstr_text_start</span> <span class="o">=</span> <span class="n">section_objs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;.noinstr.text&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                                <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">noinstr_text_size</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_TRACEPOINTS</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">tracepoints_ptrs</span> <span class="o">=</span> <span class="n">section_objs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;__tracepoints_ptrs&quot;</span><span class="p">,</span>
                                             <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">tracepoints_ptrs</span><span class="p">),</span>
                                             <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_tracepoints</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_TREE_SRCU</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">srcu_struct_ptrs</span> <span class="o">=</span> <span class="n">section_objs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;___srcu_struct_ptrs&quot;</span><span class="p">,</span>
                                             <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">srcu_struct_ptrs</span><span class="p">),</span>
                                             <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_srcu_structs</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BPF_EVENTS</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">bpf_raw_events</span> <span class="o">=</span> <span class="n">section_objs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;__bpf_raw_tp_map&quot;</span><span class="p">,</span>
                                           <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">bpf_raw_events</span><span class="p">),</span>
                                           <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_bpf_raw_events</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_JUMP_LABEL</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">jump_entries</span> <span class="o">=</span> <span class="n">section_objs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;__jump_table&quot;</span><span class="p">,</span>
                                        <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">jump_entries</span><span class="p">),</span>
                                        <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_jump_entries</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_EVENT_TRACING</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">trace_events</span> <span class="o">=</span> <span class="n">section_objs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;_ftrace_events&quot;</span><span class="p">,</span>
                                         <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">trace_events</span><span class="p">),</span>
                                         <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_trace_events</span><span class="p">);</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">trace_evals</span> <span class="o">=</span> <span class="n">section_objs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;_ftrace_eval_map&quot;</span><span class="p">,</span>
                                        <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">trace_evals</span><span class="p">),</span>
                                        <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_trace_evals</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_TRACING</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">trace_bprintk_fmt_start</span> <span class="o">=</span> <span class="n">section_objs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;__trace_printk_fmt&quot;</span><span class="p">,</span>
                                         <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">trace_bprintk_fmt_start</span><span class="p">),</span>
                                         <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_trace_bprintk_fmt</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_FTRACE_MCOUNT_RECORD</span>
        <span class="cm">/* sechdrs[0].sh_size is always zero */</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">ftrace_callsites</span> <span class="o">=</span> <span class="n">section_objs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">FTRACE_CALLSITE_SECTION</span><span class="p">,</span>
                                             <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">ftrace_callsites</span><span class="p">),</span>
                                             <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_ftrace_callsites</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_FUNCTION_ERROR_INJECTION</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">ei_funcs</span> <span class="o">=</span> <span class="n">section_objs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;_error_injection_whitelist&quot;</span><span class="p">,</span>
                                            <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">ei_funcs</span><span class="p">),</span>
                                            <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_ei_funcs</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_KPROBES</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">kprobes_text_start</span> <span class="o">=</span> <span class="n">section_objs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;.kprobes.text&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                                <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">kprobes_text_size</span><span class="p">);</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">kprobe_blacklist</span> <span class="o">=</span> <span class="n">section_objs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;_kprobe_blacklist&quot;</span><span class="p">,</span>
                                                <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">),</span>
                                                <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_kprobe_blacklist</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_HAVE_STATIC_CALL_INLINE</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">static_call_sites</span> <span class="o">=</span> <span class="n">section_objs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;.static_call_sites&quot;</span><span class="p">,</span>
                                              <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">static_call_sites</span><span class="p">),</span>
                                              <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_static_call_sites</span><span class="p">);</span>
<span class="cp">#endif</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">extable</span> <span class="o">=</span> <span class="n">section_objs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;__ex_table&quot;</span><span class="p">,</span>
                                    <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">extable</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_exentries</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">section_addr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;__obsparm&quot;</span><span class="p">))</span>
                <span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s: Ignoring obsolete parameters</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

        <span class="n">info</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">=</span> <span class="n">section_objs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;__dyndbg&quot;</span><span class="p">,</span>
                                   <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">num_debug</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
</li>
<li><p>check_module_license_and_versions:合法性检测</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id87">
<div class="code-block-caption"><span class="caption-text">check_module_license_and_versions</span><a class="headerlink" href="#id87" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="n">check_module_license_and_versions</span><span class="p">(</span><span class="k">struct</span> <span class="nc">module</span> <span class="o">*</span><span class="n">mod</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">prev_taint</span> <span class="o">=</span> <span class="n">test_taint</span><span class="p">(</span><span class="n">TAINT_PROPRIETARY_MODULE</span><span class="p">);</span>

        <span class="cm">/*</span>
<span class="cm">         * ndiswrapper is under GPL by itself, but loads proprietary modules.</span>
<span class="cm">         * Don&#39;t use add_taint_module(), as it would prevent ndiswrapper from</span>
<span class="cm">         * using GPL-only symbols it needs.</span>
<span class="cm">         */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ndiswrapper&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">add_taint</span><span class="p">(</span><span class="n">TAINT_PROPRIETARY_MODULE</span><span class="p">,</span> <span class="n">LOCKDEP_NOW_UNRELIABLE</span><span class="p">);</span>

        <span class="cm">/* driverloader was caught wrongly pretending to be under GPL */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;driverloader&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">add_taint_module</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">TAINT_PROPRIETARY_MODULE</span><span class="p">,</span>
                                 <span class="n">LOCKDEP_NOW_UNRELIABLE</span><span class="p">);</span>

        <span class="cm">/* lve claims to be GPL but upstream won&#39;t provide source */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;lve&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">add_taint_module</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">TAINT_PROPRIETARY_MODULE</span><span class="p">,</span>
                                 <span class="n">LOCKDEP_NOW_UNRELIABLE</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prev_taint</span> <span class="o">&amp;&amp;</span> <span class="n">test_taint</span><span class="p">(</span><span class="n">TAINT_PROPRIETARY_MODULE</span><span class="p">))</span>
                <span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s: module license taints kernel.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_MODVERSIONS</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_syms</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">crcs</span><span class="p">)</span>
            <span class="o">||</span> <span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_gpl_syms</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">gpl_crcs</span><span class="p">)</span>
            <span class="o">||</span> <span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_gpl_future_syms</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">gpl_future_crcs</span><span class="p">)</span>
<span class="cp">#ifdef CONFIG_UNUSED_SYMBOLS</span>
            <span class="o">||</span> <span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_unused_syms</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">unused_crcs</span><span class="p">)</span>
            <span class="o">||</span> <span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_unused_gpl_syms</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">unused_gpl_crcs</span><span class="p">)</span>
<span class="cp">#endif</span>
                <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nf">try_to_force_load</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span>
                                         <span class="s">&quot;no versions for exported symbols&quot;</span><span class="p">);</span>
        <span class="p">}</span>
<span class="cp">#endif</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
</li>
<li><p>setup_modinfo:模块加载属性修改事件,下面章节进行分析 <a href="#id19"><span class="problematic" id="id20">*</span></a>/</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id88">
<div class="code-block-caption"><span class="caption-text">setup_modinfo</span><a class="headerlink" href="#id88" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">void</span> <span class="n">setup_modinfo</span><span class="p">(</span><span class="k">struct</span> <span class="nc">module</span> <span class="o">*</span><span class="n">mod</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">load_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="nc">module_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">attr</span> <span class="o">=</span> <span class="n">modinfo_attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">)</span>
                        <span class="n">attr</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">get_modinfo</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
</li>
</ul>
<p>/* Fix up syms, so that st_value is a pointer to location. <a href="#id21"><span class="problematic" id="id22">*</span></a>/</p>
<ul class="simple">
<li><p>simplify_symbols</p></li>
</ul>
<p>更改所有符号，以便 st_value 直接对指针进行编码，后续进行详细描述，解析符号。解析未定义函数（内核函数列表和其他模块导出函数列表</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id89">
<div class="code-block-caption"><span class="caption-text">simplify_symbols</span><a class="headerlink" href="#id89" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179</pre></div></td><td class="code"><div class="highlight"><pre><span></span>struct kernel_symbol {
        int value_offset;
        int name_offset;
        int namespace_offset;
};

/* Change all symbols so that st_value encodes the pointer directly. */
static int simplify_symbols(struct module *mod, const struct load_info *info)
{
        Elf_Shdr *symsec = &amp;info-&gt;sechdrs[info-&gt;index.sym];/* 符号节头地址 */
        Elf_Sym *sym = (void *)symsec-&gt;sh_addr;/* 符号表地址 */
        unsigned long secbase;
        unsigned int i;
        int ret = 0;
        const struct kernel_symbol *ksym;

        for (i = 1; i &lt; symsec-&gt;sh_size / sizeof(Elf_Sym); i++) {/* 遍历所有符号 */
                const char *name = info-&gt;strtab + sym[i].st_name;/* 从字符串表中获取字符名称 */

                switch (sym[i].st_shndx) {
                case SHN_COMMON:/* 通用符号 */
                        /* Ignore common symbols */
                        if (!strncmp(name, &quot;__gnu_lto&quot;, 9))
                                break;

                        /* We compiled with -fno-common.  These are not
                           supposed to happen.  */
                        pr_debug(&quot;Common symbol: %s\n&quot;, name);
                        pr_warn(&quot;%s: please compile with -fno-common\n&quot;,
                               mod-&gt;name);
                        ret = -ENOEXEC;
                        break;

                case SHN_ABS:/* 绝对值 */
                        /* Don&#39;t need to do anything */
                        pr_debug(&quot;Absolute symbol: 0x%08lx\n&quot;,
                               (long)sym[i].st_value);
                        break;

                case SHN_LIVEPATCH:/* 由实时补丁自己解析 */
                        /* Livepatch symbols are resolved by livepatch */
                        break;

                case SHN_UNDEF:/* 未定义符号，需要解析的符号 */
                        ksym = resolve_symbol_wait(mod, info, name);
                        /*
                                struct find_symbol_arg {
                                        /* Input */
                                        const char *name;
                                        bool gplok;
                                        bool warn;

                                        /* Output */
                                        struct module *owner;
                                        const s32 *crc;
                                        const struct kernel_symbol *sym;
                                        enum mod_license license;
                                };
                                struct symsearch {
                                        const struct kernel_symbol *start, *stop;
                                        const s32 *crcs;
                                        enum mod_license {
                                                NOT_GPL_ONLY,
                                                GPL_ONLY,
                                        } license;
                                };

                                static bool find_exported_symbol_in_section(const struct symsearch *syms,
                                                                            struct module *owner,
                                                                            void *data)
                                {
                                        struct find_symbol_arg *fsa = data;
                                        struct kernel_symbol *sym;

                                        sym = bsearch(fsa-&gt;name, syms-&gt;start, syms-&gt;stop - syms-&gt;start,
                                                        sizeof(struct kernel_symbol), cmp_name);

                                        if (sym != NULL &amp;&amp; check_exported_symbol(syms, owner,
                                                                                 sym - syms-&gt;start, data))
                                                return true;

                                        return false;
                                }

                                /*
                                 * Find an exported symbol and return it, along with, (optional) crc and
                                 * (optional) module which owns it.  Needs preempt disabled or module_mutex.
                                 */
                                static bool find_symbol(struct find_symbol_arg *fsa)
                                {
                                        static const struct symsearch arr[] = {
                                                { __start___ksymtab, __stop___ksymtab, __start___kcrctab,
                                                  NOT_GPL_ONLY },
                                                { __start___ksymtab_gpl, __stop___ksymtab_gpl,
                                                  __start___kcrctab_gpl,
                                                  GPL_ONLY },
                                        };
                                        struct module *mod;
                                        unsigned int i;

                                        module_assert_mutex_or_preempt();

                                        for (i = 0; i &lt; ARRAY_SIZE(arr); i++)
                                                if (find_exported_symbol_in_section(&amp;arr[i], NULL, fsa))/* 必须为导出符号 */
                                                        return true;

                                        list_for_each_entry_rcu(mod, &amp;modules, list,
                                                                lockdep_is_held(&amp;module_mutex)) {
                                                struct symsearch arr[] = {/* 遍历模块，从模块导出符号中查询 */
                                                        { mod-&gt;syms, mod-&gt;syms + mod-&gt;num_syms, mod-&gt;crcs,
                                                          NOT_GPL_ONLY },
                                                        { mod-&gt;gpl_syms, mod-&gt;gpl_syms + mod-&gt;num_gpl_syms,
                                                          mod-&gt;gpl_crcs,
                                                          GPL_ONLY },
                                                };

                                                if (mod-&gt;state == MODULE_STATE_UNFORMED)
                                                        continue;

                                                for (i = 0; i &lt; ARRAY_SIZE(arr); i++)
                                                        if (find_exported_symbol_in_section(&amp;arr[i], mod, fsa))/*一样的疑问？ */
                                                                return true;
                                        }

                                        pr_debug(&quot;Failed to find symbol %s\n&quot;, fsa-&gt;name);
                                        return false;
                                }


                                struct kernel_symbol *resolve_symbol(struct module *mod,
                                        const struct load_info info,const char *name,char ownername[]);
                                {
                                        find_symbol(&amp;fsa);/* 实际的查询符号 */

                                        fsa.license == GPL_ONLY;/* 判断符号是不是是GPL许可 */

                                        inherit_taint(mod,fsa.owner);/* 判断： ？ */

                                        check_version(info,name,mod,fsa.crc);/* 判断crc */

                                        verify_namespace_is_imported(info,fsa.sym,mod);/* */

                                        ref_module(mod,fsa.owner);/* 增加引用？ */

                                        return sym;

                                }

                        */

                        /* Ok if resolved.  */
                        if (ksym &amp;&amp; !IS_ERR(ksym)) {/* 正确解析 */
                                sym[i].st_value = kernel_symbol_value(ksym);/* 解析调用内核函数地址：
                                                                                = sym-&gt;value */
                                break;
                        }

                        /* Ok if weak.  */
                        if (!ksym &amp;&amp; ELF_ST_BIND(sym[i].st_info) == STB_WEAK)
                                break;

                        ret = PTR_ERR(ksym) ?: -ENOENT;
                        pr_warn(&quot;%s: Unknown symbol %s (err %d)\n&quot;,
                                mod-&gt;name, name, ret);
                        break;

                default:
                        /* Divert to percpu allocation if a percpu var. */
                        if (sym[i].st_shndx == info-&gt;index.pcpu)
                                secbase = (unsigned long)mod_percpu(mod);
                        else
                                secbase = info-&gt;sechdrs[sym[i].st_shndx].sh_addr;
                        sym[i].st_value += secbase;
                        break;
                }
        }

        return ret;
}
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>apply_relocations</p></li>
</ul>
<p>重定向节，后续需要进一步说明 ，需要进一步说明。重点</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id90">
<div class="code-block-caption"><span class="caption-text">apply_relocations</span><a class="headerlink" href="#id90" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="n">apply_relocations</span><span class="p">(</span><span class="k">struct</span> <span class="nc">module</span> <span class="o">*</span><span class="n">mod</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="nc">load_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="cm">/* Now do relocations. */</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">e_shnum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">infosec</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_info</span><span class="p">;</span>

                <span class="cm">/* Not a valid relocation section? */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">infosec</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">e_shnum</span><span class="p">)</span>
                        <span class="k">continue</span><span class="p">;</span>

                <span class="cm">/* Don&#39;t bother with non-allocated sections */</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">[</span><span class="n">infosec</span><span class="p">].</span><span class="n">sh_flags</span> <span class="o">&amp;</span> <span class="n">SHF_ALLOC</span><span class="p">))</span><span class="cm">/* 略过非加载节 */</span>
                        <span class="k">continue</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_flags</span> <span class="o">&amp;</span> <span class="n">SHF_RELA_LIVEPATCH</span><span class="p">)</span> <span class="cm">/* 重定向实时补丁节 */</span>
                        <span class="n">err</span> <span class="o">=</span> <span class="n">klp_apply_section_relocs</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">,</span>
                                                       <span class="n">info</span><span class="o">-&gt;</span><span class="n">secstrings</span><span class="p">,</span>
                                                       <span class="n">info</span><span class="o">-&gt;</span><span class="n">strtab</span><span class="p">,</span>
                                                       <span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">.</span><span class="n">sym</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
                                                       <span class="nb">NULL</span><span class="p">);</span>
                <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_type</span> <span class="o">==</span> <span class="n">SHT_REL</span><span class="p">)</span>
                        <span class="n">err</span> <span class="o">=</span> <span class="n">apply_relocate</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">strtab</span><span class="p">,</span>
                                             <span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">.</span><span class="n">sym</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">mod</span><span class="p">);</span>
                <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sh_type</span> <span class="o">==</span> <span class="n">SHT_RELA</span><span class="p">)</span>
                        <span class="n">err</span> <span class="o">=</span> <span class="n">apply_relocate_add</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">strtab</span><span class="p">,</span>
                                                 <span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">.</span><span class="n">sym</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">mod</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
<p>post_relocation</p>
<p>重点描述</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id91">
<div class="code-block-caption"><span class="caption-text">post_relocation</span><a class="headerlink" href="#id91" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="n">post_relocation</span><span class="p">(</span><span class="k">struct</span> <span class="nc">module</span> <span class="o">*</span><span class="n">mod</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="nc">load_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
        <span class="cm">/* Sort exception table now relocations are done. */</span>
        <span class="n">sort_extable</span><span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">extable</span><span class="p">,</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">extable</span> <span class="o">+</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_exentries</span><span class="p">);</span>

        <span class="cm">/* Copy relocated percpu area over. */</span>
        <span class="n">percpu_modcopy</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">.</span><span class="n">pcpu</span><span class="p">].</span><span class="n">sh_addr</span><span class="p">,</span>
                       <span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">.</span><span class="n">pcpu</span><span class="p">].</span><span class="n">sh_size</span><span class="p">);</span>

        <span class="cm">/* Setup kallsyms-specific fields. */</span>
        <span class="n">add_kallsyms</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

        <span class="cm">/* Arch-specific module finalizing. */</span>
        <span class="k">return</span> <span class="nf">module_finalize</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">,</span> <span class="n">mod</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
<p>dynamic_debug_setup</p>
<p>ddebug_table: 调试部分专门描述</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id92">
<div class="code-block-caption"><span class="caption-text">dynamic_debug_setup</span><a class="headerlink" href="#id92" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">void</span> <span class="n">dynamic_debug_setup</span><span class="p">(</span><span class="k">struct</span> <span class="nc">module</span> <span class="o">*</span><span class="n">mod</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">_ddebug</span> <span class="o">*</span><span class="n">debug</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">debug</span><span class="p">)</span>
                <span class="k">return</span><span class="p">;</span>
        <span class="n">ddebug_add_module</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
<p>/* Finally it’s fully formed, ready to start executing. <a href="#id23"><span class="problematic" id="id24">*</span></a>/</p>
<p>###### complete_formation</p>
<blockquote>
<div><p>–&gt;MODULE_STATE_COMING：模块状态设置，后续需要描述</p>
</div></blockquote>
<p>对内存状态进行设置。</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id93">
<div class="code-block-caption"><span class="caption-text">complete_formation</span><a class="headerlink" href="#id93" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="n">complete_formation</span><span class="p">(</span><span class="k">struct</span> <span class="nc">module</span> <span class="o">*</span><span class="n">mod</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">load_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

        <span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module_mutex</span><span class="p">);</span>

        <span class="cm">/* Find duplicate symbols (must be called under lock). */</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">verify_exported_symbols</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

        <span class="cm">/* This relies on module_mutex for list integrity. */</span>
        <span class="n">module_bug_finalize</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sechdrs</span><span class="p">,</span> <span class="n">mod</span><span class="p">);</span>

        <span class="n">module_enable_ro</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
        <span class="n">module_enable_nx</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span>
        <span class="n">module_enable_x</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span>

        <span class="cm">/* Mark state as coming so strong_try_module_get() ignores us,</span>
<span class="cm">         * but kallsyms etc. can see us. */</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MODULE_STATE_COMING</span><span class="p">;</span>
        <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module_mutex</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out</span><span class="p">:</span>
        <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module_mutex</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
<p>prepare_coming_module</p>
<p>跟踪,若live patch则修改状态,通知所有关心模块加载的部件:MODULE_STATE_COMING, 后续需要详细描述</p>
<p>注意，此处状态和实时补丁相关信息。</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id94">
<div class="code-block-caption"><span class="caption-text">prepare_coming_module</span><a class="headerlink" href="#id94" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="n">prepare_coming_module</span><span class="p">(</span><span class="k">struct</span> <span class="nc">module</span> <span class="o">*</span><span class="n">mod</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

        <span class="n">ftrace_module_enable</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">klp_module_coming</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">err</span><span class="p">;</span>

        <span class="n">err</span> <span class="o">=</span> <span class="n">blocking_notifier_call_chain_robust</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module_notify_list</span><span class="p">,</span>
                        <span class="n">MODULE_STATE_COMING</span><span class="p">,</span> <span class="n">MODULE_STATE_GOING</span><span class="p">,</span> <span class="n">mod</span><span class="p">);</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">notifier_to_errno</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="n">klp_module_going</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
<p>/* Link in to sysfs. <a href="#id25"><span class="problematic" id="id26">*</span></a>/</p>
<p>mod_sysfs_setup</p>
<p><em>; /</em> sysfs节点信息导出：包括节信息，后续详细描述 <a href="#id27"><span class="problematic" id="id28">*</span></a>/</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id95">
<div class="code-block-caption"><span class="caption-text">mod_sysfs_setup</span><a class="headerlink" href="#id95" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="n">mod_sysfs_setup</span><span class="p">(</span><span class="k">struct</span> <span class="nc">module</span> <span class="o">*</span><span class="n">mod</span><span class="p">,</span>
                           <span class="k">const</span> <span class="k">struct</span> <span class="nc">load_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
                           <span class="k">struct</span> <span class="nc">kernel_param</span> <span class="o">*</span><span class="n">kparam</span><span class="p">,</span>
                           <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_params</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

        <span class="n">err</span> <span class="o">=</span> <span class="n">mod_sysfs_init</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">holders_dir</span> <span class="o">=</span> <span class="n">kobject_create_and_add</span><span class="p">(</span><span class="s">&quot;holders&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">mkobj</span><span class="p">.</span><span class="n">kobj</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">holders_dir</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
                <span class="k">goto</span> <span class="n">out_unreg</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">err</span> <span class="o">=</span> <span class="n">module_param_sysfs_setup</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">kparam</span><span class="p">,</span> <span class="n">num_params</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">out_unreg_holders</span><span class="p">;</span>

        <span class="n">err</span> <span class="o">=</span> <span class="n">module_add_modinfo_attrs</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">out_unreg_param</span><span class="p">;</span>

        <span class="n">err</span> <span class="o">=</span> <span class="n">add_usage_links</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">out_unreg_modinfo_attrs</span><span class="p">;</span>

        <span class="n">add_sect_attrs</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
        <span class="n">add_notes_attrs</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_unreg_modinfo_attrs</span><span class="p">:</span>
        <span class="n">module_remove_modinfo_attrs</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="mi">-1</span><span class="p">);</span>
<span class="nl">out_unreg_param</span><span class="p">:</span>
        <span class="n">module_param_sysfs_remove</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span>
<span class="nl">out_unreg_holders</span><span class="p">:</span>
        <span class="n">kobject_put</span><span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">holders_dir</span><span class="p">);</span>
<span class="nl">out_unreg</span><span class="p">:</span>
        <span class="n">mod_kobject_put</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span>
<span class="nl">out</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
<p>if (is_livepatch_module(mod)) {:err = copy_module_elf(mod, info); /* 填充mod–&gt;klp_info:模块信息,ELF头,节头表,节字符串表,符号节索引等:后续详细说明*/</p>
<blockquote>
<div><blockquote>
<div><div class="literal-block-wrapper docutils container" id="id96">
<div class="code-block-caption"><span class="caption-text">is_livepatch_module</span><a class="headerlink" href="#id96" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#ifdef CONFIG_LIVEPATCH</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">bool</span> <span class="n">is_livepatch_module</span><span class="p">(</span><span class="k">struct</span> <span class="nc">module</span> <span class="o">*</span><span class="n">mod</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">klp</span><span class="p">;</span><span class="cm">/* 判断是否是实时补丁 */</span>
<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* !CONFIG_LIVEPATCH */</span><span class="cp"></span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
<p>do_one_initcall</p>
</div></blockquote>
<p><em>/</em> 必须有，执行初始化函数 <a href="#id29"><span class="problematic" id="id30">*</span></a>/</p>
<blockquote>
<div><blockquote>
<div><div class="literal-block-wrapper docutils container" id="id97">
<div class="code-block-caption"><span class="caption-text">do_one_initcall</span><a class="headerlink" href="#id97" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">__init_or_module</span> <span class="n">do_one_initcall</span><span class="p">(</span><span class="n">initcall_t</span> <span class="n">fn</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">preempt_count</span><span class="p">();</span>
        <span class="kt">char</span> <span class="n">msgbuf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
        <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">initcall_blacklisted</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

        <span class="n">do_trace_initcall_start</span><span class="p">(</span><span class="n">fn</span><span class="p">);</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">fn</span><span class="p">();</span>
        <span class="n">do_trace_initcall_finish</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

        <span class="n">msgbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">preempt_count</span><span class="p">()</span> <span class="o">!=</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">sprintf</span><span class="p">(</span><span class="n">msgbuf</span><span class="p">,</span> <span class="s">&quot;preemption imbalance &quot;</span><span class="p">);</span>
                <span class="n">preempt_count_set</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">irqs_disabled</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">strlcat</span><span class="p">(</span><span class="n">msgbuf</span><span class="p">,</span> <span class="s">&quot;disabled interrupts &quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msgbuf</span><span class="p">));</span>
                <span class="n">local_irq_enable</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="n">WARN</span><span class="p">(</span><span class="n">msgbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;initcall %pS returned with %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">msgbuf</span><span class="p">);</span>

        <span class="n">add_latent_entropy</span><span class="p">();</span>
        <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
<p>kobject_uevent</p>
<p>/* 事件通知：KOBJ_ADD*/</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id98">
<div class="code-block-caption"><span class="caption-text">check_module_license_and_versions</span><a class="headerlink" href="#id98" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * kobject_uevent - notify userspace by sending an uevent</span>
<span class="cm"> *</span>
<span class="cm"> * @kobj: struct kobject that the action is happening to</span>
<span class="cm"> * @action: action that is happening</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if kobject_uevent() is completed with success or the</span>
<span class="cm"> * corresponding error when it fails.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">kobject_uevent</span><span class="p">(</span><span class="k">struct</span> <span class="nc">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span> <span class="k">enum</span> <span class="n">kobject_action</span> <span class="n">action</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">return</span> <span class="n">kobject_uevent_env</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">kobject_uevent</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
</div></blockquote>
<ul class="simple">
<li><p>trim_init_extable</p></li>
</ul>
<p>/* 后续详细描述*/</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id99">
<div class="code-block-caption"><span class="caption-text">trim_init_extable</span><a class="headerlink" href="#id99" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#ifdef CONFIG_MODULES</span>
<span class="cm">/*</span>
<span class="cm"> * If the exception table is sorted, any referring to the module init</span>
<span class="cm"> * will be at the beginning or the end.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">trim_init_extable</span><span class="p">(</span><span class="k">struct</span> <span class="nc">module</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
        <span class="cm">/*trim the beginning*/</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">num_exentries</span> <span class="o">&amp;&amp;</span>
               <span class="n">within_module_init</span><span class="p">(</span><span class="n">ex_to_insn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">extable</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">m</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">m</span><span class="o">-&gt;</span><span class="n">extable</span><span class="o">++</span><span class="p">;</span>
                <span class="n">m</span><span class="o">-&gt;</span><span class="n">num_exentries</span><span class="o">--</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="cm">/*trim the end*/</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">num_exentries</span> <span class="o">&amp;&amp;</span>
               <span class="n">within_module_init</span><span class="p">(</span><span class="n">ex_to_insn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">extable</span><span class="p">[</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">num_exentries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]),</span>
                                  <span class="n">m</span><span class="p">))</span>
                <span class="n">m</span><span class="o">-&gt;</span><span class="n">num_exentries</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MODULES */</span><span class="cp"></span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
<ul>
<li><p>重要数据结构描述：</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id100">
<div class="code-block-caption"><span class="caption-text">布局数据结构</span><a class="headerlink" href="#id100" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50</pre></div></td><td class="code"><div class="highlight"><pre><span></span>struct load_info {
        const char *name;
        /* pointer to module in temporary copy, freed at end of load_module() */
        struct module *mod;
        Elf_Ehdr *hdr; //文件头
        unsigned long len;
        Elf_Shdr *sechdrs;//文件节
        char *secstrings, *strtab;
        unsigned long symoffs, stroffs, init_typeoffs, core_typeoffs;
        struct _ddebug *debug;
        unsigned int num_debug;
        bool sig_ok;

#ifdef CONFIG_KALLSYMS

​       unsigned long mod_kallsyms_init_off;

#endif

​       struct {
​               unsigned int sym, str, mod, vers, info, pcpu;
​       } index;
};
​
enum module_state {
​       MODULE_STATE_LIVE,      /* Normal state. */
​       MODULE_STATE_COMING,    /* Full formed, running module_init. */
​       MODULE_STATE_GOING,     /* Going away. */
​       MODULE_STATE_UNFORMED,  /* Still setting it up. */
};

struct module_layout {
        /* The actual code + data. */
        void *base;
        /* Total size. */
        unsigned int size;
        /* The size of the executable code.  */
        unsigned int text_size;
        /* Size of RO section of the module (text+rodata) */
        unsigned int ro_size;
        /* Size of RO after init section */
        unsigned int ro_after_init_size;

#ifdef CONFIG_MODULES_TREE_LOOKUP

​       struct mod_tree_node mtn;

#endif

};
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
</li>
</ul>
<p>注意，重点结构struct module，重点理解内存布局部分。内核中链表方式进行管理。其</p>
</div>
</div>
<div class="section" id="rmmod">
<h2>rmmod 卸载过程分析<a class="headerlink" href="#rmmod" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id101">
<div class="code-block-caption"><span class="caption-text">卸载模块跟踪信息</span><a class="headerlink" href="#id101" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></div></td><td class="code"><div class="highlight"><pre><span></span># strace -o ./test rmmod k_m
# cat test

execve(&quot;/usr/sbin/rmmod&quot;, [&quot;rmmod&quot;, &quot;k_m&quot;], 0x7ffeeddac048 /* 23 vars */) = 0
openat(AT_FDCWD, &quot;/lib/modules/5.10.13/modules.softdep&quot;, O_RDONLY|O_CLOEXEC) = 3
fcntl(3, F_GETFL)                       = 0x8000 (flags O_RDONLY|O_LARGEFILE)
fstat(3, {st_mode=S_IFREG|0644, st_size=1039, ...}) = 0
read(3, &quot;# Soft dependencies extracted fr&quot;..., 4096) = 1039
read(3, &quot;&quot;, 4096)                       = 0
close(3)                                = 0
openat(AT_FDCWD, &quot;/proc/cmdline&quot;, O_RDONLY|O_CLOEXEC) = 3
read(3, &quot;BOOT_IMAGE=/boot/vmlinuz-5.10.13&quot;..., 4095) = 102
read(3, &quot;&quot;, 3993)                       = 0
close(3)                                = 0
stat(&quot;k_m&quot;, 0x7ffdadb26250)             = -1 ENOENT (没有那个文件或目录)
openat(AT_FDCWD, &quot;/lib/modules/5.10.13/modules.builtin.bin&quot;, O_RDONLY|O_CLOEXEC) = 3
fstat(3, {st_mode=S_IFREG|0644, st_size=6660, ...}) = 0
read(3, &quot;\260\7\364W\0\2\0\1 \0\30\366ase\0\0\0\0\1\0\0\0\0\0w\0\0\0\0\1\0&quot;..., 4096) = 4096
lseek(3, 4096, SEEK_SET)                = 4096
read(3, &quot;\0\0d_registry\0\0\0\0\1\0\0\0\0\0fi\300\0\17\354\0\0\0\0&quot;..., 4096) = 2564
lseek(3, 0, SEEK_SET)                   = 0
read(3, &quot;\260\7\364W\0\2\0\1 \0\30\366ase\0\0\0\0\1\0\0\0\0\0w\0\0\0\0\1\0&quot;..., 4096) = 4096
close(3)                                = 0
openat(AT_FDCWD, &quot;/sys/module/k_m/initstate&quot;, O_RDONLY|O_CLOEXEC) = 3
read(3, &quot;live\n&quot;, 31)                   = 5
read(3, &quot;&quot;, 26)                         = 0
close(3)                                = 0
openat(AT_FDCWD, &quot;/sys/module/k_m/holders&quot;, O_RDONLY|O_NONBLOCK|O_CLOEXEC|O_DIRECTORY) = 3
fstat(3, {st_mode=S_IFDIR|0755, st_size=0, ...}) = 0
getdents64(3, 0x563bbf1a2450 /* 2 entries */, 32768) = 48
getdents64(3, 0x563bbf1a2450 /* 0 entries */, 32768) = 0
close(3)                                = 0
openat(AT_FDCWD, &quot;/sys/module/k_m/refcnt&quot;, O_RDONLY|O_CLOEXEC) = 3
read(3, &quot;0\n&quot;, 31)                      = 2
read(3, &quot;&quot;, 29)                         = 0
close(3)                                = 0
delete_module(&quot;k_m&quot;, O_NONBLOCK)        = 0
exit_group(0)                           = ?
+++ exited with 0 +++
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
<ul>
<li><p>delete_module系统调用</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id102">
<div class="code-block-caption"><span class="caption-text">delete_module系统调用</span><a class="headerlink" href="#id102" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">SYSCALL_DEFINE2</span><span class="p">(</span><span class="n">delete_module</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">name_user</span><span class="p">,</span>
                <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="nc">module</span> <span class="o">*</span><span class="n">mod</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">MODULE_NAME_LEN</span><span class="p">];</span>
        <span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">forced</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_MODULE</span><span class="p">)</span> <span class="o">||</span> <span class="n">modules_disabled</span><span class="p">)</span> <span class="cm">/*进程权限检查,并确定内核支持外部模块*/</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">strncpy_from_user</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name_user</span><span class="p">,</span> <span class="n">MODULE_NAME_LEN</span><span class="mi">-1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
        <span class="n">name</span><span class="p">[</span><span class="n">MODULE_NAME_LEN</span><span class="mi">-1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

        <span class="n">audit_log_kern_module</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="cm">/*审计hook*/</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module_mutex</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

        <span class="n">mod</span> <span class="o">=</span> <span class="n">find_module</span><span class="p">(</span><span class="n">name</span><span class="p">);</span> <span class="cm">/*查找模块*/</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mod</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
                <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">source_list</span><span class="p">))</span> <span class="p">{</span><span class="cm">/* 模块是否被依赖 */</span>
                <span class="cm">/* Other modules depend on us: get rid of them first. */</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EWOULDBLOCK</span><span class="p">;</span>
                <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/* Doing init or already dying? */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">MODULE_STATE_LIVE</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* 确定模块是否处于活跃状态*/</span>
                <span class="cm">/* FIXME: if (force), slam module count damn the torpedoes */</span>
                <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s already dying</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
                <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/* If it has an init func, it must have an exit func to unload */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">init</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">forced</span> <span class="o">=</span> <span class="n">try_force_unload</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">forced</span><span class="p">)</span> <span class="p">{</span>
                        <span class="cm">/* This module can&#39;t be removed */</span>
                        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
                        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>

        <span class="cm">/* Stop the machine so refcounts can&#39;t move and disable module. */</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">try_stop_module</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">forced</span><span class="p">);</span><span class="cm">/* state = MODULE_STATE_GOING */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

        <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module_mutex</span><span class="p">);</span>
        <span class="cm">/* Final destruction now no one is using it. */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">exit</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
                <span class="n">mod</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">();</span><span class="cm">/* 执行模块的退出函数,在模块代码中定义 */</span>
        <span class="n">blocking_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module_notify_list</span><span class="p">,</span><span class="cm">/* 通知关心模块卸载的相关单元*/</span>
                                     <span class="n">MODULE_STATE_GOING</span><span class="p">,</span> <span class="n">mod</span><span class="p">);</span>
        <span class="n">klp_module_going</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span> <span class="cm">/*卸载补丁: klp_cleanup_module_patches_limited(...)*/</span>
        <span class="n">ftrace_release_mod</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span> <span class="cm">/* ftrace hook*/</span>

        <span class="n">async_synchronize_full</span><span class="p">();</span> <span class="cm">/* 一个等待时间，需要关注kernel/async.c*/</span>

        <span class="cm">/* Store the name of the last unloaded module for diagnostic purposes */</span>
        <span class="n">strlcpy</span><span class="p">(</span><span class="n">last_unloaded_module</span><span class="p">,</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">last_unloaded_module</span><span class="p">));</span>

        <span class="n">free_module</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span><span class="cm">/* 卸载模块结构 */</span>
        <span class="cm">/* someone could wait for the module in add_unformed_module() */</span>
        <span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module_wq</span><span class="p">);</span> <span class="cm">/* 唤醒等待进程，如某个加载模块的进程*/</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
</li>
<li><p>free_module函数分析</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id103">
<div class="code-block-caption"><span class="caption-text">free_module</span><a class="headerlink" href="#id103" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/* Free a module, remove from lists, etc. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">free_module</span><span class="p">(</span><span class="k">struct</span> <span class="nc">module</span> <span class="o">*</span><span class="n">mod</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">trace_module_free</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span>

        <span class="n">mod_sysfs_teardown</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span><span class="cm">/* 卸载虚拟文件系统中相关信息 */</span>

        <span class="cm">/* We leave it in list to prevent duplicate loads, but make sure</span>
<span class="cm">         * that noone uses it while it&#39;s being deconstructed. */</span>
        <span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module_mutex</span><span class="p">);</span>
        <span class="n">mod</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">MODULE_STATE_UNFORMED</span><span class="p">;</span>
        <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module_mutex</span><span class="p">);</span>

        <span class="cm">/* Remove dynamic debug info */</span>
        <span class="n">ddebug_remove_module</span><span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

        <span class="cm">/* Arch-specific cleanup. */</span>
        <span class="n">module_arch_cleanup</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span>

        <span class="cm">/* Module unload stuff */</span>
        <span class="n">module_unload_free</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span>

        <span class="cm">/* Free any allocated parameters. */</span>
        <span class="n">destroy_params</span><span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">kp</span><span class="p">,</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">num_kp</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">is_livepatch_module</span><span class="p">(</span><span class="n">mod</span><span class="p">))</span>
                <span class="n">free_module_elf</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span>

        <span class="cm">/* Now we can delete it from the lists */</span>
        <span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module_mutex</span><span class="p">);</span>
        <span class="cm">/* Unlink carefully: kallsyms could be walking list. */</span>
        <span class="n">list_del_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
        <span class="n">mod_tree_remove</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span>
        <span class="cm">/* Remove this module from bug list, this uses list_del_rcu */</span>
        <span class="n">module_bug_cleanup</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span>
        <span class="cm">/* Wait for RCU-sched synchronizing before releasing mod-&gt;list and buglist. */</span>
        <span class="n">synchronize_rcu</span><span class="p">();</span>
        <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module_mutex</span><span class="p">);</span>

        <span class="cm">/* This may be empty, but that&#39;s OK */</span>
        <span class="n">module_arch_freeing_init</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span>
        <span class="n">module_memfree</span><span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">init_layout</span><span class="p">.</span><span class="n">base</span><span class="p">);</span> <span class="cm">/* 释放内存:kfree() */</span>
        <span class="n">kfree</span><span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">);</span>
        <span class="n">percpu_modfree</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span>

        <span class="cm">/* Free lock-classes; relies on the preceding sync_rcu(). */</span>
        <span class="n">lockdep_free_key_range</span><span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">core_layout</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="n">mod</span><span class="o">-&gt;</span><span class="n">core_layout</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>

        <span class="cm">/* Finally, free the core (containing the module structure) */</span>
        <span class="n">module_memfree</span><span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">core_layout</span><span class="p">.</span><span class="n">base</span><span class="p">);</span> <span class="cm">/*  释放内存:kfree() */</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
</li>
<li><p>总结：借助加载部分的注解，这部分理解起来就没有难度了。</p></li>
</ul>
</div>
<div class="section" id="id31">
<h2>总结<a class="headerlink" href="#id31" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>内核模块编译过程分析；</p></li>
<li><p>内核模块符号引用部分分析；</p></li>
<li><p>重点分析内核模块加载部分；</p></li>
<li><p>基于v5.14版本内核进行分析。</p></li>
</ul>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="base_arch.html" class="btn btn-neutral float-left" title="linux 内核代码目录结构" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="notifier.html" class="btn btn-neutral float-right" title="linux 内核通知/通信机制" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Rachel.Sun.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>